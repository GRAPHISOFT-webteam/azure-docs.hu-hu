<properties 
    pageTitle="將應用程式與 Azure 虛擬網路整合" 
    description="示範如何將 Azure App Service 中的應用程式連接到新的或現有的 Azure 虛擬網路" 
    services="app-service" 
    documentationCenter="" 
    authors="ccompy" 
    manager="wpickett" 
    editor="cephalin"/>

<tags 
    ms.service="app-service" 
    ms.workload="na" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="11/18/2015" 
    ms.author="ccompy"/>

# 將您的應用程式與 Azure 虛擬網路整合 #

本文件說明 Azure 應用程式服務的虛擬網路整合功能，以及示範如何使用應用程式中進行設定 [Azure App Service](http://go.microsoft.com/fwlink/?LinkId=529714)。  如果您不熟悉 Azure 虛擬網路 (VNET)，這是一種功能，可讓您在非網際網路可路由網路中放置許多您可控制其存取的 Azure 資源。  然後，可以使用各種 VPN 技術，將這些網路連接到您的內部部署網路。  若要了解有關 Azure 虛擬網路的詳細資訊開始的資訊: [虛擬網路] [VNETOverview]。  

Azure App Service 具有兩種形式。  第一種和最常見的形式為支援全系列價格方案的多租用戶系統。  第二種為部署到客戶 VNET 的 App Service 環境 (ASE) 進階功能。  搭配 App Service 環境，您通常不需要使用 VNET 整合，因為系統已在您的 VNET 中，而且有權存取該 VNET 中的所有資源。  您仍會搭配 ASE 使用 VNET 整合功能的其中一個原因，就是如果您想要存取另一個 VNET 中的資源，而此 VNET 未連接到裝載 ASE 的 VNET。  

VNET 整合能讓您的 Web 應用程式存取虛擬網路中的資源，但不授與從虛擬網路存取 Web 應用程式的專用權限。  您將使用此功能的常見案例，就是讓 Web 應用程式能夠存取資料庫，或在 Azure 虛擬網路的虛擬機器中執行的 Web 服務。  使用 VNET 整合時，您不需要公開 VM 上應用程式的公用端點，但可以改用專用的非網際網路可路由位址。  

VNET 整合功能：

- 需要標準或進階價格方案 
- 目前只會使用 V1 或傳統 VNET 
- 支援 TCP 和 UDP
- 使用 Web、行動及 API 應用程式
- 可讓應用程式一次只連接到 1 個 VNET
- 可在 App Service 方案中與最多 5 個 VNET 整合 
- 可讓 App Service 方案中的多個應用程式使用相同的 VNET
- 由於依賴 VNET 閘道器，支援 99.9 % SLA

有一些 VNET 整合不支援的事項：

- 掛接磁碟機
- AD 整合 
- NetBios
- 私人網站存取

### 開始使用 ###
在將 Web 應用程式連接至虛擬網路之前，請留意以下事項：

- VNET 整合僅適用於應用程式中 **標準** 或 **高階** 定價方案。  如果您啟用此功能，然後將您的 App Service 方案調整為不支援的價格方案，則您的應用程式將會失去與其正在使用之 VNET 的連接。  
- 如果目標虛擬網路已存在，您必須先以動態路由閘道器啟用其點對站 VPN，才能使該虛擬網路與應用程式連接。  如果您以靜態路由設定閘道，便無法啟用點對站台的虛擬私人網路 (VPN)。
- VNET 與您的 App Service 方案 (ASP) 必須位於同一個訂用帳戶中。  
- 與 VNET 整合的應用程式將使用指定給該 VNET 的 DNS。
- 依預設，應用程式整合只會根據 VNET 中定義的路由，將流量路由傳送至 VNET。  


## 啟用 VNET 整合 ##

您可以選擇連接新的或現有的虛擬網路。  如果您建立新網路，則除了建立 VNET 外，還會為您預先設定動態路由閘道器，並將啟用點對站 VPN。  

>[AZURE.NOTE] 設定新的虛擬網路整合，可能需要幾分鐘的時間。  

若要啟用 VNET 整合，請開啟您的應用程式 [設定]，然後選取 [網路功能]。  開啟的 UI 提供三個網路功能選項。  本指南只探討 VNET 整合，但本文件稍後會討論混合式連接和 App Service 環境。  

如果您的應用程式不在正確的價格方案中，UI 將有助於讓您能夠將方案調整為您選擇的更高價格方案。


![][1]
 
###啟用與既存的 VNET 的 VNET 整合###
VNET 整合 UI 可讓您從 V1 VNET 的清單中選取。  在下面顯示的影像中，您可以看到只有一個 VNET 可選取。  有多個原因，導致 VNET 呈現灰色，包括：

- VNET 是您的帳戶有權存取的另一個訂用帳戶
- VNET 未啟用點對站功能
- VNET 沒有動態路由閘道器

另外值得注意的是，因為尚未支援與 V2 VNET 的整合，所以不會列出它們。 

![][2]

若要啟用整合，只需按一下您想要整合的 VNET 即可。  選取 VNET 之後，您的應用程式會自動重新啟動，使變更生效。  

如果您的 VNET 沒有閘道器，也沒有點對站，則您首先必須設定它。  若要執行此動作，請移至 Azure 入口網站，並引出虛擬網路 (傳統) 的清單。  從這裡按一下您想要整合的網路，並按一下稱為 VPN 連線之基本功能下的大型方塊。  從這裡您可以建立點對站 VPN，甚至讓它建立閘道器。  在您使用閘道器建立體驗完成點對站之後，大約 30 分鐘即可使用它。  

![][8]

### 建立 VNET 並與其整合 ###
如果想要建立新的 VNET，請注意，您目前只能建立 V1 或傳統 VNET。  若要透過 VNET 整合 UI 體驗建立 V1 VNET，只需選取 [建立新的虛擬網路]，然後將您想要的名稱提供給 VNET，並提供其位址空間。 

警告，如果您想要此 VNET 連接到任何其他網路，您應該嘗試避免挑選與這些網路重疊的 IP 位址空間。  

>[AZURE.NOTE] 可能需要 30 分鐘，以便提供與作業的閘道完成新的 VNET。  完成時，UI 即會更新。  

![][3]

通常，Azure VNET 是在私人網路位址內建立。  根據預設，VNET 整合功能會將任何以這些 IP 位址範圍為目標的流量路由傳送至您的 VNET 。  私人 IP 位址範圍如下：

- 10.0.0.0/8 - 如同 10.0.0.0 - 10.255.255.255
- 172.16.0.0/12 - 如同 172.16.0.0 - 172.31.255.255 
- 192.168.0.0/16 - 如同 192.168.0.0 - 192.168.255.255
 
VNET 位址空間需要以 CIDR 標記法指定。  如果您不熟悉 CIDR 標記法，它是使用 IP 位址和代表網路遮罩之整數來指定位址區塊的方法。 做為快速參考，請考慮 10.1.0.0/24 將是 256 個位址，而 10.1.0.0/25 將是 128 個位址。  搭配 /32 的 IPv4 位址將只是 1 個地址。  

如果您在這裡設定 DNS 伺服器資訊，則該資訊將是針對您的 VNET 而設定的。  在建立 VNET 之後，您可以根據 VNET 使用者體驗編輯此資訊。

當您使用 VNET 整合 UI 建立 V1 VNET 時，它將在與您的應用程式相同的資源群組中建立 VNET。 

## 系統的運作方式 ##
此功能實際上組建在點對站 VPN 技術之上，以將您的應用程式連接到您的 VNET。   Azure App Service 中的應用程式具備多租用戶的系統架構，其會防止在 VNET 中直接佈建應用程式，就像使用虛擬機器所做的一樣。  藉由以點對站技術為基礎來進行建置，我們得以將網路存取限制為僅限裝載應用程式的虛擬機器。  在這些應用程式主機上，我們更進一步限制網路的存取權限，因此應用程式只能存取您設定為供其存取的網路。  

![][4]
 
如果您尚未設定虛擬網路的 DNS 伺服器，便需要使用 IP 位址。  在使用 IP 位址時，請記住此功能的主要優點在於它可讓您在私人網路內使用私人位址。  如果將應用程式設為使用其中一個 VM 的公用 IP 位址，則您不是使用 VNET 整合功能，而是透過網際網路進行通訊。



##管理 VNET 整合功能##

要在應用程式層級上，才能連接或中斷連接 VNET。  可在多個應用程式之間影響 VNET 整合的作業是在 ASP 層級上。  從 UI 會顯示在應用程式層級，您可以在 VNET 上取得詳細資料。  大部分相同的資訊也會顯示在 ASP 層級。  

![][5]

從 [網路功能狀態] 頁面中，您可以看到應用程式是否已連接到 VNET。  無論您的 VNET 閘道器基於何種原因關閉，此狀態將顯示為未連接。  

您現在擁有存取您的應用程式層級的 VNET 整合 UI 是從 ASP 所得到的詳細資訊相同的資訊。  這些項目如下：

- VNET 名稱 - 此連結會開啟網路 UI
- 位置 - 這會反映 VNET 的位置。  可能與另一個位置中的 VNET 整合。
- 憑證狀態 - 有若干憑證，用來保護應用程式與 VNET 之間的 VPN 連線。  這會反映測試，以確保它們保持同步。
- 閘道器狀態 - 無論您的閘道器基於何種原因關閉，您的應用程式將無法存取 VNET 中的資源。  
- VNET 位址空間 - 這是 VNET 的 IP 位址空間。  
- 點對站位址空間 - 這是 VNET 的點對站 IP 位址空間。  您的應用程式將顯示來自此位址空間的其中一個 IP 的通訊。  
- 站對站位址空間 - 您可以使用站對站 VPN，將您的 VNET 連接到您的內部部署資源或連接到其他 VNET。  如果您已如此設定，則以該 VPN 連線定義的 IP 範圍將顯示在這裡。
- DNS 伺服器 - 如果您已設定 DNS 伺服器與 VNET 搭配，則它們會列示在這裡。
- 路由傳送至 VNET 的 IP - 有一個 IP 位址清單，您的 VNET 已定義將路由傳送至這些 IP 位址。  這些位址將顯示在這裡。  

您可以在 VNET 整合的應用程式檢視中採取的唯一作業，就是中斷連接目前連接到 VNET 的應用程式。  若要這樣做，只需按一下頂端的 [中斷連接] 即可。  這個動作不會變更您的 VNET。  VNET 及其組態 (包括閘道器) 仍會保持原狀。  如果接著您要刪除 VNET，則需要先刪除其中資源，包括閘道器。  

[App Service 方案] 檢視具有一些其他作業。  也可用不同的方式從應用程式中存取它。  若要觸達 ASP 網路功能 UI，只需開啟您的 ASP UI，並向下捲動即可。  有一個稱為網路功能狀態的 UI 元素。  它將提供一些有關 VNET 整合的次要詳細資訊。  按一下此 UI，即會開啟網路功能狀態 UI。  如果接著按一下 [按一下這裡以管理]，將開啟 UI，列出此 ASP 中的 VNET 整合。

![][6]

當查看您要整合之 VNET 的位置時，ASP 的位置很好記。  當 VNET 在另一個位置時，您更有可能發現延遲問題。  

整合的 VNET 提醒您，您的應用程式已在此 ASP 與多少個 VNET 整合，以及您可以具有多少個。  

若要查看每個 VNET 新增的詳細資料，只需按一下您感興趣的 VNET 即可。  除了先前提到的詳細資料外，您還會在此 ASP 中看到正在使用該 VNET 之應用程式的清單。  

關於動作，有兩個主要動作。  第一個動作能夠新增路由，驅使流量離開您的應用程式進入 VNET。  第二個動作能夠同步處理憑證和網路資訊。

![][7]

**路由** 
如先前所述在 VNET 中定義為路由會用於將流量導向到您的 VNET 與您的應用程式。  還有一些用途，就是客戶想要將額外的輸出流量從應用程式傳送到 VNET，但已對他們提供此功能。  傳送後流量發生什麼情況取決於客戶如何設定其 VNET。  

**憑證**
憑證的狀態會反映正在執行的應用程式服務，來驗證所使用的 VPN 連線的憑證是仍舊是極佳的檢查。  啟用 VNET 整合時，如果這是此 ASP 中的任何應用程式與該 VNET 的第一個整合，則需要交換憑證以確保連線的安全性。  除了憑證以外，我們還得到 DNS 組態、路由，以及其他描述網路的類似項目。
如果這些憑證或網路資訊已變更，您將需要按一下 [同步處理網路]。  **請注意**: 當您按一下 「 同步處理網路 」，則您會短暫中斷連線您的應用程式與您的 VNET 之間。  如果應用程式不重新啟動，失去連線會導致您的網站無法正常運作。  

##存取內部部署資源##

VNET 整合功能的優點之一就是，如果 VNET 以站對站 VPN 連接到內部部署網路，應用程式就可以從應用程式中存取內部部署資源。  但是，若要如此運作，您可能需要以點對站 IP 範圍的路由更新內部部署 VPN 閘道器。  第一次設定站對站 VPN 時，用來設定它的指令碼應該設定路由，包括點對站 VPN。  如果在建立站對站 VPN 之後新增點對站 VPN，您將需要手動更新路由。  此做法的詳細資料將根據閘道器而有所不同，不在這裡詳述。  

>[AZURE.NOTE] VNET 整合功能將會使用站台對站台 VPN 存取內部部署資源時它目前不適用於執行相同 ExpressRoute VPN。  

##價格詳細資料##
有幾個您在使用 VNET 整合功能時應該注意的價格細微差別。  有 3 個與使用此功能相關的費用：

- ASP 定價層需求
- 資料傳輸成本
- VPN 閘道器成本

您的應用程式若要能夠使用此功能，它們必須位於標準或進階 App Service 方案中。  您可以在這些成本這裡看到更多詳細資料: [應用程式服務定價] [ASPricing]。 

由於處理點對站 VPN 的方式，您必須付費，才能透過 VNET 整合連線輸出資料，即使 VNET 位於相同的資料中心也一樣。  若要查看這些費用會看看這裡: [資料傳輸定價詳細資料] [DataPricing]。  

最後一個項目就是 VNET 閘道器的成本。  如果對其他項目 (例如站對站 VPN) 您不需要閘道器，表示您的付費是讓閘道器支援 VNET 整合功能。  這些成本此處有詳細資料: [VPN 閘道定價] [VNETPricing]。  

##疑難排解##

儘管功能易於設定，這不表示您的體驗不會遇到問題。  如果您在存取所需端點時遇到問題，有一些公用程式，您可以用來從應用程式主控台測試連線功能。  有兩個您可以使用的主控台體驗。  一個是從 Kudu 主控台，另一個則是您可以在 Azure 入口網站觸達的主控台。  若要前往 Kudu 主控台，請從您的應用程式移至 [工具] -> [Kudu]。  這與移至 [sitename].scm.azurewebsites.net 相同。  一旦開啟，只需移至 [偵錯主控台] 索引標籤即可。  若要前往 Azure 入口網站裝載的主控台，請從您的應用程式移至 [工具] -> [主控台]。  


####工具####

由於安全性限制，工具 ping、nslookup 和 tracert 無法透過主控台運作。  為了填滿此空隙，已加入兩個不同的工具。  為了測試 DNS 功能，已加入名為 nameresolver.exe 的工具。  語法為：

    nameresolver.exe hostname [optional: DNS Server]

您可以使用 nameresolver 來檢查應用程式依賴的主機名稱。  如此一來您可以測試是否有任何項目未正確設定，而無法與 DNS 搭配，或可能對 DNS 伺服器沒有存取權。

下一個工具可讓您測試主機是否可與 TCP 連線，以及連接埠組合。  此工具會呼叫 tcpping.exe，語法是:

    tcpping.exe hostname [optional: port]

此工具會告訴您是否可以觸達特定的主機和連接埠，但不會執行您以 ICMP 型 ping 公用程式取得的相同工作。  ICMP ping 公用程式會告訴您主機是否已啟動。  使用 tcpping，您可以了解是否可以存取主機上的特定連接埠。  


####偵錯 VNET 裝載的資源的存取####

有一些事物，可以阻止您的應用程式觸達特定的主機和連接埠。  若要細分問題，請從如下的簡易事物開始：  

- 閘道器是否顯示為正在入口網站中啟動？
- 憑證是否顯示為同步中？
- 是否有任何人未在受影響的 ASP 中執行 [同步處理網路] 的情況下變更網路組態？

如果您的閘道器已關閉，請重新啟動。  如果您的憑證未同步，請移至 VNET 整合的 ASP 檢視，並點擊 [同步處理網路]。  如果您懷疑已對 VNET 組態所做的變更，而它不是同步處理 Asp 然後移至您的 VNET 整合的 ASP 檢視，並叫用 「 同步處理網路 」 恰好提醒您，這會導致短暫中斷，並且您的 VNET 連線，您的應用程式。  

如果一切都沒問題，您需要更深入發掘問題：

- 是否有任何其他應用程式成功使用此 VNET 觸達遠端資源？ 
- 您是否可以移至應用程式主控台，並使用 tcpping 觸達 VNET 中的任何資源？  

如果上述任一項成立，表示 VNET 整合沒問題，問題出在其他地方。  您也可能只是沒有上述兩個項目的答案，因為 VNET 中沒有其他東西可點擊。  此情況將更有挑戰性，因為沒有簡單的方法，來了解為何無法觸達主機:連接埠。  部分原因包括：

- 目標主機已關閉
- 應用程式已關閉
- IP 或主機名稱錯誤
- 應用程式不是接聽您預期的連接埠。  您可以移至該主機，並從命令提示字元使用 "netstat -aon" 來檢查此問題。  這會顯示哪個處理程序識別碼正在接聽哪個連接埠。  
- 您已在主機上啟動防火牆，防止從點對站 IP 範圍存取應用程式連接埠
- 您配置網路安全性群組的方式，讓這些群組防止從點對站 IP 範圍存取應用程式主機和連接埠

請記住，您不知道應用程式將使用點對站 IP 範圍中的哪個 IP，因此您必須允許從整個範圍存取。  

其他偵錯步驟包括：

- 登入 VNET 中的另一個 VM，並嘗試從該處觸達資源主機:連接埠。  有一些您可以基於此用途使用的 TCP ping 公用程式，或者甚至需要時，也可使用 telnet。  這裡的用途只是判斷是否可從這個其他 VM 連接到該處。 
- 啟動另一個 VM 上的應用程式，並從主控台測試是否可從應用程式存取該主機和連接埠  

####內部部署資源####
如果您無法觸達內部部署的資源，您應該檢查的第一件事就是，您是否可以觸達 VNET 中的資源。  如果可以，接下來的步驟就相當簡單。  您必須從 VNET 中的 VM 嘗試觸達內部部署應用程式。  您可以使用 telnet 或 TCP ping 公用程式。  如果 VM 無法觸達內部部署資源，首先確定站對站 VPN 連線運作中。  如果運作中，接著檢查先前提到的相同事物，以及內部部署閘道器組態和狀態。  

現在如果您的 VNET 裝載 VM 可以連線到您內部部署系統，但您的應用程式不能則原因可能是下列:
- 路由不會設定您的點到站台上的內部部署閘道中的 IP 範圍
- 網路安全性群組會封鎖存取您網站的 IP 範圍的點
- 在內部部署防火牆會封鎖流量從您的點的站台的 IP 範圍
- 您在站台的基礎資料流來阻止您點到達您內部部署網路的 VNET 中有使用者定義的 Route(UDR)

## 混合式連線和 App Service 環境##
有 3 個可讓您存取 VNET 裝載之資源的功能。  如下：

- VNET 整合
- 混合式連線
- App Service 環境

混合式連線需要您在網路中安裝稱為混合式連線管理員 (HCM) 的轉送代理程式。  HCM 必須同時能夠連接至 Azure 和您的應用程式。  此解決方案特別適合遠端網路，例如內部部署網路，或甚至是另一個雲端裝載的網路，因為它不需要網際網路可存取的端點。  HCM 只在 Windows 上執行，而且您最多可有 5 個執行個體同時執行，以提供高可用性。  雖然混合式連線只支援 TCP，但是每個 HC 端點必須符合特定的主機:連接埠組合。  

App Service 環境功能可讓您在 VNET 中執行 Azure App Service 的執行個體。  這可讓應用程式無需任何額外的步驟，即可存取 VNET 中的資源。  App Service 環境的好處還有您可以搭配 14 GB 的 RAM 使用 8 核心專用背景工作角色。  另一個好處是您可以調整系統以符合您的需求。  不同於 ASP 大小有限制的多租用戶環境，在 ASE 中您可以控制您想要提供給系統多少資源。  雖然本文件專注於網路，但是您可在 ASE 得到無法在 VNET 整合得到的其中一件事是，它可以使用 ExpressRoute VPN。  

儘管有使用案例重疊的情況，但這些功能無法取代彼此。  知道使用哪個功能取決於您的需求以及您要如何使用它。  例如：

- 如果您是開發人員，而且只是想要在 Azure 中執行網站，並讓它可存取辦公桌下工作站上的資料庫，則最簡單的方式就是使用混合式連線。  
- 如果您是想要將大量 Web 內容放在公用雲端，並在自己的網路中管理它們的大型組織，則您會想要使用 App Service 環境。  
- 如果您有許多 App Service 裝載的應用程式，而且只想要存取 VNET 中的資源，則 VNET 整合是最好的選擇。  

除了使用案例以外，還有一些簡單相關層面。  如果 VNET 已連接到內部部署網路，則使用 VNET 整合或 App Service 環境是取用內部部署資源的簡單方法。  另一方面，如果 VNET 未連接到內部部署網路，則與安裝 HCM 相較，設定站對站 VPN 與 VNET 搭配，需要更多的額外負荷。  

除了功能差異以外，還有價格差異。  App Service 環境功能是進階服務供應項目，除了其他很棒的功能外，還提供最多的網路組態可能性。  VNET 整合可與標準或進階 ASP 搭配使用，並非常適合從多租用戶 App Service 安全取用 VNET 中的資源。  混合式連線目前取決於 BizTalk 帳戶，此帳戶具有的價格層級，從一開始免費，然後根據您需要的數量而越發昂貴。  不過，當在許多網路之間工作時，沒有其他功能像混合式連線一樣，可讓您存取超過 100 個不同網路中的資源。    


<!--Image references-->
[1]: ./media/web-sites-integrate-with-vnet/vnetint-upgradeplan.png
[2]: ./media/web-sites-integrate-with-vnet/vnetint-existingvnet.png
[3]: ./media/web-sites-integrate-with-vnet/vnetint-createvnet.png
[4]: ./media/web-sites-integrate-with-vnet/vnetint-howitworks.png
[5]: ./media/web-sites-integrate-with-vnet/vnetint-appmanage.png
[6]: ./media/web-sites-integrate-with-vnet/vnetint-aspmanage.png
[7]: ./media/web-sites-integrate-with-vnet/vnetint-aspmanagedetail.png
[8]: ./media/web-sites-integrate-with-vnet/vnetint-vnetp2s.png

<!--Links-->
[VNETOverview]: http://azure.microsoft.com/documentation/articles/virtual-networks-overview/ 
[ASPricing]: http://azure.microsoft.com/pricing/details/app-service/
[VNETPricing]: http://azure.microsoft.com/pricing/details/vpn-gateway/
[DataPricing]: http://azure.microsoft.com/pricing/details/data-transfers/

