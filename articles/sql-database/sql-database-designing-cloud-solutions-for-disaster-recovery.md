<properties 
   pageTitle="使用 SQL Database 異地複寫來設計災害復原的雲端解決方案"
   description="了解如何選擇正確的容錯移轉模式來設計災害復原的雲端解決方案。"
   services="sql-database"
   documentationCenter="" 
   authors="anosov1960" 
   manager="jeffreyg" 
   editor="monicar"/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-management" 
   ms.date="10/07/2015"
   ms.author="sashan"/>


# 使用異地複寫設計業務持續性的雲端應用程式

設計業務持續性的應用程式時，在許多方面可以利用 SQL Database 的異地複寫。 設計的決定因素包括應用程式部署拓撲、您要達到的服務等級協定、流量延遲和成本。 在本文中，我們將探討常見的應用程式模式，並討論每個選項的優缺點。

## 設計模式 1：災害復原的主動-被動部署，使用共置資料庫

這個選項最適合具有下列特性的應用程式：

+ 單一 Azure 區域中的作用中執行個體
+ 強烈依賴資料的讀寫 (RW) 存取
+ 考量到延遲和流量成本，無法接受應用程式邏輯和資料庫之間的跨區域連接

在此情況下，應用程式部署拓撲經過最佳化，可處理區域性災害，此時所有應用程式元件都受影響，而需要當成一個單位來容錯移轉。 在地理備援方面，應用程式邏輯和資料庫複寫到另一個區域，但在正常情況下不負責處理應用程式工作負載。 次要地區中的應用程式應該設定為使用次要資料庫的 SQL 連接字串。 流量管理員設定為使用 [容錯移轉路由方法](traffic-manager-configure-failover-load-balancing.md)。
> [AZURE.NOTE] [Azure 流量管理員](traffic-manager-overview.md) 整篇文章僅供說明用途使用。 您可以使用任何支援容錯移轉路由方法的負載平衡解決方案。    

除了主要應用程式執行個體您應該考慮部署小型 [背景工作角色應用程式](cloud-services-choose-me.md#tellmecs) ，發出定期 T-SQL 唯讀 (RO) 命令來監視您的主要資料庫。 您可以利用它來自動觸發容錯移轉、在應用程式的系統管理員主控台產生警示，或兩種功能都執行。 為了確保地區性的運作中斷不會影響監視，您應該將監視應用程式執行個體部署至每個區域，並將它們連接到其他區域中的資料庫，但只有次要地區中執行個體必須在作用中。
> [AZURE.NOTE] 如果您使用 [作用中地理複寫](https://msdn.microsoft.com/library/azure/dn741339.aspx) 您可以有兩個監視的應用程式使用中和探查主要和次要資料庫。 後者可用來偵測次要地區中的失敗，並於應用程式未受保護時發出警示。     

下圖顯示此組態在運作中斷之前的情形。

![圖 1](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-1.png)

當主要區域發生運作中斷之後，監視應用程式會偵測到主要資料庫無法存取，並發出警示。 根據您的應用程式 SLA，您可以決定連續多少個監視探查失敗後，才宣告資料庫運作中斷。 為了達成應用程式端點和資料庫的協調式容錯移轉，您應該讓監視應用程式執行下列步驟：

1. [更新主要端點的狀態](https://msdn.microsoft.com/library/hh758250.aspx) 觸發端點容錯移轉。
2. 呼叫次要資料庫 [起始資料庫容錯移轉](https://msdn.microsoft.com/library/azure/dn509573.aspx)

容錯移轉後，應用程式會處理次要地區中的使用者要求，但仍與資料庫共置，因為主要資料庫現在位於次要地區。 下圖說明這種情形。 在所有圖表中，實線表示作用中連線、虛線表示已暫停的連線，停止標誌表示動作觸發。


![圖 2](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-2.png)

如果次要地區發生運作中斷，主要與次要資料庫之間的複寫連結會暫停，而監視應用程式會發出警示，指出主要資料庫已曝露。 這不會影響應用程式的效能，但它會在曝露的情況下運作，因此，萬一兩個區域連續失敗，將帶來較高的風險。
> [AZURE.NOTE] 我們只建議使用具有單一 DR 區域的部署組態。 這是因為大部分 Azure 地理位置有兩個區域。 這些組態無法保護應用程式免於遭受兩個區域同時發生的重大失敗。 這類失敗的罕見事件中，您可以復原您的資料庫，在第三個區域使用 [異地還原作業](sql-database-disaster-recovery.md#recovery-using-geo-restore)。

一旦運作中斷情況趨緩，次要資料庫會自動與主要資料庫同步處理。 在同步處理期間，主要資料庫的效能可能稍微受到影響，視需要同步處理的資料量而定。 下圖說明次要地區發生運作中斷的情形。

![圖 3](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-3.png)


此設計模式的主要**優點**包括：

+ SQL 連接字串是在每個區域中部署應用程式期間設定，而且在容錯移轉之後不會變更
+ 應用程式的效能不會受到容錯移轉所影響，因為應用程式和資料庫永遠共置

主要**缺點**是次要地區中的備援應用程式執行個體只用於災害復原。

## 設計模式 2：應用程式負載平衡的主動-主動部署

這個選項最適合具有下列特性的應用程式：

+ 資料庫的讀取與寫入比率很高
+ 資料庫寫入延遲不會影響使用者體驗
+ 使用不同的連接字串可以隔開唯讀邏輯和讀寫邏輯
+ 唯讀邏輯不依賴資料與最新更新完全同步

如果您的應用程式具有這些特性，只要將使用者連接的負載分散於不同區域中的多個應用程式執行個體，即可改善效能和使用者體驗。 若要達成此目標，每個區域都應該有應用程式的作用中執行個體，而且讀寫 (RW) 邏輯要連接到主要區域中的主要資料庫。 唯讀 (RO) 邏輯應該連接到應用程式執行個體所在的相同區域中的次要資料庫。 流量管理員應該設定為使用 [循環配置資源路由](traffic-manager-configure-round-robin-load-balancing.md) 或 [效能路由](traffic-manager-configure-performance-load-balancing.md) 與 [端點監視](traffic-manager-monitoring.md) 啟用每個應用程式執行個體。

如同模式 #1，您應該考慮部署類似的監視應用程式。 但有別於模式 #1，此監視應用程式不負責觸發端點容錯移轉。
> [AZURE.NOTE] 雖然此模式使用一個以上的次要資料庫，但其中只有一個次要資料庫用於容錯移轉，原因如稍早所述。 因為此模式需要唯讀存取次要資料庫需要 [作用中地理複寫](https://msdn.microsoft.com/library/azure/dn741339.aspx)。 

流量管理員應該設定為效能路由，將使用者連接導向最靠近使用者地理位置的應用程式執行個體。 下圖說明此組態，再中斷。 
![圖 4](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-1.png)

如果主要區域中偵測到資料庫運作中斷，您應該開始將主要資料庫容錯移轉到其中一個次要地區，而這會變更主要資料庫的位置。 流量管理員會自動從路由表中排除離線端點，但會繼續將使用者流量路由傳送至剩餘的線上執行個體。 因為主要資料庫現在位於不同的區域，所有線上執行個體必須變更其讀寫 SQL 連接字串，以連接到新的主要資料庫。 您必須在起始資料庫容錯移轉之前進行這項變更。 唯讀 SQL 連接字串應該保持不變，因為它們永遠指向相同區域中的資料庫。 容錯移轉步驟如下：

1. 變更讀寫 SQL 連接字串來指向新的主要資料庫
2. 呼叫指定的次要資料庫 [起始資料庫容錯移轉](https://msdn.microsoft.com/library/azure/dn509573.aspx)

下圖說明在容錯移轉之後的新組態。
![圖 5](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-2.png)

如果其中一個次要地區發生運作中斷，流量管理員會自動從路由表中移除該區域中的離線端點。 對於該區域中的次要資料庫的複寫通道將會暫停。 因為剩餘區域會收到更多使用者流量，所以中斷期間可能會影響應用程式的效能。 一旦運作中斷情況趨緩，受影響區域中的次要資料庫會立即與主要資料庫同步處理。 在同步處理期間，主要資料庫的效能可能稍微受到影響，視需要同步處理的資料量而定。 下圖說明其中一個次要地區發生運作中斷的情形。

![圖 6](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-3.png)

索引鍵 **利用** 此設計模式是您可以跨多個次要複本以達到最佳的使用者效能調整應用程式工作負載。 此選項的**缺點**包括：

+ 應用程式執行個體和資料庫之間的讀寫連接有不同的延遲和成本
+ 運作中斷期間會影響應用程式效能
+ 在資料庫容錯移轉之後，應用程式執行個體需要動態變更 SQL 連接字串。

> [AZURE.NOTE] 有一個類似的方法可用來卸載特殊工作負載，例如報告工作、商業智慧工具或備份。 這些工作負載通常會耗用大量的資料庫資源，因此建議您為它們指定其中一個次要資料庫，而且效能層級要符合預期的工作負載。 

## 設計模式 3：資料保留的主動-被動部署

這個選項最適合具有下列特性的應用程式：

+ 任何資料遺失都會帶來極高的商業風險，資料庫容錯移轉只能當作永久中斷運作時的最後手段
+ 應用程式可以在「唯讀模式」下運作一段時間

在此模式下，應用程式連接到次要資料庫時會切換到唯讀模式。 主要區域中的應用程式邏輯與主要資料庫相同的位置，而且讀寫模式 (讀寫) 運作，次要資料庫與共次要區域中的應用程式邏輯，並已準備好在唯讀模式下 (RO) 作業。 流量管理員應該設定為使用 [容錯移轉路由](traffic-manager-configure-failover-load-balancing.md) 與 [端點監視](traffic-manager-monitoring.md) 啟用這兩個應用程式執行個體。

下圖說明此組態，再中斷。 
![圖 7](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-1.png)

當流量管理員偵測到主要區域的連線失敗時，就會自動將使用者流量切換到次要地區中的應用程式執行個體。 使用此模式時，您在偵測到運作中斷之後**不可以**起始資料庫容錯移轉。 次要地區中的應用程式會啟動，並使用次要資料庫在唯讀模式下運作。 下圖說明這種情形。

![圖 8](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-2.png)

一旦主要區域的運作中斷情況趨緩，流量管理員會偵測主要區域中的連線恢復，然後將使用者流量切換回到主要區域中的應用程式執行個體。 該應用程式執行個體會恢復執行，並使用主要資料庫在讀寫模式下運作。
> [AZURE.NOTE] 因為此模式需要唯讀存取次要資料庫需要 [作用中地理複寫](https://msdn.microsoft.com/library/azure/dn741339.aspx)。 

如果次要地區發生運作中斷，流量管理員會將主要區域中的應用程式端點標示為降級，而且複寫通道會暫停。 不過，在運作中斷期間不會影響應用程式的效能。 一旦運作中斷情況趨緩，次要資料庫會立即與主要資料庫同步處理。 在同步處理期間，主要資料庫的效能可能稍微受到影響，視需要同步處理的資料量而定。

![圖 8](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-3.png)

此設計模式有幾個**優點**：

+ 在暫時性運作中斷期間避免資料遺失
+ 不需要您要部署為復原由流量管理員所觸發的監視應用程式
+ 停機時間僅取決於流量管理員多快偵測到連線失敗，而這是可設定。

**缺點**包括：

+ 應用程式必須能夠在唯讀模式下運作
+ 當應用程式連接到唯讀資料庫時，必須動態切換到應用程式
+ 主要區域必須復原，讀寫作業才能繼續，這表示可能有數小時甚至幾天無法完整存取資料。

> [AZURE.NOTE] 如果區域發生永久性服務中斷，您必須手動啟動資料庫容錯移轉並承受資料遺失。 應用程式將在次要地區中運作，而且具有資料庫的讀寫存取。 

## 摘要

特定的 DR 策略可以合併或擴充這些模式，以完全滿足應用程式的需求。 如先前所述，您選擇的策略取決於您想要提供給客戶的 SLA 和應用程式部署拓樸。 為了協助指導您做決定，下表根據預估資料遺失或復原點目標 (RPO) 和預估復原時間 (ERT) 來比較各種選擇。

| 模式| RPO| ERT
| :--- |:--- | :---
| 災害復原的主動-被動部署，使用共置資料庫存取| 讀寫存取 < 5 秒| 失敗偵測時間 + 容錯移轉 API 呼叫 + 應用程式驗證測試
| 應用程式負載平衡的主動-主動部署| 讀寫存取 < 5 秒| 失敗偵測時間 + 容錯移轉 API 呼叫 + SQL 連接字串變更 + 應用程式驗證測試
| 資料保留的主動-被動部署| 唯讀存取 < 5 秒，讀寫存取 = 0| 唯讀存取 = 連線失敗偵測時間 + 應用程式驗證測試 <br>讀寫存取 = 降低中斷的時間









