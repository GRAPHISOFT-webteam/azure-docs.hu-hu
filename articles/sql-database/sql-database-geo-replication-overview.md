<properties
    pageTitle="Azure SQL Database 的主動式異地複寫"
    description="本主題說明 SQL Database 的主動式異地複寫與其用途。"
    services="sql-database"
    documentationCenter="na"
    authors="rothja"
    manager="jeffreyg"
    editor="monicar" />


<tags
    ms.service="sql-database"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="data-management"
    ms.date="10/21/2015"
    ms.author="jroth" />

# Azure SQL Database 的主動式異地複寫

## 概觀
主動式異地複寫功能會實作可在相同 Microsoft Azure 區域或不同區域 (異地備援) 內提供資料庫備援的機制。 主動式異地複寫以非同步方式從資料庫將已認可的交易複寫至不同伺服器上最多四個資料庫複本。 原始的資料庫會變成連續複製的主要資料庫。 每個連續複製皆可視為線上的次要資料庫。 主要資料庫會以非同步方式將已認可的交易複寫到每一個線上次要資料庫。 雖然線上次要資料可能會在任何指定時間點稍微落後主要資料庫，但是線上次要資料保證一定會和主要資料庫認可的變更保持交易一致性。 主動式異地複寫支援最多四個線上次要資料庫，或最多三個線上次要資料庫和一個離線次要資料庫。

主動式異地覆寫的主要優點之一是它提供了資料庫層級的災害復原方案。 使用主動式異地覆寫時，您可以在高階服務層設定使用者資料庫，以將交易複寫到相同或不同區域內不同 Microsoft Azure SQL Database 伺服器上的不同資料庫。 跨區域備援可讓應用程式從天然災害、災難性人為錯誤或惡意行為所造成的資料中心永久遺失復原。 

另一個主要優點是線上的次要資料庫都可以讀取。 因此，線上的次要資料庫可做為讀取工作負載 (例如報告) 的負載平衡器。 雖然您可以在不同區域中建立線上的次要資料庫做為災害復原，您也可以在不同伺服器上的相同區域中擁有線上的次要資料庫。 這兩個線上的次要資料庫都只能用來平衡唯讀工作負載，提供服務給分散於數個區域的用戶端。 

可以使用主動式異地覆寫的其他情況包括：

- **資料庫遷移**: 您可以使用作用中地理複寫，將資料庫從某部伺服器移轉到另一個線上同時最少的停機時間。
- **應用程式升級**: 您可以使用線上次要資料庫作為容錯回復選項。

若要達到真正的業務持續性，將資料庫之間的備援新增至關聯式儲存體只是解決方案的一部分。 在災難性失敗後要端對端復原應用程式 (服務) 需要復原構成服務的所有元件和任何相依的服務。 這些元件的範例包括用戶端軟體 (例如自訂 JavaScript 的瀏覽器)、web 前端、儲存體和 DNS。 所有元件都必須對相同的失敗具有恢復功能，並且在應用程式的復原時間目標 (RTO) 內可供使用。 因此，您需要識別所有相依服務並了解其提供的保證與功能。 然後，您必須採取適當步驟以確保服務功能在它所依賴的服務容錯移轉期間都正常。 如需有關設計災害復原解決方案的詳細資訊，請參閱 [設計雲端解決方案的災害復原使用作用中地理複寫](sql-database-designing-cloud-solutions-for-disaster-recover.md)。

## 主動式異地複寫功能
主動式異地覆寫功能提供下列基本功能：

- **自動非同步複寫**: 植入線上次要資料庫之後，主要資料庫會以非同步的方式自動更新複製到線上次要資料庫。 這表示交易會先在主要資料庫上受到認可，才會複製到線上的次要資料庫。 不過在植入之後，線上的次要資料庫在任何指定時間都保持交易一致性。 
    >[AZURE.NOTE] 非同步複寫可容納 typifies 的廣域網路連線的遠端資料中心的延遲。

- **多個線上次要資料庫**: 兩個或多個線上次要資料庫增加備援和保護的主要資料庫和應用程式。 如果有多個線上的次要資料庫存在，即使其中一個線上次要資料庫失敗，應用程式仍會受到保護。 如果只有一個線上的次要資料庫卻失敗了，應用程式會暴露在更高的風險中，直到建立新的線上次要資料庫。

- **可讀取的線上次要資料庫**: 應用程式可以存取唯讀作業使用相同的安全性主體，用來存取主要資料庫的線上次要資料庫。 在線上次要資料庫上的連續複製作業優先於應用程式的存取。 此外，如果在線上次要資料庫上的查詢造成資料表鎖定太久，交易最後可能會在主要資料庫上失敗。

- **容錯移轉的使用者控制終止**: 您可以在容錯移轉至線上次要資料庫的應用程式之前，必須終止主要資料庫的連續複製關聯性。 終止連續複製關聯性需要應用程式或系統管理指令碼或手動透過入口網站的明確動作。 終止之後，線上的次要資料庫會變成獨立資料庫。 它會變成讀寫資料庫，除非主要資料庫是唯讀的資料庫。 兩種形式的 [終止連續複製關聯性](#termination-of-a-continuous-copy-relationship) 本主題稍後所述。

>[AZURE.NOTE] 主動式異地複寫僅支援 Premium 服務層中的資料庫。 這適用於主要和線上次要資料庫。 線上次要資料庫必須設定為具有與主要資料庫相同或更高的效能等級。 主要資料庫的效能等級變更不會自動複寫至次要資料庫。 任何升級應該先在次要資料庫上完成，最後才在主要資料庫上完成。 如需變更效能層級的詳細資訊，請參閱 [變更效能層級](sql-database-scale-up.md)。 線上次要資料庫的大小至少應該和主要資料庫相同，有兩個主要原因。 次要資料庫必須有足夠的容量，才能用和主要資料庫相同的速度處理複寫的交易。 如果次要資料庫的最小容量並無法處理內送交易，它可能會落後並最終影響到主要資料庫的可用性。 如果次要資料庫並沒有和主要資料庫相同的容量，容錯移轉可能會降低應用程式的效能和可用性。

## 連續複製關聯性概念
本機資料備援性和作業復原是 Azure SQL Database 的標準功能。 每個資料庫都擁有一個主要資料庫，和兩個位於相同資料中心且在該資料中心內提供高可用性的本機複本資料庫。 這表示主動式異地複寫資料庫也有備援複本。 主要和線上次要資料庫都有兩個次要複本。 不過，次要資料庫的主要複本會直接由連續複製機制更新，而無法接受任何應用程式起始的更新。 下圖說明主動式異地複寫如何跨兩個 Azure 區域延伸資料庫。 裝載主要資料庫的區域稱為主要區域。 裝載線上次要資料庫的區域稱為次要地區。 在此圖中，北歐是主要區域。 西歐是次要地區。

![連續複製關聯性](./media/sql-database-active-geo-replication/continuous-copy-relationships.gif)

如果主要資料庫無法使用，終止指定線上次要資料庫的連續複製關聯性會使線上次要資料庫成為獨立資料庫。 線上次要資料庫會繼承主要資料庫的唯讀/讀寫模式，該模式不會因為終止而變更。 例如，如果主要資料庫是唯讀的資料庫，終止後，線上次要資料庫會變成唯讀的資料庫。 此時，應用程式可以容錯移轉並繼續使用線上次要資料庫。 若要在資料中心的災難性失敗，或主要區域的中斷過久時提供恢復功能，至少要有一個線上次要資料庫必須位於不同的區域。

## 建立連續複本
您只能建立現有資料庫的連續複本。 建立現有資料庫的連續複本有助於增加異地備援性。 若要將現有的資料庫複製到不同的 Azure SQL Database 伺服器，也可以建立連續複本。 一旦建立之後，次要資料庫就要填入從主要資料庫複製的資料。 這個程序稱為植入。 植入完成之後，每筆新交易都可以在主要伺服器上認可後加以複寫。

如需如何建立現有資料庫的連續複製資訊，請參閱 [如何啟用異地複寫](sql-database-business-continuity-design.md#how-to-enable-geo-replication)。

## 防止重要資料遺失
由於廣域網路的高度延遲，連續複製採用非同步複寫機制。 這使得發生失敗時部分資料遺失是無法避免的。 不過，有些應用程式可能會要求資料不能遺失。 若要保護這些重大更新、 應用程式開發人員可以呼叫 [sp_wait_for_database_copy_sync](https://msdn.microsoft.com/library/dn467644.aspx) 在認可交易之後立即系統程序。 呼叫 **sp_wait_for_database_copy_sync** 封鎖呼叫執行緒，直到最後認可的交易複寫至線上次要資料庫為止。 此程序會等候直到所有已排入佇列的交易已認可的線上次要資料庫。 **sp_wait_for_database_copy_sync** 以特定的連續複製連結為範圍。 任何具備主要資料庫連接權限的使用者都可以呼叫此程序。 

>[AZURE.NOTE] 所造成的延遲 **sp_wait_for_database_copy_sync** 程序呼叫可能會很大。 延遲取決於佇列的長度以及可用的頻寬。 請避免呼叫此程序，除非絕對必要。

## 終止連續複製關聯性
連續複製關聯性可以隨時終止。 終止連續複製關聯性不會移除次要資料庫。 有兩種方法可以終止連續複製關聯性：

- **計劃終止** 是適用於計劃的作業無法接受資料遺失的。 規劃的終止只能在植入線上次要資料庫之後，在主要資料庫上執行。 對於規劃的終止，主要資料庫上認可的所有交易都會先複寫到線上次要資料庫，然後終止連續複製關聯性。 這可防止次要資料庫上的資料遺失。
- **未計劃的 (強制的) 終止** 為了解決主要資料庫或其中一個線上次要資料庫遺失。 強制終止可在主要資料庫或次要資料庫上執行。 每次強制終止都會導致主要資料庫與相關聯的線上次要資料庫之間無法回復的複寫關聯性遺失。 此外，強制終止會造成未從主要資料庫複寫的交易遺失。 強制終止會立即終止連續複製關聯性。 進行中的交易不會複寫到線上的次要資料庫。 因此，強制終止會導致未從主要資料庫複寫之交易無法回復的遺失。

>[AZURE.NOTE] 如果主要資料庫有只有一個連續複製關聯性，在終止後，主要資料庫的更新將不再受到保護。

如需如何終止連續複製關聯性的詳細資訊，請參閱 [從中斷復原 Azure SQL Database](sql-database-disaster-recovery.md)。

## 後續步驟
如需有關主動式異地複寫和其他商務持續性功能的 SQL 資料庫的詳細資訊，請參閱 [業務持續性概觀](sql-database-business-continuity.md)。
