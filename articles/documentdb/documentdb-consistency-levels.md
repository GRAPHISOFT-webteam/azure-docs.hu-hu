<properties 
    pageTitle="DocumentDB 中的一致性層級 | Microsoft Azure" 
    description="請檢閱 DocumentDB 具有相關效能等級的四個一致性等級，可如何協助在最終一致性、可用性和延遲的取捨評估取得平衡。" 
    keywords="eventual consistency, documentdb, azure, Microsoft azure"
    services="documentdb" 
    authors="mimig1" 
    manager="jhubbard" 
    editor="cgronlun" 
    documentationCenter=""/>

<tags 
    ms.service="documentdb" 
    ms.workload="data-services" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="09/25/2015" 
    ms.author="mimig"/>

# 使用一致性層級以最大化 DocumentDB 中的可用性和效能

開發人員通常難以在「增強式」和「最終」這兩種極端的一致性層級之中做出抉擇。 但事實上，在這兩種極端選項之間還有多個一致性層級可供選擇。 在大部分的真實案例中，應用程式都因為能夠細膩取捨一致性、可用性與延遲而獲得不少好處。 DocumentDB 提供四個定義完善的一致性層級與相關聯的效能層級。 因此，應用程式開發人員得以在預測範圍內針對一致性、可用性和延遲做出適當取捨。  
 
所有系統資源 (包括資料庫帳戶、資料庫、集合、使用者和權限) 在讀取和查詢方面始終具有極大程度的一致性。 一致性層級只適用於使用者定義的資源。 針對使用者定義的資源 (包括文件、附件、預存程序、觸發程序和 UDF) 所進行的查詢和讀取作業，DocumentDB 提供四個不同的一致性層級： 

 - 增強式一致性
 - 界限陳舊一致性
 - 工作階段一致性
 - 最終一致性

這些細微且定義完善的一致性層級可讓您在一致性、可用性與效能三者間做出合理取捨。 這些一致性層級受到可預測的效能層級的支援，可確保應用程式有一致的結果。   

## 資料庫的一致性層級

您可以設定資料庫帳戶的「預設一致性層級」，以套用至資料庫帳戶底下 (所有資料庫) 的所有集合。 所有對使用者定義的資源發出的讀取和查詢，預設都會使用資料庫帳戶上所指定的預設一致性層級。 不過，您可以指定 [x-ms-consistency-level] 要求標頭，來降低特定讀取/查詢要求的一致性層級。 DocumentDB 的複寫通訊協定支援四種類型的一致性層級，下面有這些層級的簡短說明。 

>[AZURE.NOTE] 在未來版本中，我們打算支援覆寫每個集合為基礎的預設一致性層級。  

**強式**︰ 強式一致性可保證，才會顯示寫入複本的多數仲裁持久認可之後。 寫入不是會被主要和次要仲裁同步地持久認可，就是會被中止。 讀取的認可一律是交由多數讀取仲裁來負責；用戶端絕不會看到未認可或不完整的寫入，而且一律保證會讀取最新認可的寫入。   
 
「增強式」一致性可保證資料絕對一致，但是其讀取和寫入效能最差。  

**界限-陳舊**︰ 界限-陳舊一致性可保證讀取最 K 前置詞之後寫入的延遲可能性寫入傳播的順序。 讀取的認可一律是交由複本的多數仲裁來負責。 讀取要求的回應可指出其相對新鮮度 (以 K 來表示)。 界限-陳舊您可以設定為取捨延遲和穩定狀態的一致性的讀取-陳舊 （做為前置詞或時間） 的可設定的閾值。

「界限-陳舊」的讀取一致性行為更加容易預測，且寫入延遲最低。 因為讀取的認可是由多數仲裁負責，所以系統提供的讀取延遲不是最低的。 「界線-陳舊」是在您需要增強式一致性但增強式一致性卻不實際時的案例選項。 如果您將「界線-陳舊」一致性的設定「陳舊間隔」設定為任一較大的值，它仍將保留總全域寫入順序。 這可以提供比「工作階段」或「最終」更強的保證。    

>[AZURE.NOTE] 界限-陳舊保證只有在明確的讀取要求的單純讀取。 寫入要求的回應伺服器回應不提供繫結的陳舊保證。

**工作階段**︰ 與不同的是增強式 」 和 「 界限-陳舊 」 一致性層級所提供的全域一致性模型，「 工作階段 」 一致性量身訂做為特定的用戶端工作階段。 工作階段一致性通常就已足夠，因為它提供有保證的單純讀取、寫入，以及讀取您自己的寫入的能力。 工作階段一致性的讀取要求發出對象，是可以提供用戶端所要求版本 (工作階段 Cookie 的一部分) 的複本。  

「工作階段一致性」層級為工作階段提供可預測的讀取資料一致性，且寫入延遲最低。 在極少數的情況下，讀取延遲也很低 (這為例外)，此時讀取會由單一複本提供。  

**最終**: 「 最終 」 一致性是最差的一致性，讓用戶端可能會收到比它有一段時間所看到，舊的值形式。 之後如果沒有再收到任何寫入，群組內的複本最後會只剩一個。 讀取要求是由任何次要索引提供。  

「最終一致性」提供最差的讀取一致性，但是讀取和寫入的延遲皆是最低。 

### 變更資料庫一致性層級

1.  在 [Azure 入口網站](https://portal.azure.com/), ，在 Jumpbar 中按一下 [ **DocumentDB 帳戶**。

2. 在 **DocumentDB 帳戶** 分頁中，選取要修改的資料庫帳戶。

3. 在 [帳戶] 分頁中，在 **組態** 鏡頭中，按一下 **預設一致性** 並排顯示。

4. 在 **預設一致性** 刀鋒視窗中，選取新的一致性層級，然後按一下 [ **儲存**。 

    ![螢幕擷取畫面會反白顯示預設一致性磚、一致性設定和 [儲存] 按鈕](./media/documentdb-consistency-levels/database-consistency-level.png)

## 查詢的一致性層級

根據預設，使用者定義的資源的查詢一致性層級會與讀取相同。 每次在集合中插入、取代或刪除文件時，預設會同步更新索引。 這個行為讓查詢能夠使用與文件的讀取相同的一致性層級。 雖然 DocumentDB 的寫入已經過最佳化處理，並支援持續的文件寫入數量以及同步索引維護和提供一致的查詢，但是您還是可以設定特定集合，讓集合的索引更新速度變慢。 讓索引速度變慢可提升寫入效能，而且適合用於工作負載主要是進行大量讀取的大量擷取案例。  

索引模式|  讀取|  查詢  
-------------|-------|---------
一致 (預設)|   有「增強式」、「界限-陳舊」、「工作階段」或「最終」可供選取|    有「增強式」、「界限-陳舊」、「工作階段」或「最終」可供選取|
緩慢|   有「增強式」、「界限-陳舊」、「工作階段」或「最終」可供選取|    最終  

和讀取要求相同，您可以指定 [x-ms-consistency-level] 要求標頭，來降低特定查詢要求的一致性層級。  

## 後續步驟

如果您想要詳細了解一致性層級和取捨，我們建議下列資源：

-   Doug Terry。 透過棒球解釋的複寫資料一致性。   
[http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf](http://research.microsoft.com/pubs/157411/ConsistencyAndBaseballReport.pdf)
-   Doug Terry。 弱式一致複寫資料的工作階段保證。   
[http://dl.acm.org/citation.cfm?id=383631](http://dl.acm.org/citation.cfm?id=383631)
-   Daniel Abadi。 現代分散式資料庫系統設計的一致性取捨 ︰ CAP 是唯一的重點 」。   
[http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html](http://computer.org/csdl/mags/co/2012/02/mco2012020037-abs.html) 
-   Peter Bailis、Shivaram Venkataraman、Michael J. Franklin、Joseph M. Hellerstein、Ion Stoica。 實際部分仲裁的機率界限-陳舊 (PBS)。   
[http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf](http://vldb.org/pvldb/vol5/p776_peterbailis_vldb2012.pdf)
-   Werner Vogels。 再論最終一致。    
[http://allthingsdistributed.com/2008/12/eventually_consistent.html](http://allthingsdistributed.com/2008/12/eventually_consistent.html)
 


