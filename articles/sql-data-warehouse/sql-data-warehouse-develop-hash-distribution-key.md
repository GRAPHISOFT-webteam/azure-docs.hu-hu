<properties
   pageTitle="雜湊散發及其對 SQL 資料倉儲中查詢效能的影響 | Microsoft Azure"
   description="了解雜湊散發資料表，以及它們如何影響 Azure SQL 資料倉儲中的查詢效能，以開發解決方案。"
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="jrowlandjones"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="09/22/2015"
   ms.author="JRJ@BigBangData.co.uk;barbkess"/>

# 雜湊散發及其對 SQL 資料倉儲中查詢效能的影響

做出智慧的雜湊散發決策是改善查詢效能最重要的方式之一。  

事實上，有三個主要因素：

1. 最小化資料移動
2. 避免資料扭曲
3. 提供平衡的執行

## 最小化資料移動
當資料表聯結在一起，或在資料表上執行彙總，最常發生的就是資料移動。 共用金鑰上的雜湊散發資料表是最小化此移動最有效的方法之一。

不過，若要讓雜湊散發對最小化移動發揮效果，下列準則必須全部為真：

1. 這兩個資料表必須為雜湊散發式，且在共用的散發金鑰上聯結
2. 這兩個資料行的資料類型必須相符
3. 聯結的資料行必須為等值聯結 (也就是左方資料表資料行的值必須等於右方資料表資料行的值)
4. 聯結是 **不**  `CROSS JOIN`

> [AZURE.NOTE] 資料行中使用 `JOIN`, ，`GROUP BY`, ，`DISTINCT` 和 `HAVING` 子句都會產生的雜湊資料行的候選項目。 其他手中的資料行 `WHERE` 子句 **不** 進行良好的雜湊資料行的候選項目。 請參閱下列與平衡的執行相關的一節。

當查詢語法 (`COUNT DISTINCT` 和 `OVER` 兩個子句都是絕佳範例) 和不包含雜湊散發索引鍵的資料行搭配使用時，也可能會發生資料移動。

> [AZURE.NOTE] 循環配置資源資料表通常會產生資料移動。 資料表中的資料已經以不具決定性的方式配置，所以必須在大部分的查詢完成之前移動資料。

## 避免資料扭曲
為了使雜湊散發有效，選擇的資料行必須表現下列屬性：

1. 資料行包含大量的相異值。
2. 資料行不會不會遭受 **資料扭曲**。

每個相異值會配置到散發。 因此，資料需要合理數目的相異值，以確保產生足夠的唯一雜湊值。 否則，我們可能會取得品質不佳的雜湊。 如果散發的數目超過相異值的數目 (舉例而言)，某些散發就會保留空白。 這可能會損及效能。

同樣地，如果所有的雜湊資料行的資料列都包含相同的值則資料即為 **扭曲**。 在此極端的情況下，只能建立一個雜湊值，導致所有資料列最後都在單一散發內。 在理想的情況下，雜湊資料行中的每個相異值都有相同數目的資料列。

> [AZURE.NOTE] 循環配置資源資料表並不會出現扭曲的跡象。 這是因為資料會跨散發平均儲存。

## 提供平衡的執行
當每個散發有相同數量的工作要執行時，就會達成平衡的執行。 大量平行處理 (MPP) 是團隊遊戲；在任何人被宣告為贏家之前，每個人都必須越過此線。 如果每個散發有相同數量的工作 (也就是要處理的資料)，則所有查詢都會在大致相同的時間完成。 這就是所謂的平衡的執行。

如您所見，資料扭曲可能會影響平衡的執行。 不過，也因此可以選擇雜湊散發索引鍵。 如果已選擇出現在查詢的 `WHERE` 子句中的資料行，則查詢很有可能不會平衡。  

> [AZURE.NOTE]  `WHERE` 子句通常有助於識別最適用於資料分割的資料行。

出現在 `WHERE` 子句之資料行的理想範例應該是日期欄位。  日期欄位是絕佳資料分割資料行的傳統範例，但通常是不佳的雜湊散發資料行。 一般而言，資料倉儲查詢會維持一段指定的時間，例如日、週或月。 依據日期的雜湊散發可能已實際限制我們的延展性並損及我們的效能。 例如，如果指定的日期範圍是一週 (也就是 7 天)，則雜湊的最大數目就是 7 - 每天一個。 這表示只有 7 個散發會包含資料。 其餘的散發沒有任何資料。 這會導致不平衡的查詢執行，因為只有 7 個散發在處理資料。

> [AZURE.NOTE] 循環配置資源資料表通常會提供平衡的執行。 這是因為資料會跨散發平均儲存。

## 建議
若要最大化您的效能和整體查詢輸送量，請嘗試和確定您的雜湊散發資料表盡量遵循這種模式：

雜湊散發索引鍵：

1. 用於查詢中的 `JOIN`、`GROUP BY`、`DISTINCT` 或 `HAVING` 子句。
2. 不會用於 `WHERE` 子句
3. 有許多不同的值，至少 1000 個。
4. 不會有不成比例的大量資料列雜湊至少量的散發。
5. 定義為 NOT NULL。 NULL 資料列會聚集在單一散發中。

## 摘要

雜湊散發摘要如下：

- 雜湊函數具決定性。 相同的值一定會指派給相同的散發。
- 一個資料行做為散發資料行。 雜湊函數會使用指定的資料行來計算散發的資料列指派。
- 雜湊函數會根據資料行的類型，而不是本身的值
- 有時候散發資料表的雜湊可能造成扭曲的資料表
- 解析查詢時，雜湊散發資料表通常需要較少的資料，因此可以改善大型事實資料表的查詢效能。
- 觀察對雜湊散發資料行選取的建議，以增強查詢輸送量。

> [AZURE.NOTE] 在 SQL 資料倉儲的資料類型一致性相當重要! 請確定現有的結構描述一致使用相同類型的資料行。 這對散發索引鍵尤其重要。 如果未同步處理散發索引鍵資料類型，且資料表已聯結，就會發生不需要的資料移動。 如果資料表很大，而且會減少的輸送量和效能，這可能是高成本。


## 後續步驟
如需更多開發秘訣，請參閱 [開發概觀] []。

<!--Image references-->

<!--Article references-->
[development overview]: sql-data-warehouse-overview-develop.md

<!--MSDN references-->

<!--Other Web references-->

