<properties
   pageTitle="資料分割指引 |Microsoft Azure"
   description="如何將分開要個別管理和存取的分割區指引。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="04/28/2015"
   ms.author="masashin"/>

# 資料分割指引

![](media/best-practices-data-partitioning/pnp-logo.png)

## 概觀

在許多大型解決方案中，資料分成個別的分割區，可以個別管理和存取。 您必須仔細選擇資料分割策略，才能最大化利益，同時將不良影響降至最低。 資料分割可以協助改善延展性、減少爭用，以及最佳化效能。 資料分割的附帶好處是也可以提供一種機制，可藉由使用模式區分資料。您可以將較舊的、較非使用中 (冷) 的資料封存至成本較低的資料儲存體。

## 為何要分割資料？

大部分的雲端應用程式和服務會將資料儲存和擷取做為其作業的一部分。 應用程式所使用之資料存放區的設計和系統的效能、輸送量和延展性有明顯的關係。 通常會套用在大型系統中的一個技術是將資料區分成個別的分割區。

> 這個詞彙 _分割_ 用在此指南指的是實際將資料分成不同的資料存放區的程序。 這和 SQL Server 資料表分割並不同，後者是不同的概念。

分割資料可以提供許多優點。 例如，它可以套用來：

- **改善延展性**。 向上調整單一資料庫系統，最後會達到實體硬體的限制。 跨多個分割區來區分資料，每一種都裝載在個別的伺服器，可讓系統幾乎無限向外調整。
- **改善效能**。 在每個分割區上的資料存取作業會透過較小的資料磁碟區進行。 如果以適當方式分割資料，效率會更佳。 會影響多個分割區的作業可以平行執行。 每個分割區可以靠近使用它的應用程式以最小化網路延遲。
- **改善可用性**。 跨多個伺服器分格資料可避免單一失敗點。 如果伺服器失敗，或正在進行規劃的維護，只有該資料分割中的資料無法使用。 在其他分割區上的作業可以繼續進行。 增加分割區的數目可減少無法使用的資料百分比，藉以減少單一伺服器失敗的相對影響。 複寫每個分割區可以進一步減少單一分割區失敗影響作業的機會。 它也可以分離必須持續高度可用的重要資料和具有較低可用性需求的低價值資料 (例如記錄檔)。
- **改善安全性**。 依據資料的性質及其分割方式，就可以將機密和非機密資料分離到不同的分割區，並因此分離到不同的伺服器或資料存放區。 如此便可以為機密資料進行安全性的特別最佳化。
- **提供做業彈性**。 資料分割提供許多微調作業、最大化系統管理效率和最小化成本的機會。 有些範例會根據資料在每個分割區中的重要性，定義不同的策略，例如管理、監視、備份和還原以及其他系統管理工作。
- **比對資料存放區和使用模式**。 資料分割可根據資料存放區所提供的成本和內建功能，讓每個分割區部署在不同類型的資料存放區上。 例如，大型二進位資料會儲存在 blob 資料存放區，而更結構化的資料可能存放在文件資料庫。 如需詳細資訊，請參閱 [建置 Polyglot 解決方案](https://msdn.microsoft.com/library/dn313279.aspx) 典範與實例指南 [高度可延展解決方案的資料存取: 使用 SQL、 NoSQL 和 Polyglot 持續性](https://msdn.microsoft.com/library/dn271399.aspx) Microsoft 網站上。

有些系統不會實作資料分割，因為它會被視為額外負荷，而不是一項優點。 這個基本原理的常見原因包括：

- 許多資料儲存系統不支援跨分割區聯結，而且難以維護資料分割系統中的參考完整性。 通常必須要實作應用程式碼中 (資料分割層中) 的聯結和完整性檢查，而這可能會導致其他 I/O 和應用程式的複雜度。
- 維護分割區不一定都是簡單的工作。 在資料可變更的系統中，您可能需要定期重新平衡分割區來減少爭用和作用點。
- 常用的一些工具不會自然地使用分割的資料。

## 移除分割區

資料可以用不同的方式分割：水平、垂直或功能。 您選擇的策略取決於分割資料的原因、應用程式的需求和使用該資料的服務。

> [AZURE.NOTE] 在本指南中的資料分割配置中的基礎資料儲存技術無關的方式說明。 它們可以套用到許多類型的資料存放區，包括關聯式和 NoSQL 資料庫。

### 資料分割策略

分割資料的三個典型的策略是：

- **水平資料分割** (通常稱為 _分區化_)。 在此策略中，每個分割區本身都是資料存放區，但所有分割區具有相同的配置。 每個分割區都稱為 _分區_ 和保存資料，例如一組特定的客戶電子商務應用程式中的所有訂單的特定子集。
- **垂直資料分割**。 在此策略中，每個分割區會在資料存放區中保留項目的欄位子集。 這些欄位會根據其使用模式區分，例如將經常存取的欄位放在一個垂直分割區，並將另一個較不常存取的欄位放在另一個。
- **功能資料分割**。 在此策略中，資料會根據系統中每個已繫結的內容如何使用它來進行彙總。 例如，實作發票開立和管理產品存貨等個別商務功能的電子商務系統可能會將發票資料儲存在一個分割區，並將產品庫存資料儲存在另一個。

請務必注意此處所述的三個策略可以結合。  它們不會互斥，設計資料分割配置時應該全部納入考量。 例如，您可能會將資料區分成分區，然後使用垂直資料分割進一步細分每個分區中的資料。 同樣地，功能資料分割中的資料可以劃分成分區 (可能也會以垂直方式分割)。

不過，每一種策略的不同需求可能會引發許多衝突問題，您在設計符合系統中整體資料處理效能目標的資料分割配置時，必須加以評估和平衡。 下列各節會探索每一種策略的詳細資料。

### 水平資料分割 (分區化)

圖 1 顯示水平資料分割或分區化的概觀。 在此範例中，產品庫存資料會根據產品索引鍵區分成分區。 每個分區都保存分區索引鍵 (A-G 和 H-Z) 的連續範圍資料，依照字母順序排列。

![](media/best-practices-data-partitioning/DataPartitioning01.png)

_圖 1. -水平資料分割 (分區化) 資料是根據資料分割索引鍵_

分區化可讓您將負載分散到多部電腦；減少爭用並改善效能。 藉由新增在其他伺服器執行的進一步分區，您可以向外延展系統。

實作此資料分割策略時的最重要因素是分區化索引鍵的選擇。 系統在作業之後，就很難變更索引鍵。 索引鍵必須確定資料已分割，使工作負載盡可能跨分區平均分配。 請注意，不同分區並沒有包含類似的資料磁碟區，而重要的考量是要平衡要求數目；有些分區可能非常大，但每個項目都是少量存取作業的主體，而其他分區可能較小，但是更常存取每個項目。 另一個重點是要確保單一分區不超過用來裝載該分區之資料存放區的規模限制 (以容量和處理資源為準)。

分區化配置也應該避免建立作用點 (或熱點分割區)，其可能會影響效能和可用性。 例如，使用客戶識別碼的雜湊，而不是客戶名稱的第一個字母，可防止常見和較不常見首字母所產生的不平衡分佈。 這是典型的技巧，可幫助資料更平均地跨分割區分佈。

您選擇的分區化索引鍵應該最小化任何未來需求，以將大型分區劃分成較小的片段、將小型分區聯合成較大的分割區，或者變更描述儲存在分割區集合中之資料的配置。 這些作業可能非常耗時，而且可能需要在執行時讓一或多個分區離線。 如果複寫分區，某些複本可能可以保持上線，而其他複本會被劃分、合併，或者重新設定，但系統可能需要限制可以在這些分區中的資料上執行的作業。 例如，複本中的資料無法標記為唯讀以限制不一致的範圍，否則不一致的情形可能會發生在重新建構區分的時候。

> 詳細資訊和指引許多這些考量，以及絕佳實務技術設計資料存放區的實作水平資料分割，請參閱 [分區化模式](http://aka.ms/Sharding-Pattern)

### 垂直資料分割

垂直資料分割的最常見用途是可降低與擷取最常存取之項目相關聯的 I/O 和效能成本，。 圖 2 顯示垂直資料分割的範例概觀，其中每個資料項目的不同屬性都保留在不同的分割區中；產品名稱、描述和價格資訊的存取頻率高於存貨量或上一次訂單日期。

![](media/best-practices-data-partitioning/DataPartitioning02.png)

_圖 2. -以垂直方式分割資料的使用模式_

在此範例中，應用程式會在向客戶顯示產品詳細資料時，固定一併查詢產品名稱、描述和價格。 存貨量和上一次從製造商訂購產品的日期保留在不同的分割區，因為這兩個項目通常一起使用。 此資料分割配置會有額外的好處，移動頻率相當低的資料 (產品名稱、描述和價格) 會和較動態的資料 (存貨量和上一次訂單日期) 分開。 如果移動頻率相當低的資料經常被存取，應用程式會發現在記憶體中快取該資料很有幫助。

另一個此資料分割策略的典型案例是最大化機密資料的安全性。 例如，藉由將信用卡號碼和對應的卡片安全性驗證號碼儲存在個別的分割區。

垂直資料分割也可以減少資料所需的並行存取數量。

> 垂直資料分割都有部分會正規化實體，以從細分的資料存放區中的實體層級 _寬_ 到一組項目 _縮小_ 項目。 在理想的情況下，它適用於 HBase 和 Cassandra 等資料行導向的資料存放區。 如果資料行集合中的資料不太可能變更，您也可以考慮使用 SQL Server 中的資料行存放區。

### 功能資料分割

對於可以在應用程式中為每個不同的商業領域或服務識別繫結內容的系統，功能資料分割提供一種技術，可改善隔離和資料存取效能。 功能資料分割的另一種常用功能為從用於報表用途的唯讀資料將讀寫資料分開。 圖 3 顯示功能資料分割的概觀，清查資料可從客戶的資料分開。

![](media/best-practices-data-partitioning/DataPartitioning03.png)

_圖 3. -功能資料分割資料繫結的內容或子網域_

此資料分割策略可以協助減少跨系統中不同部分的資料存取爭用。

## 設計延展性的分割區

請務必考慮每個分割區的大小和工作負載並加以平衡，使資料分佈以達到最大延展性。 不過，您也必須分割資料，使它不會超過單一資料分割存放區的調整限制。

設計延展性的分割區時，請遵循下列步驟：

1. 分析應用程式以了解資料存取模式，例如每個查詢所傳回的結果集大小、存取的頻率、固有的延遲，以及伺服器端計算處理需求。 在許多情況下，幾個主要實體會要求大部分的處理資源。
2. 根據分析，判斷目前和未來的延展性目標，例如資料大小和工作負載，並將資料跨分割區分佈以符合延展性目標。 在水平資料分割策略中，選擇適當的分區索引鍵，這對確定分佈是否平均很重要。 如需詳細資訊，請參閱 [分區化模式](http://aka.ms/Sharding-Pattern)。
3. 請確定每個分割區的可用資源充足，可處理資料大小和輸送量方面的延展性需求。 例如，裝載於分割區的節點可能會對儲存空間量、處理電源或它所提供的網路頻寬設定硬性限制。 如果資料存放區和處理需求可能超過這些限制，可能必須精簡您的資料分割策略或進一步劃分資料。 例如，延展性的方法之一可能是使用不同的資料存放區以避免整體資料儲存體需求超出節點的調整限制，藉以將記錄資料從核心應用程式功能分開。 如果資料存放區的總數超過節點限制，可能必須使用不同的儲存體節點。
4. 監視使用中的系統來確認資料已如預期般分佈，而且分割區可以處理加諸其上的負載。 這個使用方式可能不符合分析的預期，也就是它可以重新平衡分割區。 如果無法做到，可能必須重新設計系統的某些部分以取得必要的平衡。

請注意，某些雲端環境會根據基礎結構界限配置資源，您應該確定您所選界限的限制可在資料儲存體、處理電源和頻寬等方面，提供足夠的空間給資料量的預期成長。 比方說，如果您使用 Azure 資料表儲存體，忙碌的分區可能需要更多的資源超過可供單一分割區處理要求 (無法在指定的時間內處理的單一資料分割的要求數量限制，請參閱頁面 [Azure 儲存體延展性和效能目標](https://msdn.microsoft.com/library/azure/dn249410.aspx) 如需詳細資訊的 Microsoft 網站上)。 在此情況下，可能需要重新分割分區以分佈負載。 如果這些資料表的總大小或輸送量超過儲存體帳戶的容量，可能必須建立其他儲存體帳戶並且跨帳戶散佈資料表。 如果儲存體帳戶的數目超過訂用帳戶可用的帳戶數目，可能必須使用多個訂用帳戶。

## 設計查詢效能的分割區

使用較小的資料集和平行查詢執行，通常可以提高查詢效能。 每個分割區應包含少數的整體資料集，數量的縮減可以改善查詢效能。 不過，資料分割並不是適當地設計和設定資料庫的替代方式。 例如，如果您使用關聯式資料庫，請確定您已備妥必要的索引。

設計查詢效能的分割區時，請遵循下列步驟：

1. 檢查應用程式的需求以及效能：
    - 使用商務需求來判斷隨時必須快速執行的重要查詢。
    - 監視系統以識別任何執行速度慢的查詢。
    - 建立最常執行的查詢。 每個查詢的單一執行個體可能會有最低的成本，但是資源的累計耗用量卻不少。 它可能有幫於將查詢所擷取的資料分開到不同的分割區或甚至快取。
2. 分割會導致效能變慢的資料。 請確定您：
    - 限制每個分割區的大小，使查詢回應時間在目標內。
    - 以某種方式設計分區索引鍵，在您實作水平資料分割時，讓應用程式可以輕鬆地找到分割區。 這可防止查詢需要掃描每個分割區。
    - 請根據查詢效能考慮分割區的位置。 如果可能，請嘗試將資料保留在地理位置靠近存取它之應用程式和使用者的分割區。
3. 如果實體有輸送量和查詢效能的需求，請根據該實體使用功能資料分割。 如果這樣還是無法滿足需求，請同時套用水平資料分割。 在大部分情況下，單一資料分割策略就足夠了，但在某些情況下，結合這兩種策略會更有效率。
4. 請考慮使用跨分割區平行執行的非同步查詢以改善效能。

## 設計可用性的分割區

分割資料可以確保整個資料集不會構成單一失敗點，而且確保資料集的個別子集可以分開管理，藉以改善應用程式的可用性。 複寫包含重要資料的分割區也可以改善可用性。

設計和實作分割區時，請考慮下列會影響可用性的因素：

- 資料對商務營運的重要性。 某些資料可能包含重要商務資訊，例如發票明細或銀行交易。 其他資料可能只是較不重要的營運資料，例如記錄檔、效能追蹤等等。 識別每一個類型的資料之後，請考慮：
    - 利用適當的備份計劃將重要資料儲存在高度可用的分割區。
    - 為每個資料集的不同嚴重性建立個別的管理和監視機制或程序。 將具有相同層級嚴重性的資料放在相同的分割區，以便它可以利用適當的頻率一併備份。 例如，保留銀行交易資料的分割區必須備份的頻率可能高於保留記錄或追蹤資訊的分割區。
- 個別分割區的管理方式。 將分割區設計為支援獨立管理和維護可提供數個優點。 例如：
    - 如果分割區失敗，可以獨立復原而不會影響在其他分割區中存取資料的應用程式執行個體。
    - 依地理區域分割資料可允許已排程的維護工作在每個位置的離峰時段進行。 請確定分割區不會太大而無法防止任何已規劃的分割區維護在這段期間完成。
- 是否要跨分割區複寫重要資料。 此策略可以改善可用性和效能，不過它也可以導入一致性問題。 在分割區中對資料進行的變更，需要一段時間才能和每個複本同步，在這段期間，不同的分割區會包含不同的資料值。

## 問題和考量

使用資料分割會增加系統設計和開發的複雜度。 即使系統一開始只包含單一分割區，也請務必將資料分割視為系統設計的基本部分。 當系統開始遭遇效能和延展性問題時，將定址資料分割當成備案只會增加複雜性，因為您可能已經有要維護的即時系統。 更新系統以將資料分割納入此環境中，不但需要修改資料存取邏輯，它也可能包含移轉大量現有資料以跨分割區分佈資料，通常會在使用者期望能夠繼續使用系統時發生此情況。

在某些情況下，資料分割並不重要，因為初始資料集很小，而且可以輕鬆地由單一伺服器處理。 對於並不期待調整超出其初始大小的系統而言，這可能是真的，但是許多商務系統都必須能夠在使用者數目增加時擴充。 此擴充通常會伴隨資料量的成長。 您也應該了解資料分割不一定是大型資料存放區的函數。 例如，數百個並行用戶端可能會大量存取一個小型資料存放區。 在此情況下將資料分割可以協助減少爭用並提高輸送量。

當您設計資料分割配置時，您應該考慮下列幾點：

- 盡可能一起保留每個分割區中最常見資料庫作業的資料，以最小化跨分割區資料存取作業。 跨分割區查詢可能比只在單一分割區內查詢更費時，但是最佳化一組查詢的分割區可能會對其他組的查詢造成不良影響。 跨分割區查詢是無法避免的，為了減少查詢時間，請在分割區之間執行平行查詢，並在應用程式內彙總結果。 不過，在某些情況下可能無法使用這種方法，例如必須從查詢取得結果並在下一個查詢使用此結果時。
- 如果查詢利用相當靜態的參考資料，例如郵遞區號資料表或產品清單，請考慮將這項資料複寫到所有分割區，以減少在不同分割區中的個別查閱作業需求。 這個方法也會減少參考資料成為「熱門」資料集，受限於整個系統中的高流量的可能性，不過還是會有與同步處理參考資料的任何變更相關聯的其他成本。
- 請盡可能最小化跨垂直和功能分割區之參考完整性的需求。 在這些配置中，應用程式本身會負責在更新和取用資料時維護跨分割區的參考完整性。 必須跨分割區聯結資料的查詢執行的速度遠低於只在相同分割區內聯結資料的查詢，因為應用程式通常必須根據索引鍵，然後根據外部索引鍵執行連續的查詢。 請改為考慮將相關資料複寫或取消正規化。 為了最小化必須有跨分割區聯結的查詢時間，請在分割區之間執行平行查詢，並在應用程式內聯結資料。
- 請考慮資料分割配置可能會對跨分割區的資料一致性產生的效果。 您應該評估強式一致性是否為實際的需求。 相反地，雲端中的常見方法是實作最終一致性。 每個資料分割中的資料會分別更新，且應用程式邏輯可以負責確保所有更新順利完成—並且在執行最中一致作業時處理查詢資料所引發的不一致。 如需實作最終一致性的詳細資訊，請參閱一致性指引。(#insertlink#)
- 請考慮查詢如何尋找正確的分割區。 如果查詢必須掃描所有分割區來尋找查詢資料，即使使用多個平行查詢，還是會對效能產生嚴重的影響。 搭配垂直和功能資料分割策略使用的查詢可以自然地指定分割區。 不過，使用水平資料分割 (分區化) 時，尋找項目可能很困難，因為每個分區都有相同的結構描述。 典型的分區化解決方案是維護對應，用來查閱特定資料項目的分區位置。 此對應可能會在應用程式的分區化邏輯中實作，或者如果它支援透明的分區化，就會由資料存放區維護。
- 使用水平資料分割策略時，請考慮定期重新平衡分區，以根據大小和工作負載平均分佈資料，進而最小化作用點、最大化查詢效能，並解決實體的儲存體限制。 不過，這是一個複雜的工作，通常需要使用自訂工具或程序。
- 複寫每個分割區可提供額外的保護防止錯誤。 如果單一複本失敗，查詢可以導向至可用的複本。
- 如果您達到資料分割策略的實體限制，您可能必須將延展性擴充至不同的層級。 例如，如果資料分割在資料庫層級，可能表示尋找或複寫多個資料庫中的分割區。 如果資料分割已經在資料庫層級，而實體限制發生問題，可能表示尋找或複寫多個裝載帳戶中的分割區。
- 請避免在多個分割區中存取資料的交易。 某些資料存放區會為了修改資料的作業而實作交易一致性和完整性，但唯有當它位於單一分割區時才如此。 如果您需要跨多個分割區的交易式支援，您可能必須實作此支援做為應用程式邏輯的一部分，因為大部分的資料分割系統不會提供原生支援。

所有資料存放區都需要某些作業管理和監視活動。 工作的範圍可包含載入資料、備份和還原資料、重新組織資料，以及確保系統正確、有效率地執行。

請考慮下列會影響作業管理的因素：

- 請考慮分割資料時如何實作適當的管理和作業工作，例如備份與還原、封存資料，監視系統，以及其他系統管理工作。 例如，在備份和還原作業期間維護邏輯一致性是一項挑戰。
- 資料如何載入到多個分割區，以及如合新增來自其他來源的新資料。 某些工具和公用程式可能不支援分區化資料作業，例如將資料載入正確的分割區，因此可能需要建立或取得新的工具和公用程式。
- 如何定期 (也許是每月) 封存及刪除資料以防止分割區的過度成長。 可能需要將資料轉換以符合不同的封存結構描述。
- 請考慮執行定期的程序以尋找任何資料完整性的問題，例如一個分割區的資料參考另一個分割區的資訊，但是這項資訊遺失。 此程序可嘗試自動修正這些問題，或向操作人員引發警示以手動修正問題。 例如，在電子商務應用程式中，訂單資訊可能會保留在一個分割區中，但是構成每張訂單的行項目可能會保留在另一個。 下訂單的程序一定會新增資料並造成分割區的麻煩。 如果此程序失敗，就會儲存沒有對應訂單的行項目。

不同的資料儲存技術通常會提供自己的功能以支援資料分割。 下列各節將扼要說明 Azure 應用程式常用之資料存放區所實作的選項，並描述設計可以善用這些功能之應用程式的考量。

## Azure SQL Database 的資料分割策略。

Azure SQL Database 是在雲端中執行的關聯式資料庫即服務。 它是以 Microsoft SQL Server 為基礎。 關聯式資料庫會將資訊區分為資料表，而且每個資料表會保留以實體做為一系列資料列的相關資訊。 每個資料列包含的資料行都會為實體的個別欄位保留資料。  [Azure SQL Database](https://msdn.microsoft.com/library/azure/ee336279.aspx) Microsoft 網站上的頁面會提供詳細的文件上建立及使用 SQL 資料庫。

## 利用 Elastic Scale 的水平資料分割

單一 SQL 資料庫會對其包含的資料之資料行有所限制，而輸送量會受到結構性因素和其支援之並行連線數目的限制。 Azure SQL Database 提供 Elastic Scale，以支援 SQL 資料庫的水平縮放。 使用 Elastic Scale，您可以將資料分割成分佈到多個 SQL 資料庫的分區，而且您可以因為您需要處理的資料量成長和縮減而新增或移除分區。 使用 Elastic Scale 也有助於跨資料庫分佈負載以減少爭用。

> [AZURE.NOTE] Elastic Scale 目前為預覽自 2015 年 1 月起。 它是將淘汰的 Azure SQL Database 同盟的替代品。 現有的 Azure SQL Database 同盟安裝可以使用移轉至 Elastic Scale [同盟移轉公用程式](https://code.msdn.microsoft.com/vstudio/Federations-Migration-ce61e9c1)。 或者，如果您的案例本身無法適用 Elastic Scale 提供的功能，您可以實作自己的分區化機制。

每個分區都被實作成 SQL 資料庫。 分區可以保留多個資料集 (稱為 _shardlet_)，而且每個資料庫會維護描述其所包含之 shardlet 的中繼資料。 shardlet 可以是單一資料項目，或一組共用相同 shardlet 索引鍵的項目。 例如，如果您在多租用戶應用程式中分區化資料，shardlet 索引鍵可能是租用戶識別碼，而給定租用戶的所有資料都會保留做為相同 shardlet 的一部分。 其他租用戶的資料會保留在不同的 shardlet。

設計人員的責任是建立資料集和 shardlet 索引鍵之間的關聯。 個別的 SQL 資料庫做為包含資料庫 (分區) 清單 (由整個系統和每個資料庫中 shardlet 的相關資訊組程) 的全域分區對應管理員。 存取資料的用戶端應用程式會先連接至全域分區對應管理員資料庫，以取得其在本機快取的分區對應複本 (列出分區和 shardlet)。 應用程式會接著使用這項資訊，將資料要求路由傳送至適當的分區。 這項功能隱藏在一系列的 API (包含在 Azure SQL Database Elastic Scale 用戶端程式庫中) 之後，可做為 NuGet 封裝使用。 頁面 [Azure SQL Database Elastic Scale 概觀](sql-database-elastic-scale-introduction.md) Microsoft 網站提供更全面性的 Elastic Scale 介紹。

> [AZURE.NOTE] 您可以複寫全域分區對應管理員資料庫，以減少延遲並改善可用性。 如果您使用其中一個進階定價層實作資料庫，您可以設定作用中的異地複寫以持續將資料複製到不同區域中的資料庫。 在使用者以其為基礎的每個區域中建立資料庫的複本，並將您的應用程式設為連接到這個複本以取得此分區對應。

> 替代方法是使用 Azure SQL 資料同步或 Azure Data Factory 管線來跨區域複寫分區對應管理員資料庫。 這種形式的複寫會定期執行，如果分區對應不常變更就更適合。 此外，分區對應管理員資料庫不一定要由進階定價層級建立。

Elastic Scale 提供將資料對應到 shardlet 並將它們儲存在分區中的兩個配置：

- 清單分區對應描述單一索引鍵和 shardlet 之間的關聯。 例如，在多租用戶系統中，每個租用戶的資料可以和唯一的索引鍵相關聯，並儲存在自己的 shardlet 中。 若要確保隱私權和隔離 (防止租用戶耗盡其他租用戶可使用的資料儲存體資源)，每個 shardlet 都可以保留在自己的分區內。

![](media/best-practices-data-partitioning/PointShardlet.png)

_圖 4. -使用清單分區對應將租用戶資料儲存在個別分區_

- 範圍分區對應描述一組連續索引鍵值和 shardlet 之間的關聯。 在先前所述的多租用戶範例中，有個實作專用 shardlet 的替代方案，就是您可以將資料分組成相同 shardlet 之內的一組租用戶 (各有自己的索引鍵)。 此配置的成本低於第一個配置 (租用戶共用資料儲存體資源)，但是要承擔資料隱私權和隔離降低的風險。

![](media/best-practices-data-partitioning/RangeShardlet.png)

_圖 5. -使用範圍分區對應來儲存分區中租用戶範圍的資料_

請注意，單一分區可以包含數個 shardlet 的資料。 例如，您可以使用清單 shardlet 將不同非連續租用戶的資料儲存在相同的分區中。 您也可以混合相同分區中的範圍 shardlet 和清單 shardlet，雖然它們會透過全域分區對應管理員資料庫中的不同對應定址 (全域分區對應管理員資料庫可以包含多個分區對應)。 圖 6 說名這種方法。

![](media/best-practices-data-partitioning/MultipleShardMaps.png)

_圖 6. 實作多個分區對應_

您實作的資料分割配置和系統效能有明顯的關係，也會影響必須新增或移除分區的速率，或者或跨分區重新分割的資料。 使用 Elastic Scale 分割資料時，您應該考慮下列幾點：

- 將一起使用的資料分組到同一個分區，並避免必須存取保留在多個分區之資料的作業。 請記住，有了 Elastic Scale，分區本身就是 SQL 資料庫，而 Azure SQL Database 不支援跨資料庫聯結；這些作業必須在用戶端上執行。 也請記住，有了 Azure SQL Database，參考完整性條件約束、觸發程序和資料庫中的預存程序都無法參考另一個資料庫中的物件，所以請不要設計在分區之間具有相依性的系統。 不過，SQL 資料庫可包含資料表 (保留查詢和其他作業常用的參考資料副本)，而且這些資料表並不一定屬於任何特定 shardlet。 跨分區複寫此資料可以協助移除聯結跨越資料庫之資料的需要。 在理想的情況下，這類資料應該是靜態或緩慢移動的，才能最小化複寫工作量並降低它陳舊的機會。

    > [AZURE.NOTE] 雖然 Azure SQL Database 不支援跨資料庫聯結，Elastic Scale API 可讓您執行可無障礙地逐一查看資料保留在分區對應所參考的所有 shardlet 的跨分區查詢。 Elastic Scale API 會將跨分區查詢切分成一連串的個別查詢 (每個資料庫都有一個)，然後再將結果合併在一起。 如需詳細資訊，請參閱 [多分區查詢](sql-database-elastic-scale-multishard-querying.md) Microsoft 網站上的頁面。

- 儲存在屬於 相同分區對應之 shardlet 中的資料應該具有相同的結構描述。 例如，建立的清單分區對應不會指向包含租用戶資料的某些 shardlet 和其他包含產品資訊的 shardlet。 此規則不會由 Elastic Scale 強制執行，但如果每個 shardlet 都具有不同的結構描述，資料管理和查詢會變得非常複雜。 在剛才提及的範例中，您應該建立兩個清單分區對應。一個參考租用戶資料而另一個指向產品資訊。 請記住，屬於不同 shardlet 的資料可以儲存在相同的分區中。

    > [AZURE.NOTE] Elastic Scale API 的跨分區查詢功能取決於每個 shardlet 在分區對應包含相同的結構描述中。
- 只有保留在相同分區內的資料支援交易式作業，跨分區並不支援。 交易可以跨越 shardlet，只要它們是相同分區的一部分。 因此，如果您的商務邏輯需要執行交易，請將受影響的資料儲存在相同的分區，或實作最終一致性。 如需詳細資訊，請參閱資料一致性指引。
- 將分區放置於在分區 (異地尋找地區) 中存取資料之使用者的附近。 此策略有助於減少延遲。
- 避免混合高度作用中 (作用點) 和相對非使用中的分區。 請嘗試並跨分區平均分散負載。 這可能需要雜湊 shardlet 索引鍵。
- 如果您是地理尋找分區，請確定雜湊索引鍵對應的 shardlet 保留在分區中 (這些分區儲存在存取該資料的使用者附近)。
- 目前，只有有限的 SQL 資料類型支援做為 shardlet 索引鍵; _int、 bigint、 varbinary_ 和 _uniqueidentifier_。 SQL _int_ 和 _bigint_ 類型會對應至 _int_ 和 _長_ C# 中的資料類型和具有相同的範圍。 SQL _varbinary_ 會處理類型，請使用 _位元組_ 陣列在 C# 和 SQL _uniqueidentier_ 型別對應到 _Guid_ .NET Framework 中的類別。

正如其名，Elastic Scale 可在資料數量縮小和成長時，讓系統新增及移除分區。 Azure SQL Database Elastic Scale 用戶端程式庫中的 API 會讓應用程式以動態方式建立和刪除分區 (並且無障礙地更新分區對應管理員)，但移除分區是破壞性的作業，也需要刪除該分區中的所有資料。 如果應用程式必須將一個分區劃分成兩個個別的分區或將分區結合在一起，Elastic Scale 提供個別的劃分/合併服務。 此服務會在雲端裝載的服務中 (開發人員必須建立此雲端裝載服務) 執行，而且會負責安全地在分區之間移轉資料。 如需詳細資訊，請參閱主題 [使用 Elastic Scale 分割及合併](sql-database-elastic-scale-overview-split-and-merge.md) Microsoft 網站上。

## Azure 儲存體的資料分割策略

Azure 儲存體提供管理資料的三個抽象概念：

- 資料表儲存體，實作可調整的結構儲存體。 資料表包含實體集合，每一個集合都可以包含一組屬性和值。
- Blob 儲存體，提供大型物件和檔案的儲存體。
- 儲存體佇列，支援應用程式之間可靠的非同步傳訊。

資料表儲存體和 Blob 儲存體基本上是索引鍵-值存放區，可最佳化以分別保留結構化和非結構化資料。 儲存體佇列提供用來建置鬆散結合且可擴充之應用程式的機制。 資料表儲存體、Blob 儲存體和儲存體佇列會建立在 Azure 儲存體帳戶的內容中。 Azure 儲存體帳戶可支援三種形式的備援：

- 本地備援儲存體，可維護單一資料中心內的三個資料複本。 這種形式的備援可防止硬體錯誤，但無法防止涉及整個資料中心的災害。
- 區域備援儲存體，可維護在相同區域內跨不同資料中心散佈的三個資料複本 (或跨兩個地理位置相近的區域)。 這種形式的備援可以防止在單一資料中心內發生的災害，但無法防止會影響整個區域的大規模網路中斷連線。 請注意區域備援儲存體目前僅供區塊 blob 使用。
- 異地備援儲存體，可維護六個資料複本。三個複本在中一個區域中 (所在地區)，另外三個複本在遠端區域中。 這種形式的備援提供最高層級的災害防護。

Microsoft 已發行 Azure 儲存體帳戶; 的延展性的目標請參閱頁面 [Azure 儲存體延展性和效能目標](https://msdn.microsoft.com/library/azure/dn249410.aspx) Microsoft 網站上。 目前，總儲存體帳戶容量 (保留在資料表儲存體、blob 儲存體中的資料大小和保留在儲存體佇列中的未處理訊息的大小) 不能超過 500TB。 要求速率上限 (假設為 1KB 實體、blob 或訊息大小) 是每秒 20K。 如果您的系統可能會超過這些限制，請考慮跨多個儲存體帳戶分割負載；單一 Azure 訂用帳戶可以建立高達 100 個儲存體帳戶。 不過，請注意這些限制會隨著時間變更。

## 分割 Azure 資料表儲存體

Azure 資料表儲存體是已儲存的索引鍵/值，專為資料分割設計。 所有實體都會儲存在分割區中，而且分割區會在內部由 Azure 資料表儲存體管理。 儲存在資料表中的每個實體都必須提供兩個部分的索引鍵，其組成為：

- 資料分割 索引鍵。 這是字串值，可決定 Azure 資料表儲存體將在哪個分割區中放置實體。 具有相同資料分割 索引鍵的所有實體將會儲存在相同分割區上。
- 資料列索引鍵。 這是另一個字串值，會識別分割區內的實體。 在一個分割區內的所有實體都會由此索引鍵依照語彙以遞增順序排列。 資料分割 索引鍵/資料列索引鍵組合對每個實體必須是唯一的，且長度不能超過 1KB。

實體資料的其餘部分由應用程式定義的欄位組成。 沒有特定的結構描述會強制執行，而且每個資料列可以包含一組不同的應用程式定義欄位。 唯一的限制是實體的大小上限 (包括分割區和資料列索引鍵) 目前為 1MB。 資料表的大小上限為 200TB，，不過這些數字可能會在未來變更 (請檢查頁面 [Azure 儲存體延展性和效能目標](https://msdn.microsoft.com/library/azure/dn249410.aspx) 如需有關這些限制的最新的 Microsoft 網站上。 如果您嘗試儲存的實體超過這個容量，請考慮將它們劃分成多個資料表。使用垂直資料分割，並將欄位區分成最有可能一起存取的群組。

圖 7 顯示虛構電子商務應用程式之範例儲存體帳戶 (Contoso 資料) 的邏輯結構。 儲存體帳戶包含三個資料表 (客戶資訊、產品資訊和訂單資訊)，而且每個資料表都有多個分割區。 在客戶資訊資料表中，資料是根據客戶所在的城市進行分割，而資料列索引鍵包含客戶識別碼。 在產品資訊資料表中，產品依據產品類別進行分割，而資料列索引鍵包含產品號碼。 在訂單資訊資料表中，訂單依據撰寫的日期進行分割，且資料列索引鍵則指定接收訂單的時間。 請注意，所有資料都會依據資料列索引鍵在每個分割區中排序。

![](media/best-practices-data-partitioning/TableStorage.png)

_圖 7. -資料表和範例儲存體帳戶中的資料分割_

> [AZURE.NOTE] Azure 資料表儲存體也會將時間戳記欄位加入至每個實體。 時間戳記欄位由資料表儲存體維護，而且會在每次修改實體並寫回分割區時更新。 資料表儲存體服務會使用此欄位來實作開放式並行存取 (每次應用程式將實體寫回資料表儲存體時，資料表儲存體服務會比較正在實體中寫入的時間戳記值和保留在資料表儲存體中的值，如果兩者不同，另一個應用程式必須已修改此實體，因為已擷取該實體且寫入作業失敗)。 您不應該以自己的程式碼修改此欄位，也不應該在建立新實體時指定此欄位的值。

Azure 資料表儲存體使用資料分割索引鍵來決定如何儲存資料。 如果實體已利用先前未使用的資料分割索引鍵新增至資料表，Azure 資料表儲存體就會為此實體建立新的分割區。 具有相同資料分割索引鍵的其他實體將會儲存在相同分割區中。 這項機制會有效地實作自動化的向外延展策略。 每個分割區將會儲存在 Azure 資料中心中的單一伺服器上 (以協助確保從單一分割區中擷取資料的查詢可以快速執行)，但是不同的分割區可以跨多部伺服器分佈。 此外，如果這些分割區的大小受限，單一伺服器可以裝載多個分割區。

當您設計 Azure 資料表儲存體的實體時，您應該考慮下列幾點：

- 驅動選取資料分割索引鍵與資料列索引鍵值的方法應該和存取資料的方法一致。 您應該選擇資料分割索引鍵/資料列索引鍵組合，以支援大多數的查詢。 最有效率的查詢會藉由指定資料分割索引鍵和資料列索引鍵來擷取資料。 掃描單一分割區可以滿足指定資料分割索引鍵和資料列索引鍵範圍的查詢。這是相當快速的方法，因為資料會以資料列索引鍵的順序保留。 未指定資料分割索引鍵的查詢可能需要 Azure 資料表儲存體掃描資料的每個分割區。

    > [AZURE.TIP] 如果實體有一個自然索引鍵，然後使用它做為資料分割索引鍵，並指定空字串做為資料列索引鍵。 如果實體具有包含兩個屬性的複合索引鍵，選取最慢的變更中屬性做為資料分割索引鍵，另一個則做為資料列索引鍵。 如果實體有兩個以上的索引鍵屬性，使用屬性的串連來提供資料分割和資料列索引鍵。

- 如果您定期執行查詢，查詢中使用欄位以外的磁碟分割和資料列索引鍵的資料，請考慮實作 [索引資料表模式](https://msdn.microsoft.com/library/dn589791.aspx)。
- 如果您使用單調增加或減少數列 (例如 "0001"、"0002"、"0003"...) 產生資料分割索引鍵，而每個分割區只包含有限的資料數量，那麼 Azure 資料表儲存體可能會實際將相同伺服器上的這些分割區分組在一起。 這個機制假設應用程式很有可能在連續範圍的分割區中執行查詢 (範圍查詢)，並已針對此情況進行最佳化。 不過，這種方法可能會導致著重單一伺服器的作用點，因為新實體的所有插入可能會集中在連續範圍的其中一端。 它也會降低延展性。 若要跨伺服器更平均分佈負載，請考慮雜湊資料分割索引鍵，使順序更加隨機。
- Azure 資料表儲存體支援屬於相同分割區之實體的交易式作業。 這表示應用程式可以執行多個插入、更新、刪除、取代或合併作業以做為不可部分完成的單位 (條件是交易不可包含 100 個以上的實體，且要求承載大小不可超過 4MB)。 跨越多個分割區的作業不是交易式，而且可能需要您實作最終一致性，如同資料一致性指引所述。 如需有關資料表儲存體和交易的詳細資訊，請瀏覽 [執行實體群組交易](https://msdn.microsoft.com/library/azure/dd894038.aspx) Microsoft 網站上的頁面。
- 請特別注意資料分割索引鍵的粒度：
    - 對每個實體使用相同的資料分割索引鍵，會使資料表儲存體服務建立保留在一部伺服器上的單一大型分割區，可防止它向外延展，並改為將負載焦點放在單一伺服器上。 如此一來，這個方法只適用於管理少數實體的系統。 不過，這個方法確實能確保所有實體都可以參與實體群組交易。
    - 對每個實體使用唯一的資料分割索引鍵，會使資料表儲存體服務未每個實體建立不同的分割區，可能會導致大量的小型分割區 (取決於實體的大小)。 這種方法比使用單一資料分割索引鍵更具延展性，但是無法進行實體群組交易，且擷取多個實體的查詢可能會牽涉到讀取多部伺服器。 不過，如果應用程式執行範圍查詢，使用單調數列產生資料分割索引鍵可能有助於最佳化這些查詢。
    - 跨實體的子集共用資料分割索引鍵可讓您將相同分割區中的相關實體分組。 涉及使用實體群組交易執行之相關實體的作業，以及擷取一組相關實體的查詢，可能藉由存取單一伺服器即可滿足。

如需有關如何在 Azure 資料表儲存體中分割資料的詳細資訊，請參閱文章 [Azure 資料表儲存體設計可擴充的資料分割策略](https://msdn.microsoft.com/library/azure/hh508997.aspx) Microsoft 網站上。

## 分割 Azure blob 儲存體

Azure Blob 儲存體可讓您保留大型二進位物件，目前高達 200GB 的區塊 blob 或 1TB 的分頁 blob (最新的資訊，請造訪 [Azure 儲存體延展性和效能目標](https://msdn.microsoft.com/library/azure/dn249410.aspx) Microsoft 網站上的網頁)。 在案例中使用區塊 blob，例如您必須在其中快速上傳或下載大量資料的資料流。 對需要隨機而不是序列存取部分資料的應用程式使用分頁 blob。

每個 blob (區塊或分頁) 會保留在 Azure 儲存體帳戶中的容器中。 您可以使用容器來分組一同具有相同安全性需求的相關 blob，雖然這個分組是邏輯性的，而不是實體的。 在容器內，每個 blob 都有唯一的名稱。

Blob 儲存體會根據 blob 名稱自動分割。 每個 blob 會保留在自己的分割區中，而且相同容器中的 blob 不會共用分割區。 此架構可讓 Azure blob 儲存體無障礙地跨伺服器平衡負載，因為相同容器中的不同 blob 可能會跨不同的伺服器分佈。

寫入單一區塊 (區塊 blob) 或分頁 (分頁 blob) 的動作是不可部分完成的，但跨越區塊、分頁或 blob 的作業卻不是。 如果您必須在跨區塊、分頁和 blob 寫入作業時確保一致性，您必須使用 blob 租用執行寫入鎖定。

Azure blob 儲存體支援高達每秒 60MB 的傳輸速率或每個 blob 每秒 500 個要求。 如果您預期會超過這些限制，而且 blob 資料相當靜態，請考慮使用 Azure 內容傳遞網路 (CDN) 複寫 blob。 如需詳細資訊，請參閱頁面 [使用 Azure 的 CDN](cdn-how-to-use.md) Microsoft 網站上。 如需其他指引和考量，請參閱內容傳遞網路 (CDN) 一文。

## 分割 Azure 儲存體佇列

Azure 儲存體佇列可讓您實作程序之間的非同步傳訊。 Azure 儲存體帳戶可以包含任意數目的佇列，而每個佇列可以包含任意數目的訊息。 唯一的限制是儲存體帳戶中的可用空間。 個別訊息的大小上限是 64KB。 如果您需要比這個限制更大的訊息，請考慮改用 Azure 服務匯流排佇列。

每個儲存體佇列在其所屬的儲存體帳戶內都有唯一的名稱。 Azure 會根據名稱分割佇列，而同一個佇列的所有訊息都會儲存在相同的分割區中，由單一伺服器所控制。 不同的佇列可以由不同的伺服器管理，以協助平衡負載。 伺服器的佇列配置對應用程式和使用者而言是透明的。 在大規模應用程式中，請勿將相同的儲存體佇列用於應用程式的所有執行個體，因為這個方法可能會使裝載佇列的伺服器成為作用點；請將不同的佇列用於應用程式的不同功能區域。 Azure 儲存體佇列不支援交易，因此將訊息導向到不同的佇列，對傳訊一致性的影響應該不大。

Azure 儲存體佇列每秒可處理高達 2000 個訊息。  如果您必須以更高的速率處理訊息，請考慮建立多個佇列。 例如，在全域應用程式中的個別儲存體帳戶建立個別儲存體佇列，以處理在每個區域中執行的應用程式執行個體。

## Azure 服務匯流排的資料分割策略

Azure 服務匯流排使用訊息代理人處理傳送至服務匯流排佇列或主題的訊息。 根據預設，所有傳送至佇列或主題的訊息都由相同的訊息代理人程序處理。 此架構可限制訊息佇列的整體輸送量。 不過，您也可以分割佇列或主題時就會建立設定 _EnablePartitioning_ 佇列或主題描述的屬性 _true_。 分割的佇列或主題會區分成多個片段，每個片段都會受到個別訊息存放區和訊息代理人的支援。 服務匯流排會負責建立和管理這些片段。 當應用程式張貼訊息至分割的佇列或主題時，服務匯流排會將訊息指派給該佇列或主題的片段。 當應用程式從佇列或訂用帳戶接收到訊息時，服務匯流排會檢查每個片段是否有下一個可用的訊息，然後將它傳遞給應用程式進行處理。 這種結構有助於跨訊息代理人和訊息存放區分佈負載，提高延展性和改善可用性。如果有一個片段的訊息代理人或訊息存放區暫時無法使用，服務匯流排可以從其中一個剩餘的可用片段擷取訊息。

服務匯流排會指派訊息給片段，如下所示：

- 如果訊息屬於工作階段中，具有 _ SessionId_ 屬性的相同值的所有訊息會都傳送至相同的片段。
- 如果訊息不屬於工作階段，但寄件者已指定的值 _PartitionKey_ 屬性，則具有相同的所有訊息 _PartitionKey_ 值都會傳送至相同的片段。

    > [AZURE.NOTE] 如果 _SessionId_ 和 _PartitionKey_ 同時指定屬性，則必須將相同的值則會拒絕訊息。
- 如果 _SessionId_ 和 _PartitionKey_ 未指定訊息的屬性，但已啟用重複偵測， _MessageId_ 屬性可用。 具有相同的所有訊息 _MessageId_ 會被導向至相同的片段。
- 如果訊息不包含 _SessionId、 PartitionKey_ 或 _MessageId_ 屬性，則服務匯流排會指派訊息給片段以循環配置資源的方式。 如果片段無法使用，服務匯流排會移至下一個片段。 如此一來，傳訊基礎結構中的暫時錯誤不會造成訊息傳送作業失敗。

決定如何 (或者是否) 分割服務匯流排訊息佇列或主題時，您應該考慮下列各點：

- 服務匯流排佇列和主題都會在服務匯流排命名空間的範圍內建立。 服務匯流排目前每個命名空間允許最多 100 個分割佇列或主題。
- 每個服務匯流排命名空間都會制定可用資源的配額，例如每個主題的訂用帳戶數目、每秒同時傳送和接收要求的數目，以及可建立之並行連接的最大數目。 這些配額會記錄在頁面上的 Microsoft 網站上 [服務匯流排配額](https://msdn.microsoft.com/library/azure/ee732538.aspx)。 如果您預期超過這些值，請建立其他具有佇列和主題的命名空間，並跨這些命名空間分佈工作。 例如，在全域應用程式中的每個區域建立不同的命名空間，並設定應用程式執行個體使用最接近命名空間中的佇列和主題。
- 傳送做為交易一部分的訊息必須指定資料分割索引鍵。 這可以是 _SessionId、 PartitionKey_ 或 _MessageId_。 傳送做為相同交易一部分的所有訊息必須指定相同的資料分割索引鍵，因為它們必須由相同的訊息代理人程序加以處理。 您無法在相同的交易內傳送訊息至不同的佇列或主題。
- 您無法將分割的佇列或主題設定為閒置狀態時自動刪除。
- 如果您要建置跨平台或混合式解決方案，您目前無法將分割的佇列和主題與進階訊息佇列通訊協定 (AMQP) 搭配使用。

## Azure DocumentDB 的資料分割策略

Azure DocumentDB 是一種可以儲存文件的 NoSQL 資料庫。 DocumentDB 中的文件是物件或其他資料片段的 JSON 序列化表示。 沒有固定的結構描述會強制執行，但是每個文件都必須包含唯一識別碼。

文件會組織成集合。 集合可讓您將相關文件分組在一起。 例如，在維護部落格文章的系統中，您可以將每篇部落格文章的內容儲存為一個集合中的文件，並建立每個主體類型的集合。 或者，在多租用戶應用程式中 (例如可讓不同作者控制和管理自己的部落格文章的系統)，您可以根據作者分割部落格，並且為每位作者建立個別的集合。 配置給集合的儲存體空間非常有彈性，而且可以依需要縮小或成長。

文件集合會提供自然的機制，在單一資料庫內分割資料。 在內部，DocumentDB 資料庫可以跨越多部伺服器，而且 DocumentDB 可能會嘗試跨伺服器分佈集合以分散負載。 實作分區化最簡單的方法是建立每個分區的集合。

> [AZURE.NOTE] 每個 DocumentDB 會配置資源的 _效能層級_。 效能層級是使用與相關聯 _要求單位_ (RU) 費率限制。 RU 速率限制會指定要為該集合保留，且可供該集合獨佔使用的資源量。 集合的成本取決於為集合選取的效能層級；效能層級 (和 RU 速率限制) 愈高，費用也愈高。 您可以使用 Azure 管理入口網站來調整集合的效能層級。 如需詳細資訊，請參閱頁面 [DocumentDB 中的效能層級](documentdb-performance-levels.md) Microsoft 網站上。

所有資料庫都要建立在 DocumentDB 帳戶的內容中。 單一 DocumentDB 帳戶可以包含多個資料庫，並指定資料庫要在哪些區域中建立。 每個 DocumentDB 帳戶也會強制執行它自己的存取控制。 您可以使用 DocumentDB 帳戶異地尋找靠近需要存取帳戶之使用者的地區 (資料庫內的集合)，並強制執行限制，以便只讓使用者和它們連接。

每個 DocumentDB 帳戶都有配額，可限制其包含的資料庫和集合數目，以及可用的文件儲存體數量。 這些限制可能會變更，但在頁面上說明 [DocumentDB 限制和配額](documentdb-limits.md) Microsoft 網站上。 如果您實作一個系統，其中所有分區都屬於相同的資料庫，就有可能達到帳戶的儲存體容量限制，這在理論上是有可能的。 在此情況下，您可能必須建立其他 DocumentDB 帳戶和資料庫，並跨資料庫分佈分區。 不過，即使您不太可能叫用資料庫的儲存體容量，使用多個資料庫的原因是每個資料庫都有自己的使用者和權限集。 您可以使用這項機制在每個資料庫上隔離集合的存取權。

圖 8 說明 DocumentDB 架構的高階結構。

![](media/best-practices-data-partitioning/DocumentDBStructure.png)

_圖 8. -DocumentDB 的結構_

用戶端應用程式的責任是將要求導向到適當的分區，通常是藉由實作其本身的對應機制，以定義分區索引鍵的某些資料屬性為基礎。 圖 9 顯示兩個 DocumentDB 資料庫，每一個都會包含兩個集合做為分區。 資料由租用戶識別碼分區化，並包含特定租用戶的資料。 資料庫會建立在個別的 DocumenDB 帳戶中，帳戶位於和租用戶 (其資料包含在帳戶中) 相同的區域中。 用戶端應用程式中的路由邏輯會使用租用戶識別碼做為分區索引鍵。

![](media/best-practices-data-partitioning/DocumentDBPartitions.png)

_圖 9. -使用實作分區化 Azure DocumentDB_

決定如何利用 DocumentDB 分割資料時，您應該考慮下列幾點：

- DocumentDB 資料庫的可用資源受限於 DocumentDB 帳戶的配額限制。 每個資料庫可以保留許多集合 (同樣地，有其限制)，每個集合都和控管該集合 RU 速率限制 (保留的輸送量) 的效能層級相關聯。 如需詳細資訊，請瀏覽 [DocumentDB 限制和配額](documentdb-limits.md) Microsoft 網站上的頁面。
- 每份文件都必須具有一個屬性，可以用來在保留該文件之集合內唯一識別該文件。 這和定義文件要保留在哪個集合的分區索引鍵不同。 集合可以包含大量的文件，理論上只受限於文件識別碼的最大長度。 文件識別碼可多達 255 個字元。
- 針對文件的所有作業都會在交易的內容中執行，而交易範圍則是包含該文件的集合。 如果作業失敗，會復原已執行的工作。  當文件由一項作業掌控時，所做的任何變更都會受限於快照集層級隔離。 例如，如果要建立新文件的要求失敗，這項機制可確保另一個同時查詢資料庫的使用者不會看到當時移除的部分文件。
- DocumentDB 查詢的範圍也只限於集合層級。 單一查詢只能從一個集合擷取資料。 如果您必須從多個集合中擷取資料，您必須個別查詢每個集合，並以應用程式代碼合併結果。
- DocumentDB 支援所有可和文件一起儲存在集合中的可程式化項目：預存程序、使用者定義函式和觸發程序 (以 JavaScript 撰寫)。 這些項目可以在相同的集合內存取任何文件。 此外，這些項目會在環境交易的範圍內執行 (如果是針對文件執行之建立、刪除或取代作業的結果引發了觸發程序)，或啟動新的交易 (如果是明確的用戶端要求結果做為執行的預存程序)。 如果可程式化項目中的程式碼擲回例外狀況，交易就會復原。 您可以使用預存程序和觸發程序來維護文件之間的完整性和一致性，但這些文件都必須屬於相同的集合。
- 您應該確定您想要在 DocumentDB 帳戶的資料庫中保留的集合都不太可能超過集合的效能層級所定義的輸送量限制。 這些限制會描述在 [DocumentDB 容量需求](documentdb-manage.md) Microsoft 網站上的頁面。 如果您預期會達到這些限制，請考慮在不同的 DocumentDB 帳戶中跨資料庫劃分集合，以減少每個集合的負載。

## Azure 搜尋服務的資料分割策略

搜尋資料的功能通常是許多 web 應用程式提供的主要導覽及探索方法，讓使用者可以快速根據搜尋準則的組合尋找資源 (例如，電子商務應用程式中的產品)。 Azure 搜尋服務提供 web 內容上的全文檢索搜尋功能，並包括預先輸入、根據鄰近符合項目建議查詢，以及多面向導覽等功能。 這些功能的完整描述可用於 [Azure 搜尋服務概觀](https://msdn.microsoft.com/library/azure/dn798933.aspx) Microsoft 網站上的頁面。

Search 服務會將可搜尋的內容儲存為資料庫中的 JSON 文件。 您定義的索引可以在這些文件中指定可搜尋的欄位，並提供這些定義給 Search 服務。 當使用者提交搜尋要求時，Search 服務會使用適當的索引來尋找符合的項目。

為了減少爭用，Search 服務所使用的儲存體可以區分成 1、2、3、4、6 或 12 個分割區，且每個分割區可以複寫高達 6 次。 資料分割數乘以複本數目的數字的乘積稱為 _搜尋單位_ (SU)。 Search 服務的單一執行個體可以包含最多 36 個 SU (具有 12 個分割區的資料庫只支援最多 3 個複本)。 您需要支付配置給服務的每個 SU。 當可搜尋的內容數量增加或搜尋要求的速率成長時，您可以將 SU 新增到 Search 服務的現有執行個體來處理額外的負載。 Search 服務本身負責跨分割區平均分佈文件，而且目前不支援任何手動資料分割策略。

每個分割區可以包含最多 1500 萬個文件或佔用 300GB 的儲存空間 (取兩者中較低者，視文件和索引的大小而定)。 您最多可以建立 50 個索引。 服務的效能會因文件的複雜性、可用的索引，以及網路延遲的影響而有所不同。 雖然您應該利用自己的資料執行效能評比，以取得更精確的輸送量量值，但是平均而言，單一複本 (1SU) 的處理速度應該是每秒 15 筆查詢 (QPS)。 如需詳細資訊，請參閱 [限制和條件約束 (Azure 搜尋服務 API)]( https://msdn.microsoft.com/library/azure/dn798934.aspx) Microsoft 網站上的頁面。

> [AZURE.NOTE] 您可以儲存一組有限的資料型別中可搜尋的文件。字串、 布林、 數字資料、 日期時間資料和一些地理資料。 如需詳細資訊，請參閱 [支援的資料類型 (Azure 搜尋服務)]( https://msdn.microsoft.com/library/azure/dn798938.aspx) Microsoft 網站上的頁面。

針對 Azure 搜尋服務如何分割每個服務執行個體的資料，您具有有限的控制權。 不過，在全域環境中您可能可以改善效能並減少延遲和競爭進一步分割服務本身使用下列策略之一:

- 在每個地理區域中，建立 Search 服務的執行個體，並確定用戶端應用程式會導向至最接近的可用執行個體。 此策略需要可搜尋內容的任何更新，可跨服務的所有執行個體即時複寫。
- 建立兩層的 Search 服務；一層是每個區域中的本機服務，包含使用者在該區域中最常存取的資料，一層是全域服務，包含所有資料。 使用者可以將要求導向至本機服務 (適用於快速而有限的結果) 或全域服務 (適用於較慢，但更完整的結果)。 當搜尋的資料中有重大的區域性變化時，最適用這個方法。

## Azure Redis Cache 的資料分割策略

Azure Redis Cache 在雲端中提供以 Redis 索引鍵/值資料存放區為基礎的共用快取服務。 正如其名，Azure Redis Cache 的目的是做為快取解決方案，因此應該只用於保留暫時性資料，而不是做為永久的資料存放區。如果快取無法使用，使用 Azure Redis Cache 的應用程式應該能夠繼續運作。 Azure Redis Cache 支援主要/次要複寫以提供高可用性，但目前的快取大小上限為 53GB。 如果您需要更多的空間，您必須建立其他快取。 如需詳細資訊，請造訪 [Microsoft Azure 快取](http://azure.microsoft.com/services/cache/) Microsoft 網站上的頁面。

分割 Redis 資料存放區包含跨 Redis 服務的執行個體劃分資料。 每個執行個體都會構成單一分割區。 Azure Redis Cache 會抽象化外觀背後的 Redis 服務，而不會直接公開它們。 實作資料分割的最簡單方式是建立多個 Azure Redis 快取，並將資料分佈於它們之間。 您可以將每個資料項目與指定要儲存在哪個快取中的識別碼 (資料分割索引鍵) 建立關聯。 用戶端應用程式邏輯可以使用這個識別碼，將要求路由至適當的分割區。 此配置非常簡單，但是如果資料分割配置變更 (例如，如果已建立其他 Azure Redis Cache)，則用戶端應用程式可能必須重新設定。

根據 Redis 叢集，原生 Redis (非 Azure Redis Cache) 支援伺服器端資料分割。 在這個方法中，資料會使用雜湊機制跨伺服器平均區分。 每個 Redis 伺服器會儲存中繼資料 (描述分割區保留的雜湊索引鍵範圍)，也包含哪些雜湊索引鍵位於其他伺服器上的分割區中的相關資訊。 用戶端應用程式只會將要求傳送至任何參與的 Redis 伺服器 (可能是最接近的伺服器)。Redis 伺服器會檢查用戶端要求，如果可以在本機解決，就會執行要求的作業，否則會將要求轉送到適當的伺服器。 此模型使用 Redis 叢集，來實作，而且會詳細說明在 [Redis 叢集教學課程](http://redis.io/topics/cluster-tutorial) Redis 網站上的頁面。 Redis 叢集對用戶端應用程式而言是透明的，其他 Redis 伺服器可以加入至叢集 (資料會重新分割)，而不需要重新設定用戶端。

> [AZURE.IMPORTANT] Azure Redis 快取目前不支援 Redis 叢集。 如果您想要利用 Azure 實作這個方法，您必須將 Redis 安裝在一組 Azure 虛擬機器上並且手動設定它們，以實作您自己的 Redis 伺服器。 頁面 [在 Azure 的 CentOS Linux VM 上執行 Redis](http://blogs.msdn.com/b/tconte/archive/2012/06/08/running-redis-on-a-centos-linux-vm-in-windows-azure.aspx) microsoft 網站逐步解說範例，示範如何建立和設定做為 Azure VM 執行的 Redis 節點。

頁面 [資料分割: 如何在多個 Redis 執行個體的資料分割](http://redis.io/topics/partitioning) Redis 網站提供關於使用 Redis 實作資料分割的進一步資訊。 本節的其餘部分假設您正在實作用戶端或 proxy 輔助資料分割。

決定如何利用 Azure Redis Cache 分割資料時，您應該考慮下列幾點：

- Azure Redis Cache 的目的不是做為永久的資料存放區，因此無論您實作任何資料分割配置，您都應該讓應用程式代碼準備好接受，快取中找不到資料而且必須擷取自他處。
- 將經常存取的資料一起保留在相同的分割區中。 Redis 是一個功能強大的索引鍵/值存放區，提供數種高度最佳化的機制以建構資料，範圍從簡單字串 (事實上，二進位資料的長度高達 512MB) 到彙總類型，例如清單 (也可做為佇列和堆疊)、集合 (排序和未排序) 和雜湊 (可以將相關的欄位一起分組，例如在一個物件中代表欄位的項目)。 彙總類型可讓您將許多相關的值與相同索引鍵建立關聯；Redis 索引鍵會識別清單、集合或雜湊，而非它所包含的資料項目。 這些類型都可供 Azure Redis 快取，並描述 [資料型別](http://redis.io/topics/data-types) Redis 網站上的頁面。 例如，追蹤客戶所下訂單的部分電子商務系統中，每一位客戶的詳細資料可以儲存在 Redis 雜湊中，使用客戶識別碼做為索引鍵。 每個雜湊都可以保留客戶的訂單識別碼集合。 個別的 Redis 集可以保留訂單，重新建構為雜湊，使用訂單識別碼做為索引鍵。  圖 10 顯示此結構。 請注意，Redis 不會實作任何形式的參考完整性，所以開發人員必須負責維護客戶和訂單之間的關聯性。

![](media/best-practices-data-partitioning/RedisCustomersandOrders.png)

_圖 10. -建議的結構，在記錄客戶訂單與其詳細資料的 Redis 儲存體_

> [AZURE.NOTE] 在 Redis 中，所有索引鍵 (例如 Redis 字串) 的二進位資料值，而且可以包含最多 512 MB 的資料，所以理論上的索引鍵可以包含幾乎所有資訊。 不過，您應該採用一致的索引鍵命名慣例，可描述資料類型並識別實體，但該慣例不可過長。 常見的方法是使用 "entity_type:ID" 形式的索引鍵，例如 "customer:99" 指出客戶識別碼 99 的索引鍵。

- 您可以將相關的資訊儲存在相同資料庫中的不同彙總以實作垂直資料分割。 例如，在電子商務應用程式中，您無法將常存取的產品相關資訊儲存在 Redis 雜湊中，並將較少使用的詳細資訊儲存在另一個 Redis 雜湊中。 這兩個雜湊可以使用相同的產品識別碼當做部分索引鍵，例如 「 產品:_nn_"其中 _nn_ 是產品資訊的產品識別碼和"product_details: _nn_」 詳細資料。 此策略可以協助減少大多數查詢可能會擷取的資料量。
- 重新分割 Redis 資料存放區是複雜和耗時的工作。 Redis 叢集可以自動重新分割資料，但是這項工具無法供 Azure Redis Cache 使用。 因此，當您設計資料分割配置時，您應該儘量在每個分割區保留足夠的可用空間，以允許一段時間後預期的資料成長。 不過，請記住 Azure Redis Cache 的目的是暫時快取資料，而且保留在快取中的資料具有有限的存留期，指定為存留時間 (TTL) 值。 對於相當易變的資料而言，TTL 應該短一點，但對於靜態資料而言，TTL 可能會更長。 如果資料量可能會填滿快取，您應該避免在快取中儲存大量長時間留存的資料。 如果空間價格不斐，您可以指定會讓 Azure Redis Cache 移除資料的收回原則。

    > [AZURE.NOTE] Azure Redis 快取可讓您指定的大小上限 (從 250 MB 到 53 GB) 的快取選取適當的定價層。 不過，一旦建立 Azure Redis Cache，您就無法增加 (或減少) 其大小。

- Redis 批次與交易無法跨越多個連接，因此受批次或交易影響的所有資料應都保留在相同的資料庫 (分區)。

    > [AZURE.NOTE] Redis 交易中的作業序列不一定是不可部分完成。 構成交易的命令已經過驗證，並在執行之前已排入佇列，而且如果在這個階段期間發生錯誤，會捨棄整個佇列。 不過，一旦成功提交交易，排入佇列的命令就會依序執行。 如果任何命令失敗，只有該命令會中止。在佇列中的所有先前與後續命令都會執行。 如果您必須執行不可部分完成的作業。 如需詳細資訊，請瀏覽 [交易](http://redis.io/topics/transactions) Redis 網站上的頁面。

- Redis 支援有限數量的不可部分完成作業，而且支援多個索引鍵和值的唯一此類型作業只有 MGET (它會傳回指定索引鍵清單值的集合) 和 MSET (它可以儲存指定索引鍵清單值的集合)。 如果您必須使用這些作業，MSET 和 MGET 命令所參考的索引鍵/值組必須儲存在相同的資料庫內。

## 重新平衡分割區

系統成熟且更加了解使用模式時，可能必須調整資料分割配置。 這可能是因為個別分割區吸引不當比例的流量並且變得熱門，導致過度爭用。 此外，您可能低估某些分割區中的資料量，使您達到這些分割區中的儲存容量限制。 無論原因為何，有時候必須重新平衡分割區，才能更平均地分散負載。

在某些情況下，不公開資料配置到伺服器之方式的資料儲存系統，會在可用資源限制內自動重新平衡分割區。 在其他情況下，重新平衡是由兩個階段組成的系統管理工作：

1. 判斷新的資料分割策略，以確定哪些分割區可能必須劃分 (或可能必須結合)，以及如何藉由設計新的資料分割索引鍵，將資料配置到這些新的分割區。
2. 將受影響的資料從舊的資料分割配置移轉至一組新的分割區。

> [AZURE.NOTE] DocumentDB 集合到伺服器的對應是透明的但您仍可能達到 DocumentDB 帳戶的儲存容量和輸送量限制，在這種情況下您可能需要重新設計資料分割配置和移轉資料。

根據資料儲存技術和您的資料儲存系統設計，您可以在使用分割區時在分割區之間移轉資料 (線上移轉) 。 如果不可行，您可能必須在重新定位資料時讓受影響的分割區暫時無法使用 (離線移轉)。

## 離線移轉

離線移轉可說是最簡單的方法，可以減少爭用發生的機會；移動與重新建構正在移轉的資料時不應該變更資料。

就概念而言，此程序包含下列步驟：

1. 將分區標記為離線、
2. 劃分/合併資料，並將其移到新的分區、
3. 驗證資料、
4. 使新的分區上線、
5. 移除舊的分區。

若要保留一些可用性，可能要在步驟 1 將原始分區標示為唯讀，而不是使其無法使用。 這會允許應用程式在資料移動時讀取資料，而不是變更資料。

## 線上移轉

執行線上移轉更複雜，但是使用者比較不受干擾，因為資料在整個程序期間可繼續使用。 其程序與離線移轉所使用的程序相似，不同之處在於原始分區未標示為離線 (步驟 1)。 根據移轉程序 (逐一項目或分區) 的資料粒度，用戶端應用程式中的資料存取程式碼必須處理保留在兩個位置 (原始分區和新分區) 之資料的讀取和寫入。

如需支援線上移轉之解決方案的範例，請參閱 [Elastic Scale 分割/合併服務](sql-database-elastic-scale-overview-split-and-merge.md), 、 線上記錄於 Microsoft 網站上。

## 相關的模式和指引

考量實作資料一致性的策略時，下列模式可能也和您的案例相關：

- 在 Microsoft 網站上的資料一致性指引頁面，描述在雲端等分散式環境中維護一致性的策略。
-  [資料分割指引](https://msdn.microsoft.com/library/dn589795.aspx) Microsoft 網站上的頁面提供設計分割區以符合分散式解決方案中的各種準則的一般概觀。
-  [分區化模式](https://msdn.microsoft.com/library/dn589797.aspx), ，Microsoft 網站上所述，摘要列出一些分區化資料的常見策略。
-  [索引資料表模式](https://msdn.microsoft.com/library/dn589791.aspx) 說明 microsoft 網站將說明如何建立資料的次要索引。 這個方法可讓應用程式使用未參考集合的主索引鍵的查詢，以快速擷取資料。
-  [具體化檢視模式](https://msdn.microsoft.com/library/dn589782.aspx) 討論 microsoft 網站說明如何產生預先填入的檢視，可摘要列出資料以支援快速查詢作業。 如果包含已摘要列出之資料的分割區已快多個網站分佈，這個方法會對分割的資料存放區很有幫助。
- 內容傳遞網路 (CDN) 一文提供利用 Azure 設定和使用 CDN 的其他指引。

## 相關資訊

-  [Azure SQL Database](https://msdn.microsoft.com/library/azure/ee336279.aspx) Microsoft 網站上的頁面會提供詳細的文件說明如何建立及使用 SQL 資料庫。
- 頁面 [Azure SQL Database Elastic Scale 概觀](sql-database-elastic-scale-introduction.md) Microsoft 網站提供全面性的 Elastic Scale 介紹。
- 本主題 [使用 Elastic Scale 分割及合併](sql-database-elastic-scale-overview-split-and-merge.md) microsoft 網站包含使用劃分/合併服務管理 Elastic Scale 分區的相關資訊。
- 頁面 [Azure 儲存體延展性和效能目標](https://msdn.microsoft.com/library/azure/dn249410.aspx) microsoft 網站文件的 Azure 儲存體的大小和輸送量限制。
-  [執行實體群組交易](https://msdn.microsoft.com/library/azure/dd894038.aspx) Microsoft 網站上的頁面提供透過儲存在 Azure 資料表儲存體實體時作交易式作業的詳細的資訊。
- 發行項 [Azure 資料表儲存體設計可擴充的資料分割策略](https://msdn.microsoft.com/library/azure/hh508997.aspx) microsoft 網站包含在 Azure 資料表儲存體中分割資料的詳細的資訊。
- 頁面 [使用 Azure 的 CDN](cdn-how-to-use.md) microsoft 網站將告訴您如何將資料保留在 Azure Blob 儲存體中使用 Azure 內容傳遞網路 (CDN) 複寫。
- 頁面 [預覽版本的 DocumentDB 限制](documentdb-limits.md) microsoft 網站將告訴您目前的限制和配額 Microsoft documentdb。
- 頁面 [管理 DocumentDB 容量和效能](documentdb-manage.md) microsoft 網站包含 Azure DocumentDB 如何將資料庫的資源配置的相關資訊。
-  [Azure 搜尋服務概觀](https://msdn.microsoft.com/library/azure/dn798933.aspx) Microsoft 網站上的頁面會提供可使用 Azure 搜尋服務功能的完整描述。
-  [限制和條件約束 (Azure 搜尋服務 API)](https://msdn.microsoft.com/library/azure/dn798934.aspx) Microsoft 網站上的頁面包含 Azure 搜尋服務的每個執行個體的容量資訊。
-  [支援的資料類型 (Azure 搜尋服務)](https://msdn.microsoft.com/library/azure/dn798938.aspx) Microsoft 網站上的頁面摘要列出您可以使用可搜尋文件和索引中的資料型別。
-  [Microsoft Azure 快取](http://azure.microsoft.com/services/cache.md) Microsoft 網站上的頁面提供 Azure Redis 快取的簡介。
- 頁面 [資料分割: 如何在多個 Redis 執行個體的資料分割](http://redis.io/topics/partitioning) Redis 網站提供使用 Redis 實作資料分割的資訊。
- 頁面 [在 Azure 的 CentOS Linux VM 上執行 Redis](http://blogs.msdn.com/b/tconte/archive/2012/06/08/running-redis-on-a-centos-linux-vm-in-windows-azure.aspx) microsoft 網站逐步解說範例，示範如何建立和設定做為 Azure VM 執行的 Redis 節點。
-  [資料型別](http://redis.io/topics/data-types) Redis 網站上的頁面描述 Redis 和 Azure Redis Cache 皆可使用的資料類型。

