<properties
   pageTitle="一般重試方針 | Microsoft Azure"
   description="暫時性錯誤處理重試指引。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="masimms"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="04/28/2015"
   ms.author="masashin"/>

# 一般重試方針

![](media/best-practices-retry-general/pnp-logo.png)

## 概觀

與遠端服務和資源進行通訊的所有應用程式必須能感應暫時性錯誤。 尤其是執行雲端的應用程式，因為其環境與透過網際網路連線的本質，代表著可能更常碰到暫時性錯誤。 暫時性錯誤包括瞬間失去元件和服務的網路連線、暫時無法使用服務，或當服務忙碌時逾時。 這些錯誤通常會自行修正，如果在適當的延遲後再重複此動作，可能會成功。

本文件涵蓋處理暫時性錯誤的一般指引。 如需處理暫時性錯誤，使用 Microsoft Azure 服務時，請參閱 [Azure 服務特定重試方針](best-practices-retry-service-specific.md)。

## 為什麼雲端會發生暫時性錯誤？

任何的環境、任何的平台或作業系統，及任何一種應用程式中，都會發生暫時性錯誤。 在本機內部部署的基礎結構上執行的解決方案中，應用程式及其元件的效能與可用性通常是透過昂貴但通常很少使用的硬體備援來維持，且元件與資源的位置互相靠近。 雖然這比較不可能失敗，它可能仍會導致暫時性失敗，甚至透過不可預見的事件，例如外部電源供應器或網路問題或其他嚴重損壞狀況中斷。

雲端託管 (包括私人雲端系統) 使用共用的資源、備援、自動容錯移轉，以及動態地在大量的商業計算節點之間分配資源，以提高整體的可用性。 不過，這些環境的本質意味著更可能發生暫時性錯誤。 原因包括：

* 雲端環境中有許多共用的資源，為了保護這些資源，會節流存取資源。 某些服務在負載上升到特定的層級時，或到達輸送量速率上限時，會拒絕連線以允許處理現有的要求，並維護所有使用者的服務效能。 節流有助於維護使用共用資源之芳鄰與其他租用戶的服務品質。
* 雲端環境是使用大量的商用硬體單位建置而成。 雲端環境會將負載動態地分散到多個運算單位與基礎結構元件之間，以提供效能，並藉由自動回收或更換錯誤的單位，以提供可靠性。 此動態本質意味著可能偶爾會發生暫時性錯誤和暫時連線失敗。
* 在應用程式與資源及其使用的服務之間，通常會有多個硬體元件，包括網路基礎結構，例如路由器和負載平衡器。 此額外的基礎結構偶爾會導致額外的延遲與暫時性連線錯誤。
* 用戶端與伺服器之間的網路狀況會不時改變，尤其是當橫跨網際網路通訊時。 即使是在內部部署的位置中，非常繁重的流量負載都可能使得通訊變慢，造成連線間歇性故障。

## 挑戰
暫時性故障會對應用程式的感知可用性造成重大影響，即使應用程式已在所有可預測的狀況下經過徹底的檢查。 若要確保雲端託管的應用程式能可靠地作業，應用程式必須能夠回應下列的挑戰：

* 應用程式必須能夠偵測錯誤發生，並判斷這些錯誤可能是暫時性、持久性，或是終端機故障。 當發生錯誤時，不同的資源可能傳回不同的回應，而且這些回應可能會視作業的內容而所不同，例如對於從儲存體讀取時所發生的錯誤回應，與寫入儲存體時所發生的回應不同。 許多資源和服務都有完善記載的暫時性錯誤合約。 但若未提供這類資訊，則很難發現錯誤的本質，以及其是否可能是暫時性。
* 如果經判定錯誤可能是暫時性，應用程式必須能夠重試作業，並追蹤作業重試的次數。
* 應用程式必須使用適當的重試策略。 此策略會指定它應該重試的次數、每次嘗試之間延遲的時間，以及嘗試失敗後採取的動作。 適當的嘗試次數以及每個嘗試之間的延遲時間通常難以決定，而且會視資源和應用程式本身的目前作業狀況而改變。

## 一般方針
下列指導方針可協助您設計合適的應用程式暫時性錯誤處理機制：

* **判斷是否有內建的重試機制：**
  * 許多服務提供 SDK 或包含暫時性錯誤處理機制的用戶端程式庫。 其使用的重試原則通常是針對目標服務的本質與需求量身訂做。 或者，對於判斷重試是否適當，以及在下一次嘗試重試之前要等待多久的時間方面，服務的 REST 介面可能會傳回很有幫助的資訊。
  * 除非您有具體且明確的需求，需要其他更適當的重試行為，否則請使用可用的內建重試機制。
* **判斷作業是否適合重試**:
  * 只在錯誤是暫時性 (通常可由錯誤的本質來判定)，以及在重新嘗試後作業至少有一些成功的可能性時，您才應重試作業。 若作業是無效的作業，例如資料庫所更新的項目不存在，或者要求的服務或資源發生嚴重錯誤，重新嘗試是沒有意義的。
  * 一般而言，只要在能夠判斷作業的完整影響，且狀況已獲充分瞭解並可驗證時，您才應實作重試。 如果不是，則將它留給呼叫程式碼來實作重試。 請記住，從您無法控制的資源與服務傳回的錯誤可能會隨著時間而演進，您可能需要重新檢視您的暫時性錯誤偵測邏輯。
  * 當您建立服務或元件時，請考慮實作錯誤碼和訊息，來協助用戶端判斷它們是否應重試失敗的作業。 特別是，表示用戶端是否應該重試作業 (或許是藉由傳回 **isTransient** 值)，並建議在下一次重試之前適當的延遲時間。 如果您建立 Web 服務，請考慮傳回在您的服務合約中定義的自訂錯誤。 即使一般用戶端可能無法讀取這些錯誤，但在建置自訂用戶端時，自訂錯誤很有幫助。
* **決定適當的重試計數與間隔：**
  * 請務必最佳化重試計數和使用案例類型的間隔。 如果您重試的次數不足，應用程式將無法完成作業，並可能會遭遇失敗。 如果重試次數太多或間隔太短，應用程式可能會長期保留資源，例如執行緒、連線和記憶體，這對於應用程式的健全狀況有不利的影響。
  * 適當的重試嘗試時間間隔與次數，取決於正在嘗試的作業類型。 例如，如果作業是使用者互動的一部分，則間隔應短，且只需要重試幾次，以避免讓使用者等候回應 (這會讓連線保持開啟，並減少其他使用者的可用性)。 如果作業是長期執行或重要工作流程的一部分，要取消並重新啟動工作流程的處理程序是昂貴或耗時的，則嘗試之間的等待時間應較長，並重試更多次。
  * 設計一個成功的策略時，決定適當的重試間隔是最困難的一部分。 一般的策略會使用下列幾類的重試間隔：
      * **指數退避**。 應用程式在第一次重試之前短暫地等待，然後每個後續重試的間隔時間呈指數增加。 例如，會在 3 秒、12 秒、30 秒後重試作業。
      * **累加間隔**。 應用程式在第一次重試之前短暫地等待，然後每個後續重試的間隔時間呈累加增加。 例如，會在 3 秒、7 秒、13 秒後重試作業。
      * **定期**。 應用程式每次嘗試的間隔時間相同。 例如，固定每 3 秒重試作業。
      * **立即重試**。 有時候暫時性錯誤極短，可能是因網路封包衝突或硬體元件流量突增等事件造成的。 在此情況下，適合立即重試作業，因為如果錯誤在作業讓應用程式組合並傳送下一個要求時已清除，則作業可能會成功。 不過，立即重試嘗試次數不得超過一次，如果立即重試失敗，應改換備用策略，例如指數退避法或後援動作。
      * **隨機**。 任何上述的重試策略都可包含隨機，以防止用戶端的多個執行個體同時傳送後續的重試嘗試。 例如，一個執行個體可能會在 3 秒、11 秒、28 秒後重試作業，而另一個執行個體則在 4 秒、12 秒、26 秒後重試作業。 隨機是很有用的技巧，可搭配其他策略使用。  
  * 一般來說，會為背景作業採用指數退避法策略，為互動式作業採用立即或固定間隔重試策略。 在上述這兩種狀況中，您應該選擇延遲與重試計數，讓所有重試嘗試的延遲上限都會在所需的端對端延遲需求之內。
  * 請考量到所有會對重試作業的整體逾時上限造成影響的因素組合。 這些因素包括失敗連線產生回應所花費的時間 (通常是由用戶端的逾時值所設定)，以及重試嘗試之間的延遲和重試次數上限。 所有這些時間的總和會導致整體作業非常長，尤其是在使用指數退避法策略時，因為每次錯誤後重試的間隔會快速成長。 如果處理程序必須符合特定的服務等級協定 (SLA)，則整體的作業時間，包括所有的逾時和延遲，必須在 SLA 所定義的作業時間之內
  * 過度積極的重試策略，例如間隔太短或重試次數過多，會對目標資源或服務造成不利的影響。 這可能會讓資源或服務無法從過載的狀態復原，而且它將會繼續封鎖或拒絕要求。 這會造成惡性循環，越來越多的要求傳送到資源或服務，因而造成其復原能力進一步降低。
  * 選擇重試間隔時請考量作業的逾時，以避免立即啟動後續的嘗試 (例如當逾時期間與重試間隔類似時)。 也請考慮您是否需要讓可能期間的總和 (逾時值加上重試間隔) 短於特定的時間總和。 逾時設定非常短或非常長的的作業可能會影響等候的時間，以及重試作業的頻率。
  * 使用例外狀況類型及其包含的任何資料，或使用從服務傳回的錯誤碼與訊息，來最佳化重試的間隔和次數。 例如，某些例外狀況或錯誤代碼 (例如 HTTP 代碼 503：無法以回應中的 Retry-After 標頭提供服務) 會指出錯誤可能持續時間的長度，或服務失敗且不會回應任何後續的嘗試。
* **避免反向模式**:
  * 在絕大多數情況下，您應該避免包含重複重試程式碼層的實作。 請避免包括階層式重試機制的設計，或避免在涉及要求階層之作業的每個階段實作重試，除非您有此特定的需求。 在這些例外狀況下，請使用原則避免過多的重試次數和延遲期間過長，並確定您瞭解後果。 例如，如果某個元件對另一個元件提出要求，然後存取目標服務，且您要對這兩個呼叫各實作重試三次，則總共會對該服務重試九次。 許多服務和資源會實作內建的重試機制，如果您需要在較高層級實作重試，您應該調查如何停用或修改此設定。
  *  永遠不要實作無盡的重試機制。 這可能會防止資源或服務從過載的情況下復原，並造成節流與遭拒絕連線持續更長的時間。 使用有限的數目或重試，或實作一種模式，例如 [斷路器](http://msdn.microsoft.com/library/dn589784.aspx) 以允許復原服務。
  * 永遠不要執行立即重試一次以上。
  * 請避免使用固定重試間隔，尤其是當您在存取 Azure 的服務與資源時會重試非常多次時。 在此情況下的最佳方法是指數退避策略搭配斷路功能。
  * 防止同一個用戶端有多個執行個體，或不同用戶端有多個執行個體同時傳送重試。 如果這可能發生，請在重試間隔導入隨機策略。
* **測試重試策略與實作：**
  * 請確定在儘可能最多的狀況下完整測試您的重試策略，尤其是當其使用的應用程式與目標資源是在極端負載下時。 若要檢查測試期間的行為，您可以：
      * 將暫時性與非暫時性錯誤插入服務中。 例如，傳送無效要求，或新增程式碼來偵測不同錯誤類型的測試要求與回應。 例如使用 TestApi，請參閱 [TestApi 的錯誤插入測試](http://msdn.microsoft.com/magazine/ff898404.aspx) 和 [簡介 TestApi – 第 5 部分 ︰ Managed 程式碼錯誤插入 Api](http://blogs.msdn.com/b/ivo_manolov/archive/2009/11/25/9928447.aspx)。
      * 建立資源或服務模型，以傳回實際服務可能傳回的錯誤範圍。 請確定您涵蓋了重試策略其設計要偵測的所有錯誤類型。
      * 如果服務是您建立及部署的自訂服務，則透過暫時停用或超載該服務，來強制暫時性錯誤發生 (當然，您不應該嘗試超載 Azure 內的任何共用資源或共用服務)。
      * 對於以 HTTP 為基礎的 API，請考慮在您的自動化測試中使用 FiddlerCore 程式庫來變更 HTTP 要求的結果，方法是新增額外的往返次數或變更回應 (例如 HTTP 狀態碼、標頭、內文或其他因素)。 這會允許決定性測試錯誤狀況的子集，無論是暫時性錯誤或其他類型的錯誤。 如需詳細資訊，請參閱 [FiddlerCore](http://www.telerik.com/fiddler/fiddlercore)。 如需範例，說明如何使用程式庫，尤其是 **HttpMangler** 類別，請檢查 [Azure 儲存體 sdk 的原始程式碼](https://github.com/Azure/azure-storage-net/tree/master/Test)。
      * 執行高負載因數和並行測試，確保重試機制與策略在這些條件下能正確運作，且不會對用戶端作業造成不良的影響或導致要求之間交叉污染。
* **管理重試原則組態：**
  * A _重試原則_ 是所有重試策略元素的組合。 它定義了能判斷錯誤是否可能是暫時性的偵測機制、使用的間隔類型 (例如固定、指數退避法及隨機)、實際間隔值，以及重試次數。
  * 必須在應用程式內的許多位置實作重試，即使是最簡單的應用程式也需要，至於較複雜的應用程式則必須每一層都實作。 請考慮集中儲存所有的原則，而非將每個原則的元素硬式編碼在多個位置中。 例如，在應用程式組態檔中儲存如間隔和重試計數等值、在執行階段讀取這些值，並以程式設計方式建置重試原則。 這可讓您更容易管理設定，以及修改和微調值，以回應變更需求和案例。 不過，請設計系統以儲存值，而非每一次都要重新讀取組態檔案，並確定在無法從組態取得值時會使用合適的預設值。
  * 請考慮在 Azure 雲端服務應用程式中儲存值，以用來在服務組態檔中建置執行階段的重試原則，讓這些值不需要重新啟動應用程式即可變更。
  * 利用您所使用用戶端 API 中的內建或預設重試策略，但僅在適合您策略的狀況下利用。 這些策略通常是一般用途。 在某些狀況下，這些策略可能全為必要，但在某些狀況下，可能無法提供完整的選項範圍來滿足您特定的需求。 您必須瞭解設定如何透過測試來影響應用程式，以決定最適當的值。
* **記錄與追蹤暫時性與非暫時性錯誤：**
  * 在重試策略中包含例外狀況處理，以及其他會記錄嘗試重試時間的工具。 雖然偶爾暫時性錯誤及重試是預期中的狀況，且不代表有問題，但固定與不斷增加的重試次數，通常代表可能會造成錯誤的問題，或是目前正在影響應用程式的效能與可用性。
  * 請將暫時性錯誤記錄為警告項目，而非錯誤項目，讓監視系統不會將它們偵測成應用程式錯誤而觸發假警示。
  * 請考慮將值儲存在您的記錄項目中，以指出重試是由服務中的節流所造成的，或是由其他類型的錯誤 (例如連線失敗) 造成的，讓您能夠在分析資料期間加以區分。 節流錯誤數目的增加，這通常代表應用程式的設計有瑕疵，或是需要改用可提供專用硬體的高階服務。  
  * 請考慮測量和記錄包含重試機制在內的作業所需的整體時間。 這是暫時性錯誤對使用者回應時間、處理程序延遲，以及應用程式使用個案效率等整體影響的良好指標。 此外也要記錄發生重試的次數，以瞭解對回應時間有貢獻的因素。
  * 請考慮實作遙測和監視系統，當錯誤次數與速率、重試平均數，或作業成功所需的整體時間增加時，此系統就會引發警示。
* **管理持續失敗的作業：**
  * 當每次嘗試後作業仍繼續失敗時，請務必考慮您將如何處理這種情況：
      * 雖然重試策略會定義作業應重試次數的上限，但它不會防止應用程式一再地重複作業，達與重試次數相同的次數。 例如，如果處理訂單服務因為嚴重錯誤失敗，而永久無法有動作，則重試策略會偵測連線逾時，並將它視為暫時性錯誤。 程式碼將會重試作業達指定的次數，然後放棄。 不過，當另一位客戶下單時，會再次嘗試該作業，即使是確定該作業每次都會失敗。
      * 若要防止不斷重試作業，持續失敗，請考慮實作 [斷路器模式](http://msdn.microsoft.com/library/dn589784.aspx)。 在此模式中，如果在指定的時段內失敗次數超過臨界值，則會立即將要求傳回給呼叫者，並視為錯誤，而不會嘗試存取失敗的資源或服務。
      * 應用程式會定期測試服務，並間歇性地偵測服務何時可供使用，且要求之間的間隔非常長。 適當的間隔視案例而定，例如作業的重要性和服務的本質，可能是數分鐘到數個小時。 測試成功時，應用程式會恢復正常作業，並將要求傳遞到剛復原的服務。
      * 同時，可能會切換回服務的另一個執行個體 (或許在不同的資料中或應用程式中)、使用提供相容 (或許是更簡單) 功能的服務，或執行替代作業以期該服務能很快地恢復使用。 例如，可能適合將服務的要求儲存在佇列或資料存放區中，且於稍後重新執行。 否則您可能能夠將使用者重新導向至替代的應用程式執行個體、讓應用程式效能降級，但仍然可以提供可接受的功能，或將訊息傳回給使用者，表示應用程式目前無法使用。

* **其他考量**
  * 決定重試次數的值和原則的重試間隔時，請考慮服務或資源的作業是否是長時間執行或多步驟作業的一部分。 當某個作業步驟失敗時，若要補償所有其他的作業步驟，可能會很困難或昂貴。 在此情況下，可接受很長的間隔及大量的重試次數，只要不會因為保留或鎖定稀少的資源，而封鎖其他的作業。
  * 請思考一下重試相同的作業是否會導致資料不一致。 如果多步驟程序中有某些部分是重複的，且作業不具有等冪性，則可能會導致不一致的問題。 例如，會累加值的作業如果重複，則會產生無效的結果。 重複執行將訊息傳送至佇列的作業，如果無法偵測到重複訊息的話，則可能會在訊息取用者中造成不一致的狀況。 若要避免這個問題，請確定將每個步驟設計成等冪作業。 如需有關等冪性的詳細資訊，請參閱 [等冪性模式](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/)。
  * 請思考一下作業將重試的範圍。 例如，很容易在包含數個作業的層級實作重試程式碼，如果其中一個失敗，也很容易重試所有的作業。 不過，這樣可能會導致等冪性問題或不必要的回復作業。
  * 如果您選擇的重試範圍包含數個作業，當決定重試間隔時、監視花費時間時，以及因失敗而引發警示前，請考慮所有作業的延遲總和。
  * 請思考一下您的重試策略如何影響共用應用程式中的芳鄰或其他租用戶，以及何時使用共用資源與服務。 積極重試原則會導致其他的使用者，以及共用資源與服務的應用程式，發生越來越多的暫時性錯誤。 同樣的，您的應用程式可能會受到由資源與服務的其他使用者所實作的重試原則影響。 對於關鍵任務應用程式，您可以決定使用非共用的高階服務。 這可讓您更能控制這些資源與服務的負載與後續節流，進而有助於調整額外的成本。

## 詳細資訊

* [Azure 服務特定重試方針](best-practices-retry-service-specific.md)
* [暫時性錯誤處理應用程式區塊](http://msdn.microsoft.com/library/hh680934.aspx)
* [斷路器模式](http://msdn.microsoft.com/library/dn589784.aspx)
* [補償交易模式 (英文)](http://msdn.microsoft.com/library/dn589804.aspx)
* [等冪性模式](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/)


