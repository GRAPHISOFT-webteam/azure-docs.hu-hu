<properties
    
    
    
    documentationCenter=""
    
    
    editor=""/>

<tags
    
    
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    
    

# 應用程式模型 v2.0 預覽版：通訊協定 - OpenID Connect

OpenID Connect 是建置在 OAuth 2.0 的驗證通訊協定之上，可用來將使用者安全地登入 Web 應用程式。 使用應用程式模型 v2.0 實作 OpenID Connect，您可以將登入及 API 存取新增至您的 Web 型應用程式。 本指南以不考慮語言的方式來示範如何這樣做，描述在不使用我們的任何開放原始碼程式庫的情況下，如何傳送和接收 HTTP 訊息。
> [AZURE.NOTE]
    此資訊適用於 v2.0 應用程式模型公開預覽版本。



## 傳送登入要求



- 
- 
- 

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application Id
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered Redirect Uri, url encoded
&response_mode=query                                  // 'query', 'form_post', or 'fragment'
&scope=openid                                        // Translates to the 'Read your profile' permission
&state=12345                                         // Any value, provided by your app
&nonce=678910                                        // Any value, provided by your app
```

| 參數| | 說明|
| ----------------------- | ------------------------------- | --------------- |
| client_id| 必要| |
| response_type| 必要| |
| redirect_uri| 必要| 應用程式的 redirect_uri，您的應用程式可在此傳送及接收驗證回應。其必須完全符合您在入口網站中註冊的其中一個 redirect_uris，不然就必須得是編碼的 url。|
| scope| 必要| 範圍的空格分隔清單。您也可以在此要求中包含其他範圍以要求同意。|
| nonce| 必要| 由應用程式產生且包含在要求中的值，會以宣告方式包含在產生的 id_token 中。應用程式接著便可確認此值，以減少權杖重新執行攻擊。此值通常是隨機的唯一字串，可用以識別要求的來源。|
| response_mode| 建議使用| 指定將產生的 authorization_code 傳回到應用程式所應該使用的方法。可以是 'query'、'form_post' 或 'fragment' 其中一種。
| state| 建議使用| 同樣會隨權杖回應傳回之要求中所包含的值。其可以是您想要之任何內容的字串。隨機產生的唯一值通常用於防止跨站台要求偽造攻擊。此狀態也用於在驗證要求出現之前，於應用程式中編碼使用者的狀態資訊，例如之前所在的網頁或檢視。|
| prompt| 選用| 表示需要的使用者互動類型。|
| login_hint| 選用| 可用來預先填入使用者登入頁面的使用者名稱/電子郵件地址欄位。|

此時，會要求使用者輸入其認證並完成驗證。  如果使用者未曾同意這些權限的任何一項，就會要求使用者同意要求的權限。





```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...   // the id_token, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF            // a value generated by the v2.0 endpoint
&state=12345                                                    // the value provided in the request
&id_token_expires_in=3600
```

| 參數| 說明|
| ----------------------- | ------------------------------- |
| id_token| 您可以使用 id_token 確認使用者的身分識別，並以使用者開始工作階段。|
| session_state| 識別目前使用者工作階段的唯一值。這個值是 GUID，但應視為不檢查即傳遞的不透明值。|
| state| 如果要求中包含狀態參數，回應中就應該出現相同的值。|
| id_token_expires_in| id_token 的有效期 (以秒為單位)。|




```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| 參數| 說明|
| ----------------------- | ------------------------------- |
| 錯誤| 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。|
| error_description| 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。|

## 驗證 id_token



v2.0 應用程式模型具有 OpenID Connect 中繼資料端點，可在執行階段讓應用程式提取 v2.0 應用程式模型的相關資訊。 這項資訊包括端點、權杖內容和權杖簽署金鑰。 中繼資料端點包含下列位置的 JSON 文件：







您可以使用位於此端點的 RSA256 公用金鑰驗證 id_token 的簽章。




一旦驗證了 id_token 的簽章，就會有數項宣告需要驗證：

- 其值應該是您在登入要求中所指定的內容。
- 
- 

您可能也希望根據自己的案例驗證其他宣告。 一些常見的驗證包括：

- 
- 確保使用者擁有正確的授權/權限
- 確保驗證具有特定強度，例如多重要素驗證。

如需有關 id_token 中宣告的詳細資訊，請參閱 [v2.0 應用程式模型語彙基元參考](active-directory-v2-tokens.md)。

一旦驗證完畢 id_token，即可利用使用者開始工作階段，並使用 id_token 中的宣告來取得應用程式中的使用者相關資訊。 這項資訊可以用於顯示、記錄、授權等等。

## 傳送登出要求

這表示應用程式無法向 v2.0 端點傳送要求，而無法結束使用者工作階段及清除 v2.0 端點設定的 Cookie。
若要將使用者登出，應用程式只需結束自身的使用者工作階段，並完整地將使用者工作階段留給 v2.0 端點即可。 下次使用者嘗試登入時，就會看到列出其主動登入帳戶的 [選擇帳戶] 頁面。
在該頁面上，使用者可以選擇登出任一帳戶，結束 v2.0 端點的工作階段。



## 登入摘要圖表

最基本的登入流程包含下列步驟：

![OpenId Connect 區隔線](../media/active-directory-v2-flows/convergence_scenarios_webapp.png)

## 取得存取權杖

許多 Web Apps 不僅需要將使用者登入，同時需要使用 OAuth 代表使用者來存取 Web 服務。 這個案例針對使用者驗證合併 OpenID Connect，同時使用 OAuth 授權碼流程取得可用來取得 access_token 的 authorization_code。 若要取得存取權杖，您需要稍微修改上述的登入要求：


```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application Id
&response_type=id_token+code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered Redirect Uri, url encoded
&response_mode=query                                  // 'query', 'form_post', or 'fragment'
&scope=openid%20                                      // Include both 'openid' and scopes your app needs  
offline_access%20                                        
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345                                         // Any value, provided by your app
&nonce=678910                                        // Any value, provided by your app
```

在要求中包含的權限範圍，並使用 `response_type = code + id_token`, ，v2.0 端點可確保使用者已經同意所示的權限 `範圍` 查詢參數，並傳回應用程式的存取權杖交換授權碼。



```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...   // the id_token, truncated
&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...  // the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF            // a value generated by the v2.0 endpoint
&state=12345                                                    // the value provided in the request
&id_token_expires_in=3599
```

| 參數| 說明|
| ----------------------- | ------------------------------- |
| id_token| 您可以使用 id_token 確認使用者的身分識別，並以使用者開始工作階段。需 id_tokens 和其內容的詳細資訊包含在 [v2.0 應用程式模型語彙基元參考](active-directory-v2-tokens.md)。|
| code| 應用程式要求 authorization_code。應用程式可以使用授權碼要求存取權杖之目標資源。Authorization_code 的有效期很短，通常約 10 分鐘後即到期。|
| session_state| 識別目前使用者工作階段的唯一值。這個值是 GUID，但應視為不檢查即傳遞的不透明值。|
| state| 如果要求中包含狀態參數，回應中就應該出現相同的值。|
| id_token_expires_in| id_token 的有效期 (以秒為單位)。|



```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| 參數| 說明|
| ----------------------- | ------------------------------- |
| 錯誤| 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。|
| error_description| 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。|

一旦授權 `程式碼` 和 `id_token`, ，您可以將使用者登入，並代表它取得存取權杖。 若要註冊中的使用者，您必須驗證 `id_token` 精確地說明 [上方](#validating-the-id-token)。 若要取得存取權杖，您可以依照所述的步驟我們 [OAuth 通訊協定文件](active-directory-v2-protocols-oidc.md#request-an-access-token)。

## 權杖取得摘要圖表

僅供參考，完整 OpenID Connect 登入和權杖取得流程如下所示：

![OpenId Connect 區隔線](../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)




