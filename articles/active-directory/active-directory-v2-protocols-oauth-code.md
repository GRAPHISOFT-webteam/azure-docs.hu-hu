
<properties
    pageTitle="應用程式模型 v2.0 OAuth 通訊協定 | Microsoft Azure"
    description="使用 Azure AD 實作 OAuth 2.0 驗證通訊協定建置 Web 應用程式。"
    services="active-directory"
    documentationCenter=""
    authors="dstrockis"
    manager="msmbaldwin"
    editor=""/>

<tags
    ms.service="active-directory"
    ms.workload="identity"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="12/09/2015"
    ms.author="dastrock"/>

# 應用程式模型 v2.0 預覽：通訊協定 - OAuth 2.0 授權碼流程

OAuth 2.0 授權碼授與可用於裝置上所安裝的應用程式中，以存取受保護的資源，例如 Web API。  使用應用程式模型 v2.0 實作 OAuth 2.0，您可以新增登入及 API 存取到您的行動應用程式和傳統型應用程式。  本指南與語言無關，描述在不使用我們的任何開放原始碼程式庫的情況下，如何傳送和接收 HTTP 訊息。

<!-- TODO: Need link to libraries -->   

> [AZURE.NOTE]
    此資訊適用於 v2.0 應用程式模型公開預覽版本。  如需如何公開上市的 Azure AD 整合服務，請參閱 [Azure Active Directory 開發人員指南](active-directory-developers-guide.md)。

OAuth 2.0 授權碼流程所述在 [一節的 OAuth 2.0 規格 4.1](http://tools.ietf.org/html/rfc6749)。  它用來執行驗證和授權，在大部分的應用程式類型，包括 [web 應用程式](active-directory-v2-flows.md#web-apps) 和 [原生安裝應用程式](active-directory-v2-flows.md#mobile-and-native-apps)。  其可讓應用程式安全地取得 access_token，這些權杖可用於存取以 v2.0 應用程式模型保護的資源。  



## 要求授權碼
授權碼流程始於用戶端將使用者導向 `/authorize` 端點。  在這項要求中，用戶端會指出必須向使用者索取的權限：

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e        // Your registered Application Id
&response_type=code
&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob     // Your registered Redirect Uri, url encoded
&response_mode=query                                    // 'query', 'form_post', or 'fragment'
&scope=                                              // See table below
openid%20
offline_access%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345                                           // Any value provided by your app
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | ----------------------- |
| client_id | 必要 | 應用程式識別碼的註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給您的應用程式。 |
| response_type | 必要 | 授權碼流程必須包含 `code`。 |
| redirect_uri | 必要 | 您的應用程式可在應用程式的 redirect_uri 傳送及接收驗證回應。  其必須完全符合您在入口網站中註冊的其中一個 redirect_uris，不然就必須得是編碼的 url。 |
| scope | 必要 | 範圍的空格分隔清單。  v2.0 端點的單一範圍值為資源和所要求資源的權限。  範圍的形式為 `<app identifier URI>/<scope value>`。  上例中使用了 Azure AD Graph API 的應用程式識別碼 `https://graph.windows.net`，並要求了兩項權限：`directory.read` 和 `directory.write`。  如需範圍的詳細說明，請參閱 [應用程式模型 v2.0 範圍參考](active-directory-v2-scopes.md)。  |
| response_mode | 建議使用 | 指定將產生的 authorization_code 傳回到應用程式所應該使用的方法。  可以是 'query'、'form_post' 或 'fragment' 其中一種。
| state | 建議使用 | 同樣會隨權杖回應傳回之要求中所包含的值。  其可以是您想要之任何內容的字串。  隨機產生的唯一值通常用於防止跨站台要求偽造攻擊。  此狀態也用於在驗證要求出現之前，於應用程式中編碼使用者的狀態資訊，例如之前所在的網頁或檢視。 |
| prompt | 選用 | 表示需要的使用者互動類型。  此時只有有效的值為 'none'、 ' 登入' 和 '同意'。  `prompt=login` 會強制使用者輸入其認證，該要求時，停止單一登入。  `prompt=none` 相反-它會確保使用者不提供任何互動式提示恕不另行通知。  如果要求不能透過單一登入以無訊息方式完成，v2.0 端點會傳回錯誤。  `prompt=consent` 使用者登入時，詢問使用者要授與權限的應用程式之後，就會觸發 OAuth 同意對話方塊中。 |
| login_hint | 選用 | 可用來預先填入使用者登入頁面的使用者名稱/電子郵件地址欄位。 |

此時，會要求使用者輸入其認證並完成驗證。  v2.0 端點也會確保使用者已經同意 `scope` 查詢參數所示的權限。  如果使用者未曾同意這些權限的任何一項，就會要求使用者同意要求的權限。  詳細資料的 [這裡提供的權限、 同意和多租用戶應用程式](active-directory-v2-scopes.md)。

一旦使用者驗證並同意，v2.0 端點就會使用 `response_mode` 參數中指定的方法，將回應傳回至位於指定所在 `redirect_uri` 的應用程式。

使用 `response_mode=query` 的成功回應如下所示：

```
GET urn:ietf:wg:oauth:2.0:oob?
code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...   // the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF            // a value generated by the v2.0 endpoint
&state=12345                                                      // the value provided in the request
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| code | 應用程式要求 authorization_code。 應用程式可以使用授權碼要求存取權杖之目標資源。  Authorization_code 的有效期很短，通常約 10 分鐘後即到期。 |
| session_state | 識別目前使用者工作階段的唯一值。 這個值是 GUID，但應視為不檢查即傳遞的不透明值。 |
| state | 如果要求中包含狀態參數，回應中就應該出現相同的值。 應用程式應該檢查要求和回應中的狀態值相同。 |

錯誤回應可能也會傳送至 `redirect_uri`，讓應用程式可以適當地處理：

```
GET urn:ietf:wg:oauth:2.0:oob?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。  |

## 要求存取權杖
既然您已經取得 authorization_code 並獲得使用者授權，您就可以將 `POST` 要求傳送至 `/token` 端點，贖回 `code` 以取得所需資源的 `access_token`：

```
POST common/v2.0/oauth2/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "authorization_code",
    "client_id": "2d4d11a2-f814-46a7-890a-274a72a7309e",
    "scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
    "code": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq..."
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | --------------------- |
| client_id | 必要 | 應用程式識別碼的註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給您的應用程式。 |
| grant_type | 必要 | 必須是授權碼流程的 `authorization_code`。 |
| scope | 必要 | 範圍的空格分隔清單。  在此階段中要求的範圍必須相當於或為第一個階段中所要求的範圍子集。  如果這個要求中指定的範圍遍及多個資源伺服器，v2.0 端點就會傳回第一個範圍內所指定資源的權杖。  如需範圍的詳細說明，請參閱 [權限、 同意，以及範圍](active-directory-v2-scopes.md)。  |
| code | 必要 | 您在流程的第一個階段中取得的 authorization_code。   |
| client_secret | Web Apps 所需 | 您在應用程式註冊入口網站中為應用程式建立的應用程式密碼。  它不應在原生應用程式中，因為 client_secrets 無法可靠地儲存在裝置上。  Web Apps 和 Web API 都需要應用程式密碼，其能夠將 client_secret 安全地儲存在伺服器端。 |

成功的權杖回應如下：

```
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": "3600",
    "scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
    "id_token_expires_in": "3599"
}
```
| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| access_token | 所要求的存取權杖。 應用程式可以使用此權杖來向受保護的資源，例如 web API。 |
| token_type | 表示權杖類型值。 Azure AD 唯一支援的類型是 Bearer。  |
| expires_in | 存取權杖的有效期 (以秒為單位)。 |
| scope | access_token 有效的範圍。 |
| refresh_token |  OAuth 2.0 重新整理權杖。 應用程式可以使用此權杖取得目前的存取權杖到期後的其他存取權杖。  Refresh_token 的有效期很長，而且可以用來延長保留資源存取權的時間。  如需詳細資訊，請參閱 [v2.0 語彙基元參考](active-directory-v2-tokens.md)。  |
| id_token | 不帶正負號的 JSON Web Token (JWT)。 應用程式可以 base64Url 解碼此權杖來要求登入使用者的相關資訊的區段。 應用程式可以快取的值，並顯示它們，但它不應依賴它們的任何授權或安全性界限。  如需 id_tokens 詳細資訊，請參閱 [v2.0 應用程式模型語彙基元參考](active-directory-v2-tokens.md)。 |
| id_token_expires_in | id_token 的有效期 (以秒為單位)。 |


錯誤回應格式如下：

```
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。  |

## 使用存取權杖
既然您已經成功取得 `access_token`，您就可以透過在 `Authorization` 標頭中包含權杖，在 Web API 的要求中使用權杖：

```
GET /contoso.onmicrosoft.com/users
Host: https://graph.windows.net
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...
```

## 重新整理存取權杖
Access_token 有效期很短，且您必須在其到期後重新整理，才能繼續存取資源。  方法是：向 `/token` 端點送出另一個 `POST` 要求，這次提供 `refresh_token`，而不提供 `code`：

```
POST common/v2.0/oauth2/token HTTP/1.1
Host: https://login.microsoftonline.com
Content-Type: application/json

{
    "grant_type": "refresh_token",
    "client_id": "2d4d11a2-f814-46a7-890a-274a72a7309e",
    "scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...",
    "client_secret": "zc53fwe80980293klaj9823"  // NOTE: Only required for web apps
}
```

| 參數 | | 說明 |
| ----------------------- | ------------------------------- | -------- |
| client_id | 必要 | 應用程式識別碼的註冊入口網站 ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) 指派給您的應用程式。 |
| grant_type | 必要 | 必須是授權碼流程此階段的 `refresh_token`。 |
| scope | 必要 | 範圍的空格分隔清單。  在此階段中要求的範圍必須相當於或為原始 authorization_code 要求階段中所要求的範圍子集。  如果這個要求中指定的範圍遍及多個資源伺服器，v2.0 端點就會傳回第一個範圍內所指定資源的權杖。  如需範圍的詳細說明，請參閱 [權限、 同意，以及範圍](active-directory-v2-scopes.md)。  |
| refresh_token | 必要 | 您在流程的第二個階段中取得的 refresh_token。   |
| client_secret | Web Apps 所需 | 您在應用程式註冊入口網站中為應用程式建立的應用程式密碼。  它不應在原生應用程式中，因為 client_secrets 無法可靠地儲存在裝置上。  Web Apps 和 Web API 都需要應用程式密碼，其能夠將 client_secret 安全地儲存在伺服器端。 |

成功的權杖回應如下：

```
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...",
    "token_type": "Bearer",
    "expires_in": "3600",
    "scope": "https://graph.windows.net/directory.read https://graph.windows.net/directory.write",
    "refresh_token": "AwABAAAAvPM1KaPlrEqdFSBzjqfTGAMxZGUTdM0t4B4...",
    "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIyZDRkMTFhMi1mODE0LTQ2YTctOD...",
    "id_token_expires_in": "3599"
}
```
| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| access_token | 所要求的存取權杖。 應用程式可以使用此權杖來向受保護的資源，例如 web API。 |
| token_type | 表示權杖類型值。 Azure AD 唯一支援的類型是 Bearer。  |
| expires_in | 存取權杖的有效期 (以秒為單位)。 |
| scope | access_token 有效的範圍。 |
| refresh_token |  新的 OAuth 2.0 重新整理權杖。 您應該用新取得的重新整理權杖取代舊的重新整理權杖，以確定盡可能保持重新整理權杖有效的時間。  |
| id_token | 不帶正負號的 JSON Web Token (JWT)。 應用程式可以 base64Url 解碼此權杖來要求登入使用者的相關資訊的區段。 應用程式可以快取的值，並顯示它們，但它不應依賴它們的任何授權或安全性界限。  如需 id_tokens 詳細資訊，請參閱 [v2.0 應用程式模型語彙基元參考](active-directory-v2-tokens.md)。 |
| id_token_expires_in | id_token 的有效期 (以秒為單位)。 |

錯誤回應格式如下：

```
{
    "error": "access_denied",
    "error_description": "The user revoked access to the app.",
}
```

| 參數 | 說明 |
| ----------------------- | ------------------------------- |
| 錯誤 | 用以分類發生的錯誤類型與回應錯誤的錯誤碼字串。 |
| error_description | 協助開發人員識別驗證錯誤根本原因的特定錯誤訊息。  |

## 摘要
概括而言，原生/行動應用程式的整個驗證流程看起來像是這樣：

![OAuth 授權碼流程](../media/active-directory-v2-flows/convergence_scenarios_native.png)
