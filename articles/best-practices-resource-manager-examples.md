<properties
    pageTitle="實作範本最佳做法的內容範例"
    description="顯示說明最佳做法的 Azure 資源管理員範本範例。"
    services="azure-resource-manager"
    documentationCenter=""
    authors="mmercuri"
    manager="georgem"
    editor="tysonn"/>

<tags
    ms.service="azure-resource-manager"
    ms.workload="multiple"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="08/13/2015"
    ms.author="mmercuri"/>

# 實作範本最佳做法的內容範例

本主題提供如何實作 Azure 資源管理員範本的 7 個內容範例。 如需原則的概觀 
這些範例所示，請參閱 [設計 Azure 資源管理員範本的最佳作法](best-practices-resource-manager-design-templates.md)。

本主題是較大份白皮書的一部分。 若要閱讀完整的文件、 下載 [世界類別 ARM 範本的考量和已證實實務] (http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World 類別 ARM 範本-考量和證明 Practices.pdf)。

## 將已設定功能範圍的範本移至已設定端對端解決方案範圍的範本

我們稍早共用了開發已設定功能範圍的範本模式。  您可能自問的一個問題是有不同的考量 
當本身或端對端範圍的解決方案範本的一部分，請使用此功能範圍的範本。  

例如，如果有焦點的技術範本部署 SQL Server 做為功能，應該有考量，如果有的話，使用 
獨立或一部分較廣泛的端對端解決方案範圍的範本可能使用該 SQL Server 來支援 web 應用程式。

查看此案例時，最好一併查看可能涉及的資源數量。 功能範圍的範本不健全的實作， 
只是儲存體帳戶和單一 SQL Server 安裝一部 VM。 強大的功能範圍的範本將部署多個 Vm 已部署 SQL server 
高可用性。 針對某些功能 (例如 Analysis Services)，您的拓撲很可能也會具備和它一起部署的 Active Directory。

針對此案例的兩個重要考量包括將如何使用 SQL Server 的週期，以及您想要套用到其中的 RBAC。  具體而言，將 
SQL Server 先更新及刪除來自解決方案或解決方案的其他部分其餘部分的方案或將它的週期而有所不同。  如果 
生命週期會有所不同，您會想要考慮將它放置在另一個資源群組。  

另一個考量是您想要如何將 RBAC 套用到 SQL Server 已設定功能範圍的解決方案範本。  根據您想要如何套用 RBAC 內 
您的拓撲，您也可以選擇不同的資源群組來配合這些細節。  您可以套用 RBAC 在資源層級，但指定的數目 
SQL Server 功能的資源設定範圍的解決方案範本，rbac 套用到它的不同資源群組都應該要考量的事項。

另一個考量是 SQL Server 功能範圍的解決方案範本，以確認它目前會建立特定資源本身 vs 評估。 
可讓您 「 自備您自己的資源 」。  在 「 自備資源 」 (BYOR) 模型中，功能範圍的解決方案範本可讓您範本 
重複使用先前存在的資源，以儲存體帳戶、 虛擬網路或可用性設定組的典型範例。 如果 BYOR 方法不存在 
在 [設定功能範圍的範本，您可以變更使用本文稍早針對選擇性資源範本所定義的方法。  在此情況下，您 
端對端解決方案範圍的範本會有共用的資源範本含有這些常見的資源，而且會擴充功能範圍的範本 
支援這些資源成為選擇性。  這會建立較佳的已設定功能範圍的解決方案範本，因為它現在可以單獨使用或做為組合的一部分來使用。

評估是否應該從已設定端對端解決方案範圍的範本中傳入儲存體帳戶時，也應該重新評估 RBAC。 具體來說， 
您需要確保 RBAC 會套用到這個特定的資源嗎？  如果是這樣，如果已套用的層級中傳遞時預期的資源 
信任是加諸不只是在解決方案區塊，但任何使用者都想要選擇性地提供給功能範圍的範本時使用 
獨立。  如果 RBAC 很重要，則您應考慮是否要將此功能範圍的解決方案範本內的選擇性範本 
或要求它已建立與功能的必要 RBAC 範圍方案範本。

如果決定要放置在不同的資源群組中，您也可以使用資源的連結來定義資源 – 之間的關聯性，即使 
當資源會橫跨資源群組。

## 使用多個已設定功能範圍的範本來建立已設定端對端解決方案範圍的範本

這主要是前一個範例的超集。 在此案例中，某組織有多個功能範圍的解決方案範本的一組 
例如 Kafka、 Apache Hadoop、 Apache Spark 及 Apache Storm，他們想要合併在單一解決方案區塊中的資料技術。  所產生的 
撰寫將使用這些功能範圍的解決方案範本，以及共用存放裝置和虛擬網路具有特定子網路指派。

所需的其他資源可能解決方案，需要特定的功能範圍的範本之外，即使只是指令碼 
結合功能範圍的範本，並設定它們。

在此案例中，會識別出有一個共用的虛擬網路和一個共用的儲存體帳戶。  若要做到這一點，您應該將它們新增到共用 
資源範本中端對端解決方案範圍的範本，並確定已設定功能範圍範本中，並支援 「 自備資源 」 方法。 
如果沒有，您可以修改已設定功能範圍的範本來配合這一點，如上一個範例所述。

針對您將新增的其他資源，您將會遵循用來建立個別已設定功能範圍的範本的模式超集。 
在此情況下，您將共用資源範本、 選擇性資源範本、 成員節點範本和期望的狀態組態 （指令碼， 
Chef、 Puppet、 Powershell DSC) 新的資源。  具有相依性，您將使用隱含的參考和 dependsOn，盡可能進行最佳化 
若要消除偏離相依性可能會影響您部署的平行處理原則 （和速度） 的可能性。 您也會考慮生命的週期 
這些資源、 RBAC 考量及相依性，以判斷是否它們應該放在不同的資源群組中的內容。  

新增共用的資源，例如共用儲存體帳戶時您也應該評估的資源鎖定是否需要它，這樣有助於避免 
意外刪除。

當加入新的資源，您也應該檢查是否可以隔離出來的任何資源新增到端對端解決方案範圍的範本 
做為本身的功能範圍範本。  如果是的話，這應該強烈視為將可提供的優點分解進一步升級 
重複使用和測試。

整合解決方案區塊中，當您後續考量如下 ︰ 如同上述範例中，以確認中的個別的生命週期 
設定功能範圍的解決方案範本更廣泛解決方案的不同，而且如果任何 RBAC 需求就必須將這些分隔成 
不同的資源群組。

最後，您會希望考慮是否想要能夠定義和查詢資源之間的連結。 如果您這樣做，將會運用的資源連結 
可讓您執行這項操作在端對端範圍的解決方案範本中，即使是跨越多個資源群組。

## 利用部分開/關模式建立已設定端對端解決方案範圍的範本

這個案例是前一個案例的變化。  在此案例中，客戶會在一天的行程中以固定間隔來從內部部署系統中擷取資料。  
他們具有資料管線來處理這個內送的資料，以及一律可使用資料進行查詢的關聯式資料存放區。  由於雲端是 
隨用隨付模型中，客戶會想要顯示為可處理資料時，才在這些間隔有資料管線運作。

做為其資料管線的一部分，它們具備 SQL Server，來接收已處理的資料，並使用它來進行查詢。 客戶表示， 
雖然他們想要開啟的擷取和處理個固定的排程上開啟和關閉管線，他們想要永遠有可用的 SQL Server。

在此案例中，有出現在生命週期中顯著的差異，而且可能一些其他考量客戶尚未 
引發，但應進行評估。

如前所述，在將建立和刪除其他資源的同時，SQL Server 部署會保持運作。  它們將一起部署一開始 
但是，範本的其他成員則會終結並建立不同的生命週期。  這些可以隔離到不同的資源群組，或者是 
資源鎖定套用至 SQL Server 資源的相同資源群組中的左邊。  SQL Server 特別是，先前的範例中所述 
可能表示成較大的一組資源，分開到它本身的資源群組較為適當。

另一個考量是，雖然客戶人說他們想資料管線的其餘部分
啟用或停用排程，它們可能不會考慮採用行為的報告系統。  不是協力廠商排程的傳遞資料 
一律精確 – 連線可能會無法使用的一段時間，在本機上的時鐘或雲端架構伺服器可能會漂移、 時間的變更可能會或可能不會 
預期，等等。如果您的擷取機制應該用於開啟/關閉模式，而且如果是，如果週期較大應該要評估 
比處理元件。

如果您使用 Azure Data Factory 或事件中心等受管理的服務，這是不是問題的作業模型與相關聯的計費方式 
它們讓隨時可供擷取您的資料，並將它放在儲存體中。  如果您使用另一項技術，例如 Kafka 已部署至虛擬機器 
機器，您可能要查看的方式進行，並擷取所需的相關聯的儲存體帳戶的生命週期。  這可能會導致 
放置在不同的資源群組會根據其週期擷取和處理資源。

## 支援訂用帳戶內的不同環境

為了有效提供服務，許多組織都有一組規模，計費隔離、 權責隔離，以及地理隔離需求，必須 
符合條件。  設計適用於 Azure 的服務時，他們會利用他們的方法來進行過去曾使用的訂用帳戶資料分割，以滿足這些需求。  

資源管理員會放寬可部署的訂用帳戶內的特定類型的資源數目的條件約束，也會引進資源群組 
RBAC 及稽核。 這些項目的組合讓組織能夠使用資源群組進行資料分割，讓它們符合其需求和 
減少，如果有的話，可能要進行資料分割的訂閱。  

本節探討適用於這些環境類型的需求，並提供如何傳遞使用 ARM 來滿足它們之環境的相關指引。  

### 隔離考量

本節將更詳細地探討適用於環境、計費及地理位置隔離的常見客戶驅動程式。

#### 環境隔離

服務擁有者想要隔離他們的不同環境。  每個隔離的環境可讓小組能夠有更精細 
控制誰可以存取的環境。 雖然可能更開放方面誰可以存取它們，做為開發環境 
環境範圍更接近實際執行的使用者數目是這些人為或，以減少系統帳戶的自動化 – 
相容性和整體風險降至最低。

#### 計費隔離 - 開發與執行服務

為了精確地反映成本的貨物銷售 (COGS) 和營業費用 (OpEx)，企業擁有者想要能夠打散研究的成本 
和建置與執行服務的服務。  

環境隔離的超集先前所述，其目的是開發和測試個別的彙總及 （或) 
先前的生產環境會維持獨立，後者的計費彙總。

#### 計費隔離 - 將透明度和權責加入服務取用成本中

計費隔離也可用於特定團隊，並引進適當平台取用相關的成本中增加透明度 
層級的責任。

雖然雲端非常有彈性，並可供隨用隨付模型，這是較不熟悉一些來自非雲端模型的開發人員，硬體 
購買中，擁有。 在非雲端模型中，有個實體的 「 機器 」 上會開啟，而且有數目限制 
誘因有限縮小範圍，或關閉非使用中的資源。  未完成的許多情況下，此專用硬體採購 
開發人員使用它。

藉由隔離訂用帳戶，並將這些訂用帳戶的權責指派給特定團隊，服務擁有者發現這種類型的訂閱 
資料分割驅動並強制執行所需的行為很有幫助。

#### 地理導向的隔離 - 特有且受到特定地理位置之法律所規範的部署

在某些內容中，會針對特定的地理位置的服務需要考慮它們如何部署至位址的需求 
相容性考量。

雖然服務可能是全域的性質，位於內部或提供服務給特定地理位置的部署可能會受到操作 
人員的需求。 具體而言，具有特定國家/地區或國家/地區組合的居民和 （或） 傳遞特定背景檢測的唯一人員 
處理程序操作這些服務。

地理位置隔離也提供了利用新的平台服務和功能的優點。 某些地理位置，例如中國，可能會 
有可用的平台服務的子集和/或已延遲平台服務的部署。  

地理位置隔離讓團隊能夠發展他們充分利用新的或增強的平台服務和功能的服務位置 
加以使用。

### 相容性考量

服務可以跨多個地理位置傳遞至縱向市場。 這些對象通常具有機密資料或處理程序中包含 
他們的應用程式且有設計來保護它們以及稽核業務開發與它們相關聯的標準規定。

#### 分隔角色和責任

分隔角色與責任是內部服務要與內部原則相容的主要需求。 許多商業服務也需要 
此選項可繼續遵循政府與業界法規的指導方針。  服務需要限制存取服務和其基礎的資源 
若要授權角色在特定情況下。 許多服務已建立樣板來提供下列兩個功能：RBAC 和稽核。

#### 角色型存取控制 (RBAC) 使用案例

在相容性案例中，請務必限制某些資源的存取權。  

例如，當多個相容性的案例相關的健全狀況資訊、 財務資料，查看機密資料 
稅務記錄等很重要的人可以存取、 檢視或操作的資料，使其只需要數目限制 
存取權來執行上層組織業務。

在已識別的情況下，RBAC 可為不同的個人、系統或群組提供特定資源的存取權。

#### 稽核

除了 RBAC 所提供的存取限制之外，組織也需要稽核資源存取，以及與資源之間的互動。

### 使用 Azure 資源管理員進行實作

組織先前就曾使用訂用帳戶資料分割來達成這些目標。 儘管可行，但這不理想。  建立 
訂用帳戶實際上是商務活動、 服務管理 API 不會公開一個機制可以用來建立或刪除新的訂閱 
自動和以手動方式建立所需的訂閱。 產生訂閱的數目可能會大幅 – 成長的非常大型的服務 
例如，Microsoft 擁有商業服務 – 數目無法跨越到超越一千訂用帳戶。  這通常會導致建立 
自訂樣板，來建立和管理組織的訂閱。

使用資源管理員，在一個訂用帳戶內部署多個環境會變得更容易。  它會放寬先前固定大寫字的資源 
這是在先前的模型，可大幅減少因資源限制而分割區。

環境可以放置於資源群組中，可將特定的 RBAC 套用到它們，讓您能夠提供環境隔離。  在案例 
在需要地理位置隔離，這也可以完成利用資源群組。 為資源群組可橫跨地理位置、 特定的隔離 
針對一或多個地理位置可以達成。

您可以將標記套用到資源和資源群組，在進行帳單彙總和摘要檢視時用來提供計費隔離。  您可以使用標記 
若要定義環境類型 （研究、 教育、 開發、 測試、 生產）、 權責組織或個人 （"HR"、"Finance"、"John Smith"、"Jane Jones"）。

稽核需求會當成基礎 Azure 資源管理員的一組全新功能來提供，並可在中央位置進行檢視。

結束客戶會有帳戶會用於驗證和角色的 Azure Active Directory 中註冊基礎的存取控制 
環境和資源。

#### 將密度最佳化

儘管已在 Azure 資源管理員中放寬資源限制，但仍會有限制。 除了建立環境本身，也應該 
看看在 [訂閱] 以及環境的達成密度。  傳遞環境個人或組織提供容量和 
您應該評估哪些相關 「 t 恤尺寸 」 您會想要傳遞。  具體而言，找出小型、 中型、 大型和額外之間的變化 
所需的資源方面的較大客戶。  

您可以選擇針對不同的 T 恤尺寸使用不同的訂用帳戶來達成更高的密度。 例如，您可能可以容納 1000年小 
t 恤尺寸環境、 500 個中型部署、 100 個大型部署和指定的訂用帳戶中的 10 個超大型部署。  因為沒有不計費 
成本有多個訂閱，您可能想要隔離到不同的訂用帳戶，以提供最大密度不同大小。  這可以 
相對適用且易於管理的狀況下的訂閱數。

您是否願意允許客戶增加或變更其 t 恤尺寸，若是如此，用來識別您應該會有一個重要考量 
想要如何配合它。  

其中一個方法是讓客戶可以在其現有的資源群組內取得額外容量。  這很容易達成技術上來說， 
但是對密度造成影響。  而不是所有客戶清楚定義的大小，這會引入更多額外負荷的變化性層級 
為將密度最佳化。  如果每個小型環境的大小是 X，您可以輕易地預先計算多少個小型環境中放置 
取得最佳密度的訂閱。  若允許客戶自訂環境，結果是變化與數量產生無法預測數目 
環境可能是 X、 X + 1、 X + 2，等等。使用這個變化性層級，就能達成較低密度，如此您就需要預留容量 
在訂用帳戶來容納這些變異數。  

儘管可行，但比起一般處理方法來說這是不盡理想的，雖然它可達成較低密度，但需要更多要管理的額外負荷。 針對較大大小 
環境中，這可能是更可行的選項。  這些大型和超大型環境數目較少會放在訂閱中，您可以選擇 
若要將較少的訂用帳戶，以因應成長中。

另一種方法是刪除客戶目前大小的環境，並建立不同大小的新環境。  不適合 while 
某些情況下，這非常適合暫時使用例如開發和測試環境的環境。

下一個最簡單這裡的方法是讓客戶能夠取得較大尺寸的環境和管理移轉到該環境 
靠自己。  比方說，在小型環境中有 SQL Server 部署的客戶能夠購買中型環境，就是個別 
負責傳輸資料與自訂狀態。

替代的方法是提供受管理的服務，以配合這個從某個大小到另一個大小的轉換。 這是很明顯地更為複雜，但 
根據工作負載和客戶這可能是您的組織可能願意配合的項目。

## 提供含有其他客戶原則限制的環境

某些組織對於他們部署的環境具有額外的需求與原則。 具體來說，它們有限制的原則 
連接埠對外，可能需要監視環境的輸入和輸出流量的原則。
針對支援能力和成本考量，也可能會限制使用者可以建立、更新或刪除哪些資源。
針對提供環境的組織，他們通常也需要存取訂用帳戶以取得支援。

前一個案例中的超集，這項作業需要的特定資源，其中會有其他限制誰可以加入和 
無法建立指定類型的資源。  

您可以使用角色型存取控制，來限制使用者建立、更新或刪除特定資源的能力。  範例包括 
要求特定的組織網路的 VNET 與潛在客戶無法更新或刪除的子網路。

您可以實作資源鎖定來建立唯讀或無法刪除的資源。 RBAC 可用來允許使用者或服務主體 
若要執行特定活動，對資源或資源群組。

如果組織需要該特定流量，例如應用程式，在各層之間的流量會先經過的媒介，例如虛擬機器 
網路應用裝置、 使用者定義路由應該使用。

虛擬應用裝置無非就是一個 VM，可執行用來以某種方式處理網路流量的應用程式，例如防火牆或 NAT 裝置。 
有許多協力廠商會在 Azure 上提供虛擬網路應用裝置，而組織也可以自備。

「自備」應用裝置的方法讓組織能夠重複使用現有的程式碼，該程式碼可能已在其內部部署環境中使用。 此虛擬 
應用裝置 VM 必須能夠接收未定址到本身的連入流量。 若要讓 VM 接收定址到其他目的地的流量 
您必須啟用 IP 轉送 VM 中。  

如同先前的範例，您應檢閱資源的週期和 RBAC 限制，並將其視為資源群組策略的一部分。

## 保護資源以防止內部的不良執行者

針對組織的其中一個考量可能是保護他們的資源，以及由不良執行者佈建它們的範本。  

其中一個例子可能是銀行希望確保惡意軟體開發人員或成員的 IT 人員不會進行修改或 
擷取重要資訊，因而導致資料流向不良的執行者基於犯罪目的。

一般企業案例是將受信任的操作員可以存取所部署的工作負載中的重要密碼一小群 
與更廣泛的開發/操作人員可以建立或更新 VM 部署群組。  

Azure 金鑰保存庫可與 ARM 搭配使用，來協調和儲存 VM 密碼和憑證。

最佳的做法是維護個別的 ARM 範本 （其中將包含金鑰內容） 的保存庫的建立及部署 Vm 
（URI 參考包含在保存庫中的索引鍵）。

金鑰保存庫中儲存的密碼受到受信任的操作員的完整 RBAC 控制。  如果受信任的操作員離開公司或轉移內部 
該公司以新的群組，他或她將不再有他們在保存庫中建立的金鑰存取權。

部署的 ARM 範本僅包含機密資料的 URI 參考也就是說，實際的密碼不在程式碼、 組態或原始程式碼的程式碼 
儲存機制。 這樣做可降低以網路釣魚方式詐騙密碼的機會，以及限制不良執行者進行變更的能力。

如同文件稍早所述，並未提供通用的金鑰保存庫。 由於金鑰保存庫永遠是地區性的，因此，密碼與 VM 永遠具有區域性 (以及主權)。

這種方法的實作範例已在＜密碼和憑證＞一節中提供，您可以在本文件稍早內容中找到此節。

## 啟用「自備訂用帳戶」模型

企業 IT、系統整合者和雲端服務廠商可能會對客戶採用「自備訂用帳戶」模型。  具體來說， 
組織提供服務給客戶，並利用該客戶的 Azure 訂閱，以相同的方式。

這個方法有各種不同變化，每個都有些微不同的需求，詳情如下。

### 讓協力廠商有權監視帳戶內的資源

具有監視應用程式的組織可能需要客戶訂用帳戶的唯讀存取權，來擷取要在該應用程式中使用的資料。 
此動作在持續使用期間都需要有唯讀存取權。  存取必須是在客戶的控制項中，提供它們的能力 
如果切斷監視服務的提供者的關聯性，終止存取權。

#### 使用 Azure 資源管理員進行實作

在 「 開發人員指南來驗證與 Azure 資源管理員 API 」 提供的實作此詳細資料的 
您可以找到 [這裡](http://www.dushyantgill.com/blog/2015/05/23/developers-guide-to-auth-with-azure-resource-manager-api/)。 提供文件 
逐步實作指示，以及範例程式碼。

### 讓協力廠商能夠存取一次性部署的軟體

在另一個範例中，組織可能會部署及設定其軟體的版本中客戶的帳戶，需要一段的寫入權限 
部署時間。

#### 使用 Azure 資源管理員進行實作

這會遵循類似先前範例的方法。

根據安裝的特定需求，指派給服務主體的特定角色應該允許存取的最小層級 
才能完成安裝，並接著便可完成安裝之後立即撤銷該存取。

### 讓協力廠商有權使用客戶的訂用帳戶來儲存資料

在另一個範例中，組織可能想要在自己的環境中執行軟體，但使用客戶的帳戶來儲存。 將放在客戶 
控制他們的資料在任何時候，使其能夠運用平台，例如 Azure Machine Learning 或 HDInsight 上的其他技術及其 
自行斟酌不增加成本/計費額外負荷企業 IT、 系統整合者或 CSV 功能。 這需要持續存取 
儲存體帳戶的組織，在客戶的控制項，並有權存取稽核資訊存取該資訊。

#### 使用 Azure 資源管理員進行實作

這是使用與其他範例相同的模式來實作。 服務主體會被授與儲存體資源的存取權。  由於此案例需要 
具有讀取和寫入儲存體帳戶，內建的參與者角色會指派給服務主體，以達到此層級的存取權限角色。

因為此案例涉及具有共用儲存體帳戶的第一個和第三個合作對象，也會想来確定儲存體帳戶 
不會遭到意外刪除。  針對這方面的案例，您會將資源鎖定套用到儲存體帳戶。

### 透過協力廠商啟用服務管理

在另一個範例中，組織想要部署、監視和管理客戶訂用帳戶中的軟體。 可能有客戶限制 
變更方面它們可以 （或更明確地無法） 進行軟體部署的環境。

#### 使用 Azure 資源管理員進行實作

這會遵循本節一開始所識別的模式超集。 具體而言，提供第 3 方所使用的服務主體 
資源群組內資源的完整存取權。

此外，如果有客戶限制，就會為來自客戶的使用者或群組授與適當的權限來利用環境。  
這可透過範本來完成，如本節稍早內容中所提及。

最後，可能想要確保特定資源不會遭到意外刪除。  如果這種情況，也應該是資源鎖定 
被視為要求這類保護的資源。

## 後續步驟

- 若要了解如何建立範本，請參閱 [編寫範本](resource-group-authoring-templates.md)。
- 如需有關如何在 Azure 資源管理員的安全性建議，請參閱 [Azure 資源管理員的安全性考量](best-practices-resource-manager-security.md)。
- 若要深入了解進出範本的共用狀態，請參閱 [Azure 資源管理員範本中的共用狀態](best-practices-resource-manager-state.md)


