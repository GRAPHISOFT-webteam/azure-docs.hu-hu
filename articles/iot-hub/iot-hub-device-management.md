<properties
 pageTitle="IoT 裝置管理 |Microsoft Azure"
 description="使用 IoT 中樞和 IoT 套件管理 IoT 裝置概觀"
 services="iot-hub,iot-suite"
 documentationCenter=""
 authors="juanjperez"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="11/10/2015"
 ms.author="sethm"/>


# 使用 Azure IoT Suite 和 Azure IoT 中樞管理 IoT 裝置

Azure IoT Suite 和 Azure IoT 中樞提供的基本功能可供進行 IoT 解決方案的裝置管理 (大規模)，以及管理各種不同的裝置和裝置拓撲組合。 本文提及的裝置管理與 IoT 裝置管理特別有關。

## 簡介

服務提供者和企業 (或任何維護大量 IoT 裝置的組織) 會使用裝置管理功能來完成下列商務程序︰

* 註冊與探索 IoT 裝置
* 啟用連線。
* 遠端設定以及更新裝置上的軟體。 例如，管理製造廠或油田中的裝置時，會有遠端設定和更新裝置的原則，其中包含核准鏈、法規稽核需求、實體保護措施的目前狀態等等。

為您的 IoT 解決方案啟用 IoT 裝置管理時，請考慮下列功能並依據您的企業目標判斷其重要性︰

* * *[裝置佈建和探索](#device-provisioning-and-discovery)* *: 透過此系統中註冊裝置的程序。
* * *[裝置登錄和裝置型號](#device-registry-and-device-models)* *: 裝置型號中的系統和驗證方法所代表的裝置關聯性、 角色中繼資料結構化的使用。
* * *[裝置存取管理](#device-access-management)* *: 如何裝置控制裝置資源從雲端服務的存取。
* * *[遙控器](#remote-control)* *: 如何遠端使用者存取裝置，並指示要變更的裝置。
* * *[遠端系統管理](#remote-administration-and-monitoring)* *: 讓系統管理員定義裝置母體擴展的健全狀況的處理程序。
* * *[遠端組態](#remote-configuration)* *: 系統管理員變更裝置設定的方法。
* * *[遠端的韌體和軟體更新](#remote-firmware-and-software-update)* *: 讓系統管理員可以更新裝置的韌體和軟體的程序。

下列各節將更深入說明上述每項裝置管理功能，並提供高階模型以利用 Azure IoT 中樞來實作這些功能。

## 裝置佈建和探索

您可以使用登錄 API，利用 Azure IoT 中樞佈建裝置。 當您登錄裝置並提供或接收金鑰之後，您的裝置即可使用該金鑰連接至 IoT 中樞。 Azure IoT 中樞只會與出具授權認證的已登錄裝置進行通訊。 系統管理員可以透過裝置系統管理入口網站，讓裝置停止存取 Azure IoT 中樞。

可以使用的啟動程序取決於 IoT 裝置的製造、佈建和部署方式。 您可以在解決方案中建置啟動程序服務，以提供簡單連線功能，並延遲將裝置指派給特定 IoT 中樞的程序。 製造裝置時，有可能不知道裝置所要運作的位置。 這是具有大量且可能相當複雜之工作流程的唯一範例，這些工作流程有助於讓 Azure IoT 中樞得知裝置，而且此裝置也會與現有的商務程序整合。

使用啟動程序服務時，IoT 裝置會啟動並發出要求，而該裝置最終可能提供指派之 Azure IoT 中樞的存取權。 要求應包含裝置啟動程序認證和任何其他必要的資料。 對於授權的裝置，啟動程序服務應向指派的 Azure IoT 中樞登錄此裝置並提供連線詳細資料給要求啟動程序的裝置。 IoT 中樞會提供連線詳細資料給要求啟動程序的裝置。

## 裝置登錄和裝置模型

使用「裝置模型」**一詞來表示包含雲端服務可讀取或寫入之裝置屬性的模型。 其中也包含雲端服務可從遠端執行的裝置命令。 在下一節所述的服務導向模型中，裝置並不知道此模型，但雲端服務仍可追蹤和使用裝置的中繼資料。

對 IoT 系統和裝置登錄的角色而言，儲存裝置資訊和相關聯的中繼資料極為重要。 對於無法變更的舊版裝置或未使用裝置模型的裝置，這種情況尤其顯著。 服務導向模型可以啟用 IoT 服務來與裝置母體互動。 當裝置使用已定義的模型運作時，裝置登錄可做為裝置資料的一致檢視 (以裝置為主)。 在此情況下，服務會通知裝置其所需的變更，而變更會在裝置確認之後才會生效。

### 服務導向模型

如果裝置連接到 Azure IoT 中樞且未提供裝置模型，請務必實作裝置登錄，以追蹤已登錄的裝置及其相關聯的中繼資料。 在此情況下，裝置登錄是裝置中繼資料的唯一儲存位置。 您可能想要追蹤的裝置中繼資料範例包含邏輯拓撲 (例如 109 號建築的 4 樓)、裝置功能 (例如門口感應器) 或任何其他標記資訊。

### 裝置導向模型

為了讓 IoT 解決方案能夠運用 IoT 裝置的功能，裝置必須在連接到 IoT 中樞之後向雲端自我介紹。 以下是可以在 IoT 解決方案中使用的兩種裝置型號︰

#### 自行定義的裝置模型

裝置工程師 (或使用裝置模擬器的開發人員) 會在建置裝置時逐一查看裝置功能，藉以使用自行定義的裝置模型。 裝置工程師一開始可以建立具有一些屬性和支援命令的裝置，稍後再加入更多的屬性。 同樣地，該裝置工程師可能有許多裝置，而每個裝置可提供獨特的功能並使用自行定義的模型。 在此情況下，裝置工程師不需要註冊裝置模型的結構。 擴充成大量裝置時，自行定義模型的顯著差異帶來一些挑戰。

#### 預先定義的裝置模型

在網路和電源或處理條件約束之下運作的生產 IoT 部署大大受惠於預先定義的裝置模型，在該模型中會使用最少的裝置處理和耗電量。 同樣地，裝置能夠透過異質性網路 (WiFi、2G/3G/4G、BLE、Sat 等) 傳輸最小的網路流量，特別是在使用有限且昂貴的基礎結構 (例如衛星) 時。 在實作預先定義的裝置模型時，裝置工程師可能會傳送以一或兩個位元組 (在預先定義的裝置模型中做為索引鍵) 編碼的裝置資訊。 這個方法很簡潔，相較於自行定義的裝置模型，效率可增加一到兩倍。

### 遠端監視預先設定的解決方案及其裝置模型

Azure IoT Suite 遠端監視預先設定的解決方案會實作自行定義的裝置模型。 使用此模型，可讓您在定義及發展您的裝置功能時快速反覆運算。

遠端監視預先設定的解決方案用來建立裝置物件，然後將它傳送到服務的程式碼定義於 **Simulator/Simulator.WorkerRole/SimulatorCore/Devices/DeviceBase.cs** 中。 查看 `SendDeviceInfo` 和 `GetDeviceInfo` 方法，您可以看到如何建立並傳送至 Azure IoT 中心自我描述的裝置型號。

雲端服務用來處理裝置模型相關事件的程式碼位於 **EventProcessor/EventProcessor.WorkerRole/Processors/DeviceManagementProcessor.cs**。 大部分的工作相關的裝置與模型相關訊息會傳送到預先設定的方案的服務端上作用中發生 `ProcessJToken`方法。

一旦收到裝置與模型相關的訊息時，這些方法 `UpdateDeviceFromSimulatedDeviceInfoPacketAsync` 和 `UpdateDeviceFromRealDeviceInfoPacketAsync` 中 **DeviceManagement/Infrastructure/BusinessLogic/DeviceLogic.cs** 接著會負責更新裝置登錄。 您可以在 **DeviceManagement/Web/WebApiControllers/DeviceApiController.cs** 中找到遠端監視預先設定的解決方案中的裝置登錄 API。

### 現場閘道器裝置模型

對於無法或不得直接連接網際網路的裝置而言，現場閘道器通常用來進行連線和通訊協定轉譯。 如果您要建置的裝置是現場閘道器，它可以表示在與 Azure IoT 中樞的所有互動中透過現場閘道器連接的裝置。 身為現場閘道器的製造者，您要負責實作裝置通訊協定與 IoT 服務所支援的通訊協定之間的轉譯。 如果您要讓現場閘道器能夠連接 BLE (藍牙低功耗) 裝置，您必須實作裝置的 BLE 介面和 Azure IoT 中樞的介面。

## 裝置存取管理

IoT Suite 預先設定的解決方案可控制不同裝置層面的存取，包括裝置屬性的讀寫存取權限以及裝置命令的執行權限。 在預先設定的解決方案中，此存取權是在裝置系統管理網站中利用 Azure Active Directory (AAD) 來控制。 在預先設定的解決方案中延伸 AAD 的使用，即可啟用以角色為基礎的存取安全性。

## 遠端控制

遠端控制已超出 Azure IoT Suite 預先設定的解決方案的案例範圍。 不過，以下是可用來在 IoT 解決方案中啟用遠端控制之選項的整體分析。

在 IT 案例中，遠端控制通常用來協助遠端使用者或在遠端設定遠端伺服器。 在 IoT 案例中，大部分的裝置不需要使用者操作，因此遠端控制使用於遠端設定和診斷案例。 使用兩種不同的模型可以實作遠端控制：

* **直接連接**
  啟用遠端控制的裝置 (例如，在 Linux 上，在 Windows 中，或透過遠端偵錯工具的遠端桌面的 SSH) 的直接連接到您必須能夠建立連接至裝置。 假設暴露開放式網際網路裝置的安全性風險，建議您先使用轉送服務 (例如 Azure [服務匯流排轉送服務](service-bus-relay-overview.md)) 才能連接和資料傳輸至 blob 或從該裝置。 由於轉送連線是來自裝置的輸出連線，所以有助於限制裝置上開啟的 TCP 連接埠的受攻擊面。

* **裝置命令**
  遠端控制透過裝置的命令會利用現有的連線和裝置與 Azure IoT 中心之間建立通訊通道。 若要啟用裝置命令型遠端控制，您必須遵循下列需求：
  * 在裝置上執行的軟體必須通知 IoT 服務︰裝置命令已可在裝置上使用。 這通常會定義為裝置模型的一部分。
  * 在裝置上執行的軟體必須實作遠端控制命令。 這些裝置命令應遵循一個要求 (從 IoT 服務到裝置) 和一個回應 (從裝置到 IoT 服務) 模式。 執行裝置命令可能會影響裝置狀態，而且必須在裝置登錄中更新這個新狀態。

當裝置是裝置組態和狀態的主要存放區時，裝置登錄會使用最終一致的模型，而且必須將裝置狀態變更推送到裝置登錄。 從 IoT 服務到裝置的要求可以強制更新裝置登錄狀態，或者裝置可以在辨識系統狀態中的變更時自動更新服務。 從裝置自動更新此服務可能會產生大量網路流量，並增加裝置處理器和可用的電源使用量。

## 遠端系統管理和監視

因為大部分的 IoT 裝置會區分運作與管理使用者角色，所以遠端系統管理這個方法可讓系統管理員用來監視其裝置的狀態、設定從裝置到商務程序和應用程式 (例如 CRM、ERP、維護系統等) 的資料流程，以及透過使用裝置命令從遠端更新裝置的狀態或組態。

Azure IoT Suite 預先設定的解決方案提供一個 Azure 網站，可讓您著手將裝置系統管理體驗延伸至垂直 IoT 解決方案中的案例。

系統管理員會將裝置健康情況界限定義為裝置操作資料 (通常移動快速) 和裝置中繼資料 (通常移動緩慢) 的功能。 您可以使用規則來啟用裝置的健全狀況警示系統，透過資料流處理引擎實作 (例如 [Azure 串流分析](https://azure.microsoft.com/services/stream-analytics/)), ，與輪詢策略。

## 遠端設定

在裝置生命週期的某些階段，從遠端變更裝置組態是非常重要的︰佈建、診斷，或與商務程序整合。 結合裝置模型與 IoT 服務從遠端更新裝置模型執行個體狀態的能力，就能夠進行遠端組態變更。

在遠端監視的預先設定解決方案中，裝置聲稱它可支援下列命令來設定遠端組態︰

* ChangeKey
* ChangeConfig
* ChangeSystemProperties

這些裝置命令不會在預先設定的解決方案裝置系統管理網站中顯示為可用的裝置命令，因為它們是裝置命令，並且是由入口網站的特定部分從遠端執行的。 一旦裝置收到裝置命令之後，通知回應就會從裝置傳送到服務。 在處理裝置命令之後，裝置會傳送結果回應來通知服務︰裝置命令執行成功 (或失敗，並包含錯誤碼)。 此時，會在裝置上確認裝置所需的狀態並更新裝置登錄。

## 遠端韌體與軟體更新

遠端韌體和軟體更新是 IoT 系統的一項重要功能。 更新可讓裝置執行最新且最安全的軟體。 遠端更新裝置上的韌體與軟體是一個分散式長時間執行的程序，通常會牽涉到商務程序。 例如，在控制高性能燃油幫浦的裝置上更新韌體時，可能需要在相鄰的系統中進行一些步驟，以便在執行及驗證更新時重新運送燃油。

### 韌體更新分析

以下範例有可能用來實作可能符合您商務需求的韌體更新。 此範例的目標在於簡述程序的各項考量，而不是強加特定實作。 設計您的更新需求時，必須考慮許多超出本文範圍的商務和技術因素。

裝置更新起始於 IoT 服務，而裝置會透過裝置命令在預定的時間接獲通知。 當裝置明確支援韌體或軟體的遠端更新時，IoT 服務應根據已定義的商務程序和原則來傳遞更新命令。 收到要更新的裝置命令時，裝置必須下載並部署更新套件、重新開機至新部署的組態 (在韌體更新的情況下) 或啟動新的軟體套件，並確認新的韌體或軟體正如預期般執行。 在這個多步驟的程序中，裝置必須通知 IoT 服務有關裝置在各步驟中的狀態。

儲存體服務 (如 Azure 儲存體) 或內容傳遞網路 (CDN) 可以傳遞更新套件。 在套用韌體或軟體更新之前，請務必驗證所下載的套件完整性，以確保此套件源自預期的來源。

完成韌體更新後，裝置必須能夠驗證及識別良好的狀態。 如果裝置無法成功進入該良好的狀態，裝置上的軟體應開始回復至已知的良好狀態。 已知的良好狀態可能是最後已知的良好狀態，或是儲存體分割中儲存的裝置韌體映像 (所謂的「黃金狀態」**)。

## 後續步驟

若要深入了解 Azure IoT 中樞，請參閱這些連結：

* [開始使用 ][]
* [什麼是 Azure IoT 中心?[]][]
* [連接裝置]][]


[get started with iot hub]: iot-hub-csharp-csharp-getstarted.md 
[what is azure iot hub?]: iot-hub-what-is-iot-hub.md 
[connect your device]: https://azure.microsoft.com/develop/iot/ 

