<properties
   pageTitle="Service Fabric 可靠的服務程式設計模型概觀"
   description="深入了解 Service Fabric 可靠的服務的程式設計模型，並開始撰寫自己的服務。"
   services="Service-Fabric"
   documentationCenter=".net"
   authors="masnider"
   manager="timlt"
   editor="jessebenson; mani-ramaswamy"/>

<tags
   ms.service="Service-Fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="11/17/2015"
   ms.author="masnider;jesseb"/>


# 可靠的服務概觀

Service Fabric 可簡化撰寫和管理可靠的無狀態與具狀態服務。 這份文件會討論：

1. 無狀態和具狀態之服務的可靠的服務程式設計模型。
2. 撰寫可靠的服務時必須進行的不同選擇。
3. 可靠的服務使用時機及撰寫方式的一些不同案例和範例。

可靠的服務是 Service Fabric 上可用的其中一種程式設計模型。 如需可靠執行者程式設計模型的詳細資訊，請參閱 [簡介](service-fabric-reliable-actors-introduction.md)。

在 Service Fabric 中，服務包含組態、應用程式程式碼，以及 (選擇性的) 狀態。

Service Fabric 會管理服務的存留期間，從佈建和部署一直到升級和刪除透過 [Service Fabric 應用程式管理](service-fabric-deploy-remove-applications.md)。

## 什麼是可靠的服務？

可靠的服務提供您簡單、功能強大、最上層的程式設計模型，以幫助您表達對您的應用程式而言重大的事情。 使用可靠的服務程式設計模型，您得到：

1. 對於具狀態服務，可靠的服務程式設計模型可讓您使用可靠的集合，一致且可靠地在服務內儲存您的狀態。可靠的集合是一組簡單的高可用性集合類別，使用過 C# 集合的人都會熟悉它。 傳統上，服務需要外部系統來進行可靠狀態管理。 有了可靠的集合，您可以將狀態儲存在您的計算旁邊，並且具有您預期高度可用的外部存放區會具備的相同高可用性和可靠性，以及共置計算和狀態所提供的額外延遲改善。

2. 執行您自己的程式碼的簡單模型，看起來就像您習慣的程式設計模型：您的程式碼具有定義完善的進入點和容易管理的生命週期。

3. 可外掛式通訊模型: 使用您的選擇，例如使用 HTTP 傳輸 [Web API](service-fabric-reliable-services-communication-webapi.md), 、 WebSockets、 自訂 TCP 通訊協定等。可靠的服務提供一些很棒的現成選項供您使用，或允許您提供您自己的選項。

## 可靠的服務有什麼不同之處？

Service Fabric 中的可靠的服務與您之前撰寫的服務不同。 Service Fabric 提供可靠性、可用性、一致性和延展性。

+ <u>可靠性</u> -您的服務會維持啟動，即使在不可靠的環境，您的機器可能會失敗或遭受網路問題。

+ <u>可用性</u> -您的服務可連線且回應速度快 (這並不表示您不能有找不到或從連線到服務之外)。

+ <u>延展性</u> – 服務與特定硬體分離並不能成長或壓縮視需要透過加入或移除硬體或虛擬資源。 服務可以輕鬆分割 (特別是在具狀態的情況下)，以確保服務的獨立部分可以獨立調整和回應失敗。 最後，Service Fabric 鼓勵輕量服務，它允許在單一處理序內佈建數千個服務，而不需要或讓整個作業系統執行個體專屬於特定工作負載的單一執行個體。

+ <u>一致性</u> -這表示，此服務中儲存任何資訊可以保證是一致 (這只適用於具狀態服務有更詳細的更新版本)

## 服務生命週期

無論您的服務是具狀態還是無狀態，可靠的服務會提供簡單的生命週期，可讓您快速插入您的程式碼，並開始著手。 您真正只有需要實作一個或兩個方法，即可讓您的服務啟動並執行。

+ CreateServiceReplicaListeners/CreateServiceInstanceListeners：這是服務定義它要使用之通訊堆疊的地方。 通訊堆疊，例如 [Web API](service-fabric-reliable-services-communication-webapi.md), ，以及如何顯示這些訊息最後的服務程式碼的其餘部分互動定義 (如何用戶端連線)，服務接聽的端點。

+ RunAsync：這是您的服務執行其商務邏輯的地方。 所提供的取消語彙基元是針對該工作何時應該停止的訊號。 比方說，如果您的服務需要不斷從 ReliableQueue 提取訊息並加以處理，這會是該工作會發生的位置。

可靠的服務的生命週期中的主要事件如下：

1. 建構服務物件 (衍生自 StatelessService 或 StatefulService 的項目)。

2. 會呼叫 CreateServiceReplicaListeners/CreateServiceInstanceListeners 方法，讓服務有機會傳回其選擇的一個或多個通訊接聽程式。
  + 請注意這是選擇性的，雖然大部分的服務會直接公開某個端點。

3. 一旦建立通訊接聽程式，即會予以開啟。
  + 通訊接聽程式有一個稱為 OpenAsync() 的方法，此時會呼叫該方法並傳回服務的接聽位址。 如果您的可靠的服務使用其中一個內建 ICommunicationListener，那麼便會為您處理。

4. 通訊接聽程式為開啟之後，會在主要服務上呼叫 RunAsync() 方法。
  + 請注意，RunAsync 是選擇性的，如果服務所有工作都只直接進行，以回應使用者呼叫，則它不需要實作 RunAsync()。

當服務正在關閉 (無論是刪除、升級，或只是要從特定位置移出) 時，呼叫順序相同，會先對通訊接聽程式呼叫 CloseAsync()，然後會取消傳遞給 RunAsync() 的取消語彙基元。

## 範例服務

了解這個程式設計模型之後，讓我們來快速看看兩個不同的服務，了解這些部分如何彼此搭配運作。

### 無狀態的可靠的服務

無狀態服務是服務內實際上沒有維護狀態的服務，或是存在的狀態是完全可處置，而且不需要同步處理、複寫、持續性或高可用性。

例如，假設沒有記憶體的計算機，它會接收所有項並同時執行作業。

在此情況下，服務的 RunAsync() 可以是空的，因為沒有服務需要進行的背景工作處理。 建立計算機服務時，它就會傳回 ICommunicationListener (例如 [Web API](service-fabric-reliable-services-communication-webapi.md)) 如此即會開啟接聽端點上某個連接埠。 此接聽端點將會連結到不同的方法 (例如："Add(n1, n2)")，其會定義計算機的公用 API。

從用戶端進行呼叫時，會叫用適當的方法，且計算機服務會在所提供的資料上執行作業，並傳回結果。 它不會儲存任何狀態。

不儲存任何內部狀態，讓此範例中的計算機變得很簡單。 不過大多數服務並不是真正無狀態；相反地，它們是將狀態外部化到某些存放區 (例如，任何依賴在備份存放區或快取中保留工作階段狀態的 Web 應用程式便不是完全無狀態)。

Service Fabric 中常見的無狀態服務使用範例是做為前端，其公開 Web 應用程式的公用 API。 前端服務接著和具狀態服務交談，以完成使用者的要求。 在此情況下，用戶端的呼叫會導向至無狀態服務接聽的已知連接埠 (例如 80)。 這個無狀態服務收到呼叫，並判斷呼叫是否來自受信任的合作對象，以及其預定為哪些服務。 然後，無狀態服務將呼叫轉送至正確的具狀態服務分割，並等候回應。 當它收到回應時，它會回覆原始用戶端。

### 具狀態可靠的服務

具狀態服務必須有某部分的狀態保持一致且存在，服務才能運作。 假設有一個服務不斷地根據某個值收到的更新，計算它的滾動平均。 若要這樣做，它必須擁有目前需要處理的連入要求集，以及目前的平均。 擷取、處理並將資訊儲存在外部存放區 (例如現在的 Azure Blob 或資料表存放區) 的任何服務都是具狀態，它只將狀態保留在外部狀態存放區中。

現在的大部分服務會在外部儲存其狀態，因為外部存放區為該狀態提供可靠性、可用性、延展性和一致性。 在 Service Fabric 中，具狀態服務不需要外部儲存其狀態，因為 Service Fabric 會為服務程式碼和服務狀態處理這些需求。

例如，假設我們想要撰寫的服務接受一系列需要在影像上執行的轉換，以及要轉換的影像。這項服務，它會傳回通訊接聽程式 (假設是 WebAPI) 這會開啟通訊連接埠，並允許透過 API 送出像是 `ConvertImage (影像 i IList < 轉換 > 轉換)`。在這個 API 中，服務可能擷取資訊並將要求儲存在 ReliableQueue，然後傳回某個語彙基元給用戶端，以便追蹤要求 (因為要求可能需要一些時間)。

在這個服務中，RunAsync 可能會更複雜：服務在其 RunAsync 內會有一個迴圈，將要求從 IReliableQueue 提取出來、執行列出的轉換，然後將結果儲存在 IReliableDictionary，以便當用戶端回來時可以取得轉換後的影像。 為了確保即使某個項目失敗影像也不會遺失，這個可靠的服務會從佇列提取、執行轉換，然後將結果儲存在交易中，使得只有在轉換完成時，訊息才會實際從佇列移除，並且將結果儲存在結果字典中。 如果中途某個項目失敗 (例如此程式碼執行個體執行所在的電腦)，要求會保留在佇列中等候再次處理。

關於這個服務，要注意一件事，就是它聽起來像是一般的 .NET 服務； 唯一的差別在於使用的資料結構 (IReliableQueue 和 IReliableDictionary) 是由 Service Fabric 提供，因此高度可靠、可用且一致。

## 使用可靠的服務 API 的時機

如果下列任何一項描述您的應用程式服務需求，那麼便應該考慮可靠的服務 API：

- 您需要提供跨越多個狀態單位 (例如訂單和訂單行項目) 的應用程式行為

- 您的應用程式狀態可以自然地模型化，做為可靠的字典和佇列

- 您的狀態必須是高度可用且低延遲存取

- 您的應用程式必須跨越一個或多個可靠的集合，控制交易作業的並行處理或資料粒度

- 您想要管理通訊或控制服務的資料分割配置

- 您的程式碼需要無限制執行緒的執行階段環境

- 您的應用程式需要在執行階段以動態方式建立或終結可靠字典或佇列

- 您需要以程式設計方式為您的服務狀態控制 Service Fabric 提供的備份和還原功能*

- 您的應用程式需要維護其狀態單位的變更歷程記錄*

- 您想要開發或使用協力廠商開發的自訂狀態提供者*

> [AZURE.NOTE] *公開上市版 SDK 將提供這些功能


## 後續步驟

+ [可靠的服務快速入門](service-fabric-reliable-services-quick-start.md)
+ [查看可靠的服務進階用法](service-fabric-reliable-services-advanced-usage.md)
+ [閱讀可靠執行者程式設計模型](service-fabric-reliable-actors-introduction.md)






